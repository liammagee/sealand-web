function Catastrophe(a,b,c,d,e){this.kind=a,this.start=b||0,this.duration=c||150,this.effect=d||.5,this.notice=e||new Notice("A catastrophe is taking place!",undefined,undefined,this.start,this.duration),this.struck=!1}function Memory(a,b,c,d){this.agentID=a,this.age=b,this.mostRecentVisit=b,this.visits=1,this.x=c,this.y=d,this.distanceFromLastUntriedPath=-1}function MemoryOfAgent(a,b,c,d,e){this.agentID=a,this.age=b,this.x=c,this.y=d,this.visits=1,this.otherAgentID=e,this.distanceFromLastUntriedPath=-1}function Agent(a,b,c){this.id=function(){return Math.floor(Math.random()*Math.pow(10,10))}(),this.makeHealthAdjustment=function(a,b){var c=a+b;return c>0&&c<this.culture.initialHealth?c:c>0?this.culture.initialHealth:0},this.recalibrateOverallHealth=function(){var a=0,b=this.culture.healthCategories.length,c=!1;for(var d=0;d<b;d++){var e=this.culture.healthCategories[d],f=this.healthCategoryStats[e.code];f==0&&(c=!0),a+=f}a=c?0:a/b,this.health=a},this.update=function(a){this.culture.updateFunction&&this.culture.updateFunction(this,a)},this.currentCapabilities=function(a){var b=[],c=this;return this.culture.capabilities.forEach(function(d){var e=d.getCapabilities(c,a),d=e.capability,f=e.arguments;f.forEach(function(a){var c={capability:d};c.arguments=a,b.push(c)})}),b},this.reviseBeliefs=function(a){var b=this;this.culture.beliefs.forEach(function(c){!_.isUndefined(c)&&!_.isUndefined(c.makeBelief)&&c.makeBelief(b,a)})},this.getPosition=function(){return[this.x,this.y]},this.moveTo=function(a,b){var c=this.x,d=this.y;this.lastMemory={x:c,y:d},this.x=a,this.y=b,this.incrementMoves(),this.adjustGeneralHealth(this.culture.moveCost),Lifecycle.currentWorld.changeAgentInCell(this,c,d)},this.registerHealthStats=function(){for(var a=0;a<this.culture.healthCategories.length;a++){var b=this.culture.healthCategories[a];this.healthCategoryStats[b.code]=this.culture.initialHealth}this.healthCategoryStats.length=this.culture.healthCategories.length},this.adjustGeneralHealth=function(a){var b=this.culture.healthCategories.length;for(var c=0;c<b;c++){var d=this.culture.healthCategories[c],e=this.healthCategoryStats[d.code];this.healthCategoryStats[d.code]=this.makeHealthAdjustment(e,a)}this.recalibrateOverallHealth()},this.adjustHealthForResource=function(a,b){this.adjustHealthForResourceCategory(a,b.category)},this.adjustHealthForResourceCategory=function(a,b){var c=b.code,d=this.healthCategoryStats[c];this.healthCategoryStats[c]=this.makeHealthAdjustment(d,a),this.recalibrateOverallHealth()},this.getHealthForResource=function(a){return this.getHealthForResourceCategory(a.category)},this.getHealthForResourceCategory=function(a){var b=a.code,c=this.healthCategoryStats[b];return c},this.adjustWander=function(a,b){var c=this.wanderX,d=this.wanderY,e=a/2-b/2,f=Math.floor(Math.random()*3-1),g=Math.floor(Math.random()*3-1);c=c+f,d=d+g,e-Math.abs(c)>=0&&(this.wanderX=c),e-Math.abs(d)>=0&&(this.wanderY=d)},this.incrementCountdownToMove=function(){this.countdownToMove++},this.resetCountdownToMove=function(){this.countdownToMove=0},this.readyToMove=function(){return this.countdownToMove==0},this.incrementMoves=function(){this.age++},this.adjustSpeed=function(){var a=this.speed,b=this.speed-this.culture.initialSpeed,c=0;switch(ProbabilityFlags.PROBABILITY_STRATEGY_TO_DEVIATE){case ProbabilityFlags.VERY_UNLIKELY:c=Math.pow(Math.abs(b),Math.abs(b))+2;break;case ProbabilityFlags.UNLIKELY:c=Math.pow(Math.abs(b)+1,2)+2;break;case ProbabilityFlags.MODERATELY_LIKELY:c=Math.abs(b)+2;break;case ProbabilityFlags.EVEN_CHANCE:c=3}var d=Math.floor(Math.random()*c)-1,e=Math.pow(Math.abs(b),.5)+.5|0;e=e==0?1:e;var f=d<0?-e:d>0?e:0;f=b>0?-f:f;var g=1;a=this.speed+f*g,a>0&&(this.speed=a)},this.hasNeighbouringResources=function(a,b,c){var d=a.resources;for(var e=0,f=d.length;e<f;e++){var g=d[e],h=g.x,i=g.y;if(Math.abs(h-b)<=1&&Math.abs(i-c)<=1)return g}return null},this.wipeMemory=function(){this.chronologicalMemory=[],this.memoriesOfPlacesVisited=[],this.memoriesOfPathsUntried=[],this.memoriesOfPlacesVisitedByOtherAgents=[],this.memoriesOfPathsUntriedByOtherAgents=[],this.memoriesOfResources=[],this.memoriesOfAgents=[],this.lastUntriedPathMemory=null},this.developPlan=function(a){var b=this,c=Desires.rankDesires(b,a);if(c&&c.length>0)for(var d=0,e=c.length;d<e;d++){var f=c[d],g=f.findSatisfyingObjects(b);if(g.length>0){var h=Plans.getBestPlans(b,a,g),e=h.length,i=Math.floor(Math.random()*e);this.currentPlan=h[i],this.currentPlanStep=1;break}}},this.executePlan=function(a){(_.isUndefined(this.currentPlan)||this.currentPlanStep>=this.currentPlan.distance)&&this.developPlan(a);if(_.isUndefined(this.currentPlan)||this.currentPlanStep>=this.currentPlan.distance)return;var b=this.currentPlan.trail[this.currentPlanStep];this.moveTo(b[0],b[1]),this.currentPlanStep++},this.scopeOfWorld=function(){var a=this,b=Desires.rankDesires(a,world);b&&b.length>0&&b.forEach(function(a){})},this.getCell=function(){return Lifecycle.currentWorld.getCell(this.x,this.y)},this.init=function(a){for(var b in this.culture.characteristics)this.culture.characteristics.hasOwnProperty(b)&&(this[b]=this.culture.characteristics[b]);this.speed=_.isUndefined(this.culture.initialSpeed)?this.speed:this.culture.initialSpeed,this.culture.initFunction&&this.culture.initFunction(this,a)},this.save=function(a){this.destroy(a)},this.destroy=function(a){var b=-1,c=this;for(var d=0;d<a.currentAgents.length;d++){var e=a.currentAgents[d];if(e==c){b=d;break}}b>-1&&(a.currentAgents.splice(b,1),a.removeAgentFromCell(c))},this.die=this.destroy,this.spawn=function(a){var b=_.clone(this);return b.delay=parseInt(Math.random()*b.culture.initialSpeed*5),b.bornAt=Lifecycle.worldCounter,b.age=0,b.parents=[this],b.registerHealthStats(),a&&b.parents.push(a),Lifecycle.currentWorld.currentAgents.push(b),Lifecycle.currentWorld.addAgentToCell(b),b},this.culture=a,this.color=a.color,this.x=b,this.y=c,this.coordX=0,this.coordY=0,this.characteristics={},this.beliefs=[],this.desires=[],this.capabilities=[],this.age=0,this.bornAt=0,this.diedAt=0,this.savedAt=0,this.alive=!0,this.delay=0,this.speed=this.culture.initialSpeed,this.countdownToMove=0,this.wanderX=0,this.wanderY=0,this.health=this.culture.initialHealth,this.healthCategoryStats={},this.lastMemory=new Memory(this.id,this.age,b,c),this.lastUntriedPathMemory=null,this.chronologicalMemory=[],this.memoriesOfPlacesVisited=[],this.memoriesOfPathsUntried=[],this.memoriesOfResources={},this.memoriesOfAgents=[],this.memoriesOfPlacesVisitedByOtherAgents=[],this.memoriesOfPathsUntriedByOtherAgents=[],this.currentPlan,this.currentPlanStep,this.needToRevisePlan,this.gender=0,this.children=[],this.parents=[],this.currentPartner=[],this.registerHealthStats(),this.reviseBeliefs(undefined),this.init()}function SimpleAgent(a,b,c,d,e,f,g,h,i,j,k,l){this.culture=a,this.x=b,this.y=c,this.color=d,this.health=f,this.speed=CultureDefaults.DEFAULT_INITIAL_SPEED,this.wanderX=g,this.wanderY=h,this.lastMemory=new Memory(0,0,b,c),this.delay=0,this.countdownToMove=0,this.healthCategoryStats=l,this.age=0,this.bornAt=0,this.diedAt=0,this.alive=!0,this.reviseBeliefs=function(){},this.incrementCountdownToMove=function(){this.countdownToMove++},this.resetCountdownToMove=function(){this.countdownToMove=0},this.executePlan=function(a){},this.init=function(b){for(var c in a.characteristics)a.characteristics.hasOwnProperty(c)&&(this[c]=a.characteristics[c]);this.culture.initFunction&&this.culture.initFunction(this,b)},this.update=function(a){this.culture.updateFunction&&this.culture.updateFunction(this,a)},this.init()}function Culture(a,b,c,d,e,f,g,h){this.name=a,this.color=b,this.initialSpeed=d||CultureDefaults.DEFAULT_INITIAL_SPEED,this.initialHealth=e||CultureDefaults.DEFAULT_INITIAL_HEALTH,this.moveCost=CultureDefaults.DEFAULT_MOVE_COST,this.healthCategories=c||[],this.generateEachWave=!0,this.characteristics={},this.beliefs=[],this.desires=[],this.capabilities=[],this.drawFunction=f||function(){},this.initFunction=g||function(){},this.defaultUpdateFunction=function(a,b){a.executePlan(b),this.capabilities.forEach(function(c){c.exercise(a,b),_.isUndefined(c.cost)||a.adjustGeneralHealth(c.cost)})},this.updateFunction=this.updateFunction||this.defaultUpdateFunction}function Belief(){this.time,this.x,this.y,this.source,this.object,this.exercise=function(a,b){}}function Capability(){this.cost=0,this.probability=1,this.exercise=function(a,b){}}function Campaign(){}function Cell(a,b){this.x=a,this.y=b,this.agents=[],this.resources=[],this.terrain=Terrain.DEFAULT_TERRAIN,this.agentsAllowed=!0,this.resourcesAllowed=!1,this.isEntryPoint=!1,this.isExitPoint=!1}function World(){this.initWorld=function(){this.setCurrentAgents([]),this.expiredAgents=[],this.initialiseCells(),this.generatePath(),this.waves=undefined,this.resetResources(),this.catastrophe!=undefined&&(this.catastrophe.struck=!1),this.setup&&this.setup(),this.initialiseWaves(this.waveNumber)},this.areAgentsAllowed=function(a,b){var c=this;return c.getCell(a,b).agentsAllowed},this.allowAgentsOnCellPositions=function(a){var b=this,c=_.compact(a);c.forEach(function(a){var c=b.getCell(a.x,a.y);_.isUndefined(c)||(c.agentsAllowed=!1)}),this.generatePath()},this.forbidAgentOnCell=function(a,b){var c=this.getCell(a,b);_.isUndefined(c)||(c.agentsAllowed=!1,c.isEntryPoint=!1,c.isExitPoint=!1)},this.forbidAgentsOnAllCells=function(){this.cells.forEach(function(a){a.agentsAllowed=!1}),this.generatePath()},this.allowAgentsOnAllCells=function(){this.cells.forEach(function(a){a.agentsAllowed=!0}),this.generatePath()},this.allowAgentsOnCellRange=function(a,b){for(var c=a;c<a+b;c++){var d=this.cells[c];d.agentsAllowed=!0}this.generatePath()},this.forbidAgentsOnCellRange=function(a,b){for(var c=a;c<a+b;c++){var d=this.cells[c];d.agentsAllowed=!1}this.generatePath()},this.generatePath=function(){var a=[];return this.cells.forEach(function(b){b.agentsAllowed&&a.push([b.x,b.y])}),this.pathway=a,a},this.isInPath=function(a,b){for(var c=0;c<this.pathway.length;c++){var d=this.pathway[c];if(d[0]==a&&d[1]==b)return c}return-1},this.removeFromPath=function(a,b){this.getCell(a,b).agentsAllowed&&this.pathway.splice(index,1)},this.addTerrainToPath=function(a){this.cells.forEach(function(b){b.agentsAllowed&&(b.terrain=a)})},this.addTerrainToBackground=function(a){this.backgroundTerrain=a},this.indexify=function(a,b){return b*this.cellsAcross+a},this.deindexify=function(a){return[a%this.cellsAcross,Math.floor(a/this.cellsAcross)]},this.getCell=function(a,b){return this.cells[this.indexify(a,b)]},this.initialiseCells=function(){for(var a=0;a<this.cellsAcross;a++)for(var b=0;b<this.cellsDown;b++)this.cells[this.indexify(a,b)]=new Cell(a,b);this.updateCells()},this.addCellAtPoint=function(a,b){this.cells[this.indexify(a,b)]=new Cell(a,b)},this.updateCells=function(){var a,b,c,d;for(a=0;a<this.resources.length;a++){var e=this.resources[a];b=e.x,c=e.y,d=this.cells[this.indexify(b,c)],_.isUndefined(d)||d.resources.push(e)}for(var a=0;a<this.currentAgents.length;a++){var f=this.currentAgents[a];b=f.x,c=f.y,d=this.cells[this.indexify(b,c)],_.isUndefined(d)||d.agents.push(f)}},this.addAgentToCell=function(a){var b=a.x,c=a.y,d=this.cells[this.indexify(b,c)];_.isUndefined(d)||d.agents.push(a)},this.removeAgentFromCell=function(a){var b=a.x,c=a.y,d=this.getCell(b,c),e=_.indexOf(d.agents,a);_.isUndefined(d)||d.agents.splice(e,1)},this.changeAgentInCell=function(a,b,c){var d=a.x,e=a.y;if(!_.isUndefined(b)&&!_.isUndefined(c)){var f=this.getCell(b,c),g=_.indexOf(f.agents,a);_.isUndefined(f)||f.agents.splice(g,1)}this.addAgentToCell(a)},this.removeAllAgentsFromCells=function(){this.cells.forEach(function(a){a.agents=[]})},this.getAgentsAtCell=function(a,b){return this.cells[this.indexify(a,b)].agents},this.getFirstAgentAtCell=function(a,b){var c=this.getAgentsAtCell(a,b);return c&&c.length>0?c[0]:void 0},this.addEntryPoint=function(a,b){var c=this.getCell(a,b);_.isUndefined(c)||(c.isEntryPoint=!0)},this.getEntryPoints=function(){return _.compact(_.map(this.cells,function(a){if(a.isEntryPoint)return a}))},this.resetEntryPoints=function(){this.cells.forEach(function(a){a.isEntryPoint=!1})},this.removeEntryPoint=function(a,b){this.getCell(a,b).isEntryPoint=!1},this.isExitPoint=function(a,b){return this.getCell(a,b).isExitPoint},this.addExitPoint=function(a,b){var c=this.getCell(a,b);_.isUndefined(c)||(c.isExitPoint=!0)},this.resetExitPoints=function(){this.cells.forEach(function(a){a.isExitPoint=!1})},this.removeExitPoint=function(a,b){this.getCell(a,b).isExitPoint=!1},this.getExitPoints=function(){return _.compact(_.map(this.cells,function(a){if(a.isExitPoint)return a}))},this.isEntryOrExitPoint=function(a,b){var c=this.getCell(a,b);return _.isUndefined(c)?!1:c.isEntryPoint||c.isExitPoint},this.getCurrentAgents=function(){return typeof _=="undefined"||_.isUndefined(this.currentAgentsFunction)?this.currentAgents:_.filter(this.currentAgents,this.currentAgentsFunction)},this.setCurrentAgents=function(a){this.currentAgents=a;for(var b=0;b<this.currentAgents.length;b++){var c=this.currentAgents[b];this.currentAgentsMap[[c.x,c.y]]=c,this.addAgentToCell(c)}},this.addExpiredAgent=function(a,b){a.alive=!1,a.diedAt=b,this.expiredAgents.push(a)},this.addSavedAgent=function(a,b){a.alive=!1,a.savedAt=b,a.diedAt=b,this.savedAgents.push(a);var c=this.currentWaveNumber<5?4:this.currentWaveNumber<10?3:this.currentWaveNumber<20?2:1;this.currentResourceStore+=c},this.generateAgents=function(a,b){var c=[],d=this;if(this.randomiseAgents){var e=this.cells.length;for(var f=0;f<b;f++){var g=!1;while(!g){var h=Math.floor(Math.random()*e),i=this.cells[h];if(i.agents==0&&i.agentsAllowed){var j=this.getMooreNeighbourhood(i.x,i.y,!1),k=0,l=d.generateAgentAtPoint(a,i.x,i.y);c.push(l),g=!0}}}}else if(this.placeAgentsOnAllCells)for(var f=0,e=this.pathway.length;f<e;f++){var m=this.pathway[f],l=this.generateAgentAtPoint(a,m[0],m[1]);c.push(l)}else{var n=this.getEntryPoints();for(var o=0;o<n.length;o++){var p=n[o],q=p.x,r=p.y;for(var f=0;f<b;f++){var l=this.generateAgentAtPoint(a,q,r,o);c.push(l)}}}return this.setCurrentAgents(c),c},this.generateAgentAtPoint=function(a,b,c,d){var e=new Agent(a,b,c),f=d%3,g=f==0?"000":f==1?"0f0":"00f";e.delay=parseInt(Math.random()*e.culture.initialSpeed*5),e.bornAt=Lifecycle.worldCounter;if(Universe.settings.agentsHaveRandomInitialHealth){var h=ModuleManager.currentModule.resourceSet.categories.length,i=Math.floor(Math.random()*h),j=ModuleManager.currentModule.resourceSet.categories[i],k=-50,l=Math.ceil(Math.random()*k);e.adjustHealthForResourceCategory(l,j)}return e},this.getTotalSaveableAgents=function(){var a=this.initialAgentNumber,b=this.waveNumber+this.initialAgentNumber-1,c=a*(a-1)/2,d=b*(b+1)/2,e=d-c,f=e*this.getEntryPoints().length;return f},this.currentAgentHealthStats=function(){var a={},b=ModuleManager.currentModule.resourceSet;if(!_.isUndefined(b)){for(var c=0,d=b.categories.length;c<d;c++)a[b.categories[c].code]=0;a.total=0;for(var c=0,d=this.currentAgents.length;c<d;c++){var e=this.currentAgents[c];if(!_.isUndefined(e.culture.healthCategories))for(var f=0;f<e.culture.healthCategories.length;f++){var g=e.getHealthForResourceCategory(e.culture.healthCategories[f]);a[e.culture.healthCategories[f].code]+=g}a.total+=e.health}for(var c=0,d=b.categories.length;c<d;c++)a[b.categories[c].code]/=this.currentAgents.length;a.total+=this.currentAgents.length}return a},this.addResourceToCell=function(a){var b=a.x,c=a.y,d=this.cells[this.indexify(b,c)];_.isUndefined(d)||d.resources.push(a)},this.removeResourceFromCell=function(a){var b=a.x,c=a.y,d=this.getCell(b,c),e=_.indexOf(d.resources,a);_.isUndefined(d)||d.resources.splice(e,1)},this.removeAllResourcesFromCells=function(){this.cells.forEach(function(a){a.resources=[]})},this.getResourcesAtCell=function(a,b){return this.cells[this.indexify(a,b)].resources},this.resetResources=function(){this.currentResourceStore=this.initialResourceStore,this.currentResourceSpent=0,this.resources=[],this.worldResources=this.worldResources||[],this.removeAllResourcesFromCells();for(var a=0;a<this.worldResources.length;a++)this.resources.push(this.worldResources[a]),this.addResourceToCell(this.worldResources[a]);this.resourceCategoryCounts=this.resetResourceCategoryCounts()},this.setResources=function(a){this.resetResources();var b=this;a.forEach(function(a){b.addResource(a)}),this.resourceCategoryCounts=this.resetResourceCategoryCounts()},this.isPositionOccupiedByResource=function(a,b){return this.getCell(a,b).resources.length>0},this.addResource=function(a){this.resources.push(a),this.addResourceToCell(a),this.resourceCategoryCounts[a.category.code]+=1,this.currentResourceStore-=a.cost,this.currentResourceSpent+=a.cost},this.addResourceRandomly=function(a){var b=!1,c=this.cells.length;for(var d=0;d<c;d++){var e=Math.floor(Math.random()*this.cellsAcross),f=Math.floor(Math.random()*this.cellsDown),g=this.getCell(e,f);if(g.resources.length==0&&g.resourcesAllowed){this.addResource(new Resource(a,e,f));break}}},this.removeResource=function(a){var b=this.getCurrentResourceIndex(a);b>-1&&(this.resources.splice(b,1),this.removeResourceFromCell(a),this.resourceCategoryCounts[a.category.code]-=1)},this.removeResourceByPosition=function(a,b){var c=this.getResourceIndexAtPosition(a,b);if(c>-1){var d=this.resources[c];this.resources.splice(c,1),this.removeResourceFromCell(d),this.resourceCategoryCounts[d.category.code]-=1}},this.generateWorldResources=function(){if(this.randomiseResources&&this.initialResourceNumber>0){this.worldResources=[];for(var a=0;a<this.initialResourceNumber;a++){var b=Math.floor(Math.random()*this.cellsAcross),c=Math.floor(Math.random()*this.cellsDown),d=ModuleManager.currentModule.resourceSet.types,e=d[Math.floor(Math.random()*d.length)];this.worldResources.push(new Resource(e,b,c))}}this.resetResources()},this.removeWorldResources=function(){this.worldResources=[],this.resetResources()},this.resetResourceCategoryCounts=function(){if(_.isUndefined(ModuleManager.currentModule.resourceSet))return;var a={};return ModuleManager.currentModule.resourceSet.categories.forEach(function(b){a[b.code]=0}),this.resources.forEach(function(b){a[b.category.code]+=1}),this.resourceCategoryCounts=a,a},this.getResourceCategoryProportion=function(a){var b=this.resourceCategoryCounts,c=this.resources.length;return b/c},this.getCurrentResourceIndex=function(a){for(var b=0;b<this.resources.length;b++){var c=this.resources[b];if(c==a)return b}return-1},this.getResourceIndexAtPosition=function(a,b){for(var c=0;c<this.resources.length;c++){var d=this.resources[c];if(d.x==a&&d.y==b)return c}return-1},this.calculateResourceEffect=function(a,b,c){if(b||Universe.settings.ignoreResourceBalance||Universe.settings.applyGeneralHealth||this.resources.length<=1)return 1;var d=a.category.code,e=this.resources.length,f=this.resourceCategoryCounts[d],g=f/e*e,h=g<=1?g:(e-g)/(e-1),i=h*h;if(c||Universe.settings.resourcesInTension)i*=this.calculateSurroundingResourcesEffects(a);return i},this.calculateSurroundingResourcesEffects=function(a){var b=a.x,c=a.y,d=a.category,e=1;for(var f=0,g=this.resources.length;f<g;f++){var h=this.resources[f],i=h.x,j=h.y;if(i==b&&j==c)continue;if(Universe.settings.resourcesInTensionGlobally||Math.abs(i-b)<=1&&Math.abs(j-c)<=1){var k=h.category;e*=d.doEvaluateOtherCategoryImpact(k)}}return e},this.resetResourceYields=function(){this.resources.forEach(function(a){a.totalYield=a.initialTotalYield})},this.recoverResources=function(){var a=[];return this.resources.forEach(function(b){b.totalYield<b.initialTotalYield&&(b.incrementTotalYield(),a.push(b))}),a},this.resourceStats=function(){var a=0,b=[];ModuleManager.currentModule.resourceSet.categories.forEach(function(a){b.push(0)}),this.resources.forEach(function(a){for(var c=0;c<ModuleManager.currentModule.resourceSet.categories.length;c++){var d=ModuleManager.currentModule.resourceSet.categories[c];a.category==d&&(b[c]=b[c]+1)}});var c=b.length,d=jStat.min(b),e=jStat.max(b),f=jStat.sum(b),g=jStat.range(b),h=jStat.stdev(b),i=jStat.coeffvar(b),j=i>1?1:i;return{array:b,len:c,min:d,max:e,sum:f,range:g,stdev:h,coeffvar:i,cappedCoeffvar:j}},this.initialiseWaves=function(a){if(_.isUndefined(this.waves)||this.waves.length==0){this.waves=[];for(var b=0;b<a;b++){var c=new Wave;c.agents=[];var d=this.cultures||ModuleManager.currentModule.allCultures();for(var e=0,f=d.length;e<f;e++){var g=d[e];if(g.generateEachWave&&this.generateWaveAgentsAutomatically){var h=g.waveNumber?g.waveNumber:this.initialAgentNumber;if(this.distributeAgentsNormally){var i=this.distributeAgentsSigma;i==undefined&&(i=0),h=jStat.normal.sample(h,i)}this.incrementAgentsEachWave&&(h+=this.incrementAgentsEachWave*b);var j=this.generateAgents(g,h);c.agents=_.union(c.agents,j)}}this.waves.push(c)}}},this.pointDistance=function(a,b,c,d){return Math.abs(c-a)+Math.abs(d-b)},this.meanDistance=function(a,b){var c=a[0],d=a[1],e=b[0],f=b[1];return Math.abs(e-c)+Math.abs(f-d)},this.isSameCell=function(a,b){return a&&b&&a[0]==b[0]&&a[1]==b[1]},this.isInHistory=function(a,b){for(var c=0,d=b.length;c<d;c++){var e=b[c];if(this.isSameCell(a,e))return!0}return!1},this.getDirections=function(a,b){var c=a[0],d=a[1],e=b[0],f=b[1],g=e-c,h=f-d,i=[];return Math.abs(g)<Math.abs(h)?g<0?i=h<0?[2,3,1,0]:[2,1,3,0]:i=h<0?[0,3,1,2]:[0,1,3,2]:h<0?i=g<0?[3,2,0,1]:[3,0,2,1]:i=g<0?[1,2,0,3]:[1,0,2,3],i},this.getVonNeumannNeighbourhood=function(a,b,c){return _.map(this.getCellsAtDistance(a,b,1,Distance.TAXICAB_DISTANCE,c),function(a){return{x:a.x,y:a.y}})},this.getMooreNeighbourhood=function(a,b,c){return _.map(this.getCellsAtDistance(a,b,1,Distance.CHEBYSHEV_DISTANCE,c),function(a){return{x:a.x,y:a.y}})},this.getMvNNeighbourhood=function(a,b,c){return _.map(this.getCellsAtDistance(a,b,2,Distance.TAXICAB_DISTANCE,c),function(a){return{x:a.x,y:a.y}})},this.getHNeighbourhood=function(a,b,c){return this.getMaskedNeighbourhood(a,b,c,[3,7])},this.getInverseVonNeumannNeighbourhood=function(a,b,c){return this.getMaskedNeighbourhood(a,b,c,[1,3,5,7])},this.getMaskedNeighbourhood=function(a,b,c,d){var e=this.getMooreNeighbourhood(a,b,c),f=d;return _.isUndefined(d)||(f=d.sort(function(a,b){return a<b?1:a>b?-1:0})),f.forEach(function(a){c&&(a+=1),a>=0&&a<e.length&&e.splice(a,1)}),e},this.getCellsAtDistance=function(a,b,c,d,e){var f=[],d=d||Distance.CHEBYSHEV_DISTANCE,e=e||!1,g=a-c,h=b-c,i=a+c,j=b+c;for(var k=g;k<=i;k++)for(var l=h;l<=j;l++){if(k==a&&l==b&&!e)continue;var m=k,n=l;if(this.allowOffscreenCycling)k<0?m+=this.cellsAcross:k>this.cellsAcross-1&&(m-=this.cellsAcross),l<0?n+=this.cellsDown:l>this.cellsDown-1&&(n-=this.cellsDown);else{if(k<0||k>this.cellsAcross-1)continue;if(l<0||l>this.cellsDown-1)continue}var o=this.getCell(m,n);if(!_.isUndefined(o))switch(d){case Distance.CHEBYSHEV_DISTANCE:f.push(o);break;case Distance.MINKOWSKI_DISTANCE:var p=Math.sqrt(Math.pow(k-a,2)+Math.pow(l-b,2));p<=c&&f.push(o);break;case Distance.TAXICAB_DISTANCE:var q=Math.abs(k-a)+Math.abs(l-b);q<=c&&f.push(o)}}return f},this.getAgentsAtDistance=function(a,b,c,d,e){var f=this.getCellsAtDistance(a,b,c,d,e);return _.compact(_.flatten(_.map(f,function(a){return a.agents})))},this.getResourcesAtDistance=function(a,b,c,d,e){var f=this.getCellsAtDistance(a,b,c,d,e);return _.compact(_.flatten(_.map(f,function(a){return a.resources})))},this.getNeighbouringCells=function(a,b){return this.getCellsAtDistance(a,b,1,Distance.CHEBYSHEV_DISTANCE,!0)},this.getNeighbouringResources=function(a,b){return this.getResourcesAtDistance(a,b,1,Distance.CHEBYSHEV_DISTANCE,!0)},this.getNeighbouringAgents=function(a,b){return this.getAgentsAtDistance(a,b,1,Distance.CHEBYSHEV_DISTANCE,!0)},this.randomiseAgentCollection=function(){return _.shuffle(this.currentAgents)},this.randomiseCellCollection=function(){return _.shuffle(this.cells)},this.id=1,this.name=undefined,this.cellsAcross=10,this.cellsDown=10,this.cells=[],this.isPresetWorld=!1,this.isTerminalWorld=!1,this.customWorld=!1,this.entryPoints=[],this.exitPoints=[],this.initialAgentNumber=1,this.waveNumber=1,this.expiryLimit=1,this.waves=[],this.initialResourceStore=100,this.currentResourceStore=100,this.initialResourceNumber=0,this.currentResourceSpent=0,this.allowOffscreenCycling=!1,this.resourcesOwnTilesExclusively=!1,this.allowResourcesOnPath=!1,this.isometricView=!1,this.noWander=!1,this.noSpeedChange=!1,this.noSpeedChangeOnResources=!1,this.randomiseAgents=!1,this.placeAgentsOnAllCells=!1,this.randomiseResources=!1,this.generateWaveAgentsAutomatically=!0,this.incrementAgentsEachWave=!0,this.generateWaveAgentsAutomatically=!0,this.distributeAgentsNormally=!1,this.distributeAgentsSigma=0,this.distributeAgentsHealthNormally=!1,this.distributeAgentsHealthSigma=0,this.cultures=undefined,this.currentAgents=[],this.currentAgentsMap={},this.currentAgentsFunction=function(a){return a},this.expiredAgents=[],this.savedAgents=[],this.worldResources=[],this.resources=[],this.resourceCategoryCounts=[],this.tip=null,this.catastrophe=null,this.introduction="Welcome to world "+this.id+".",this.information="",this.conclusion="Congratulations! You have completed world "+this.id+".",this.backgroundTerrain=null,this.mapOptions=null,this.mapURL=null,this.noMap=!1,this.thumbnail=undefined,this.image=null,this.imageAttribution=null,this.soundSrc=null}function Wave(){}function ResourceCategory(a,b,c){this.name=a,this.code=b,this.color=c,this.types=[],this.evaluateOtherCategoryImpact=function(a){return 1}}function ResourceType(a,b,c,d,e,f,g){this.name=a,this.code=b,this.image=c,this.cost=d,this.upgradeCost=e,this.totalYield=f,this.perAgentYield=g,typeof Image!="undefined"&&(this.actualImage=new Image,this.actualImage.src=c)}function Resource(a,b,c){this.setInitialTotalYield=function(a){this.initialTotalYield=a,this.totalYield=a},this.incrementTotalYield=function(a){this.totalYield++},this.getPosition=function(){return[this.x,this.y]},this.moveTo=function(a,b){this.x=a,this.y=b},this.calculateEffect=function(a){},this.provideYield=function(a,b,c){if(this.totalYield>this.perAgentYield){var d=0;if(Universe.settings.applyGeneralHealth)a.health<100&&(d=this.perAgentYield*this.upgradeWorld*b,a.adjustGeneralHealth(d),c&&Universe.settings.agentsCanAdjustSpeed&&a.speed<a.culture.initialSpeed*3&&(a.speed=Math.floor(a.speed*(1+this.perAgentYield/100))),this.totalYield-=this.perAgentYield);else if(a.getHealthForResource(this)<100){var e=this.perAgentYield*this.upgradeWorld*ModuleManager.currentModule.resourceSet.categories.length;d=e*b,a.adjustHealthForResource(d,this),c&&Universe.settings.agentsCanAdjustSpeed&&a.speed<a.culture.initialSpeed*3&&(a.speed=Math.floor(a.speed*(1+this.perAgentYield/100))),Universe.settings.resourcesDiminishAtFixedRate?this.totalYield-=e:this.totalYield-=this.perAgentYield}}},this.category=a.category,this.color=a.category.color,this.kind=a,this.resourceName=a.code,this.initialTotalYield=a.totalYield,this.perAgentYield=a.perAgentYield,this.cost=a.cost,this.upgradeCost=a.upgradeCost,this.totalYield=a.totalYield,this.upgradeWorld=1,this.moveTo(b,c)}function Terrain(a){_.isUndefined(a.cssa)?this.color=a||DEFAULT_TERRAIN_COLOR:this.color=a.cssa()}function Tile(a,b,c){this.color=a||DEFAULT_TILE_COLOR,this.x=b||0,this.y=c||0,this.terrain=Terrain.DEFAULT_TERRAIN}function Module(){this.registerSelf=function(){ModuleManager.registerModule(this)},this.registerCampaign=function(a){this.campaigns=this.campaigns||{},typeof a!="undefined"&&a.id&&(this.campaigns[a.id]=a)},this.getCampaign=function(a){return this.campaigns[a]},this.allCampaigns=function(){var a=[];for(var b in this.campaigns)this.campaigns.hasOwnProperty(b)&&a.push(this.campaigns[b]);return a.sort(function(a,b){return!a.position||!b.position?0:a.position>b.position?-1:a.position<b.position?1:0})},this.getWorld=function(a,b){var c=this.getCampaign(a);return _.isUndefined(c)?undefined:c.worlds[b]},this.registerCulture=function(a){this.cultures=this.cultures||[],this.cultures.push(a)},this.allCultures=function(){return this.cultures},this.registerResourceSet=function(a){typeof a!="undefined"&&a.id&&(a.doSetup&&a.doSetup(),this.resourceSet=a)},this.resolveResourceType=function(a){for(var b=0,c=this.resourceSet.types.length;b<c;b++){var d=this.resourceSet.types[b];if(d.code==a)return d}return undefined},this.id,this.campaigns={},this.resourceSet,this.cultures=[]}function Profile(){this.saved=!1,this.id=-1,this.profileClass=FiercePlanet.Profile.PROFILE_CLASSES[0],this.capabilities=FiercePlanet.Profile.NOVICE_CAPABILITIES,this.progressTowardsNextClass=0,this.status="",this.credits=0,this.highestWorld=0,this.highestScore=0,this.totalWorlds=0,this.totalSaved=0,this.totalExpired=0,this.totalResourcesSpent=0,this.totalResourcesSpentByCategory={},this.aveSaved=0,this.aveExpired=0,this.aveResourcesSpent=0,this.aveResourcesSpentByCategory={},this.gameTotalWorlds=0,this.gameHighestWorld=0,this.gameScore=0,this.gameTotalSaved=0,this.gameTotalExpired=0,this.gameTotalResourcesSpent=0,this.gameTotalResourcesSpentByCategory={},this.gameAveSaved=0,this.gameAveExpired=0,this.gameAveResourcesSpent=0,this.gameAveResourcesSpentByCategory={},this.currentWorld=1,this.currentWorldIsPreset=!0,this.currentScore=0,this.currentWorldWaves=0,this.currentWorldSavedThisWave=0,this.currentWorldSaved=0,this.currentWorldExpired=0,this.currentWorldResourcesInStore=FiercePlanet.Profile.STARTING_STORE,this.currentWorldResourcesSpent=0,this.currentWorldResourcesSpentByCategory={}}function PlayerClass(a,b){this.name=a,this.savesRequired=b}function Event(a,b,c,d,e,f){this.type=a,this.source=b,this.event=c,this.time=d,this.worldContext=e,this.data=f}function EventTarget(){this.listeners={}}function Notice(a,b,c,d,e,f,g,h,i,j,k){this.text=a||"",this.start=d||Lifecycle.universeCounter,this.duration=e||150,this.x=b||0,this.y=c||0,this.width=f||NoticeDimensions.WAVE_NOTICE_WIDTH,this.height=g||NoticeDimensions.WAVE_NOTICE_HEIGHT,this.backgroundColor=h||"rgba(32, 98, 210)",this.foregroundColor=i||"rgba(255, 255, 255)",this.lineWidth=j||2,this.font=k||"500 14px/2 Unknown Font, sans-serif"}var Universe={};initUniverse=function(){this.settings={DEFAULT_AGENT_COST_PER_MOVE:-3,DEFAULT_RESOURCE_RECOVERY_RATE:2,agentsHaveRandomInitialHealth:!1,agentsCanAdjustSpeed:!0,agentsCanAdjustWander:!0,agentCostPerMove:0,ignoreResourceBalance:!1,applyGeneralHealth:!1,agentsOwnTilesExclusively:!1,resourcesOwnTilesExclusively:!1,resourcesInTension:!1,resourcesInTensionGlobally:!1,resourcesDiminishAtFixedRate:!1,resourcesUpgradeable:!1,resourceBonus:!1,rateOfResourceRecovery:0,toJSON:function a(){var a={};for(var b in this)this.hasOwnProperty(b)&&$.inArray(typeof this[b],["number","string","boolean"])>-1&&(a[b]=this[b]);return JSON.stringify(a)},parseJSON:function b(a){var b=$.parseJSON(a);for(var c in b)this[c]=b[c]},load:function(){localStorage&&localStorage.universeSettings&&this.parseJSON(localStorage.universeSettings)},store:function(a){localStorage&&(localStorage.universeSettings=this.toJSON())}},this.settings.agentCostPerMove=this.settings.DEFAULT_AGENT_COST_PER_MOVE,this.settings.rateOfResourceRecovery=this.settings.DEFAULT_RESOURCE_RECOVERY_RATE},initUniverse.apply(Universe),typeof exports!="undefined"&&(exports.Universe=Universe),Catastrophe.prototype.strike=function(){if(!this.struck){var a=Lifecycle.currentWorld.resources,b=FiercePlanet.Game.levelOfDifficulty,c=[];for(var d=0,e=a.length;d<e;d++){var f=a[d],g=Math.pow(this.effect,Math.pow(1,b-1));Math.random()<g?c.push(f):FiercePlanet.Drawing.clearResource(f)}Lifecycle.currentWorld.setResources(c),this.struck=!0}},typeof exports!="undefined"&&(exports.Catastrophe=Catastrophe),Memory.prototype.addVisit=function(a,b){this.agentID=a,this.mostRecentVisit=b,this.visits++},MemoryOfAgent.prototype=new Memory,MemoryOfAgent.prototype.constructor=MemoryOfAgent,typeof exports!="undefined"&&(exports.Agent=Agent,exports.Memory=Memory,exports.MemoryOfAgent=MemoryOfAgent);var CultureDefaults=CultureDefaults||{};(function(){this.DEFAULT_INITIAL_HEALTH=100,this.DEFAULT_INITIAL_SPEED=40,this.DEFAULT_MOVE_COST=-3,this.DEFAULT_RUN_SPEED=60}).apply(CultureDefaults);var ProbabilityFlags=ProbabilityFlags||{};(function(){this.VERY_UNLIKELY=0,this.UNLIKELY=1,this.MODERATELY_LIKELY=2,this.EVEN_CHANCE=3,this.PROBABILITY_STRATEGY_TO_DEVIATE=this.UNLIKELY}).apply(ProbabilityFlags),typeof exports!="undefined"&&(exports.CultureDefaults=CultureDefaults,exports.Culture=Culture);var Beliefs=Beliefs||{};Beliefs.BeliefsAboutPaths={},function(){this.name="Beliefs About Paths",this.makeBelief=function(a,b){_.isUndefined(a.beliefs)&&(a.beliefs=[]),_.isUndefined(a.chronologicalMemory)&&(a.chronologicalMemory=[]),_.isUndefined(a.memoriesOfPlacesVisited)&&(a.memoriesOfPlacesVisited=[]),_.isUndefined(a.memoriesOfPathsUntried)&&(a.memoriesOfPathsUntried=[]);var c=a.x,d=a.y,e=null;_.isUndefined(a.memoriesOfPlacesVisited[[c,d]])?(e=new Memory(a.id,a.age,c,d),a.memoriesOfPlacesVisited[[c,d]]=e):(e=a.memoriesOfPlacesVisited[[c,d]],e.addVisit(a.id,a.age)),a.memoriesOfPathsUntried[[c,d]]!=undefined&&delete a.memoriesOfPathsUntried[[c,d]],a.lastUntriedPathMemory!=undefined&&(e.distanceFromLastUntriedPath=a.age-a.lastUntriedPathMemory.age),a.lastMemory=e,a.chronologicalMemory[a.age]=e;if(b!=undefined){c-1>=0&&b.areAgentsAllowed(c-1,d)&&a.memoriesOfPlacesVisited[[c-1,d]]==undefined&&(a.lastUntriedPathMemory=new Memory(a.id,a.age,c-1,d),a.memoriesOfPathsUntried[[c-1,d]]=a.lastUntriedPathMemory),c+1<b.cellsAcross&&b.areAgentsAllowed(c+1,d)&&a.memoriesOfPlacesVisited[[c+1,d]]==undefined&&(a.lastUntriedPathMemory=new Memory(a.id,a.age,c+1,d),a.memoriesOfPathsUntried[[c+1,d]]=a.lastUntriedPathMemory),d-1>=0&&b.areAgentsAllowed(c,d-1)&&a.memoriesOfPlacesVisited[[c,d-1]]==undefined&&(a.lastUntriedPathMemory=new Memory(a.id,a.age,c,d-1),a.memoriesOfPathsUntried[[c,d-1]]=a.lastUntriedPathMemory),d+1<b.cellsDown&&b.areAgentsAllowed(c,d+1)&&a.memoriesOfPlacesVisited[[c,d+1]]==undefined&&(a.lastUntriedPathMemory=new Memory(a.id,a.age,c,d+1),a.memoriesOfPathsUntried[[c,d+1]]=a.lastUntriedPathMemory);if(b.allowOffscreenCycling){if(c==0){var f=b.cellsAcross-1;b.areAgentsAllowed(f,d)&&a.memoriesOfPlacesVisited[[f,d]]==undefined&&(a.lastUntriedPathMemory=new Memory(a.id,a.age,f,d),a.memoriesOfPathsUntried[[f,d]]=a.lastUntriedPathMemory)}else if(c==b.cellsAcross-1){var f=0;b.areAgentsAllowed(f,d)&&a.memoriesOfPlacesVisited[[f,d]]==undefined&&(a.lastUntriedPathMemory=new Memory(a.id,a.age,f,d),a.memoriesOfPathsUntried[[f,d]]=a.lastUntriedPathMemory)}if(d==0){var g=b.cellsDown-1;b.areAgentsAllowed(c,g)&&a.memoriesOfPlacesVisited[[c,g]]==undefined&&(a.lastUntriedPathMemory=new Memory(a.id,a.age,c,g),a.memoriesOfPathsUntried[[c,g]]=a.lastUntriedPathMemory)}else if(d==b.cellsDown-1){var g=0;b.areAgentsAllowed(c,g)&&a.memoriesOfPlacesVisited[[c,g]]==undefined&&(a.lastUntriedPathMemory=new Memory(a.id,a.age,c,g),a.memoriesOfPathsUntried[[c,g]]=a.lastUntriedPathMemory)}}}}}.apply(Beliefs.BeliefsAboutPaths),Beliefs.BeliefsAboutResources={},function(){this.name="Beliefs About Resources",this.makeBelief=function(a,b){if(_.isUndefined(b))return;var c=a.x,d=a.y;if(_.isUndefined(c)||_.isUndefined(d))return;a.beliefs=a.beliefs||[],a.memoriesOfResources=a.memoriesOfResources||[];var e=b.resources,f=b.getVonNeumannNeighbourhood(c,d,!0);f.forEach(function(e){var f=b.getResourcesAtCell(e.x,e.y);f&&f.length>0&&(a.memoriesOfResources[b.indexify(c,d)]=f[0])})}}.apply(Beliefs.BeliefsAboutResources),Beliefs.BeliefsAboutOtherAgents={},function(){this.name="Beliefs About Other Agents",this.makeBelief=function(a,b){if(_.isUndefined(b))return;var c=a.x,d=a.y;if(_.isUndefined(c)||_.isUndefined(d))return;a.beliefs=a.beliefs||[],a.memoriesOfAgents=a.memoriesOfAgents||[];var e=b.getVonNeumannNeighbourhood(c,d,!0);e.forEach(function(e){var f=b.getAgentsAtCell(e.x,e.y);f&&f.length>0&&f.forEach(function(b){a.memoriesOfAgents[b.id]=new MemoryOfAgent(a.id,a.age,c,d,b.id)})})}}.apply(Beliefs.BeliefsAboutOtherAgents),Beliefs.BeliefsBasedOnOtherAgentsBeliefs={},function(){this.name="Beliefs Based On Other Agents' Beliefs",this.makeBelief=function(a,b){if(_.isUndefined(b))return;var c=a.x,d=a.y;if(_.isUndefined(c)||_.isUndefined(d))return;a.beliefs=a.beliefs||[],a.memoriesOfAgents=a.memoriesOfAgents||[];var e=[],f=b.getVonNeumannNeighbourhood(c,d,!0);f.forEach(function(c){var d=b.getAgentsAtCell(c.x,c.y);d&&d.length>0&&d.forEach(function(b){b.id!=a.id&&b.age>0&&b.alive&&!Lifecycle.currentWorld.isExitPoint(b.x,b.y)&&e.push(b)})}),e.forEach(function(b){if(b.lastMemory.x!=a.lastMemory.x||b.lastMemory.y!=a.lastMemory.y){a.memoriesOfAgents[b.id]=new MemoryOfAgent(a.id,a.age,c,d,b.id);var e=[];for(var f in b.memoriesOfPlacesVisited){var g=b.memoriesOfPlacesVisited[f];g!=undefined&&(e[[g.x,g.y]]=new Memory(g.agentID,g.age,g.x,g.y))}a.memoriesOfPlacesVisitedByOtherAgents[b.id]=e;var h=[];for(var f in b.memoriesOfPathsUntried){var g=b.memoriesOfPathsUntried[f];g!=undefined&&(h[[g.x,g.y]]=new Memory(g.agentID,g.age,g.x,g.y))}a.memoriesOfPathsUntriedByOtherAgents[b.id]=h}})}}.apply(Beliefs.BeliefsBasedOnOtherAgentsBeliefs),typeof exports!="undefined"&&(exports.Beliefs=Beliefs);var Desires=Desires||{};(function(){this.rankDesires=function(a,b){var c=a.culture.desires;return c.sort(function(c,d){return _.isUndefined(c.evaluate)||_.isUndefined(d.evaluate)?0:d.evaluate(a,b)-c.evaluate(a,b)})}}).apply(Desires),Desires.ImproveHealth={},function(){this.name="Improve Health",this.dependsOnBeliefs="Improve Health",this.evaluate=function(a,b){return 1-a.health/a.culture.initialHealth},this.findSatisfyingObjects=function(a){if(_.isUndefined(a.memoriesOfResources))return null;var b=[];for(var c in a.memoriesOfResources)if(a.memoriesOfResources.hasOwnProperty(c)){var d=a.memoriesOfResources[c];b.push(Lifecycle.currentWorld.deindexify(parseInt(c)))}return b},this.satisfy=function(a,b){Capabilities.ConsumeResourcesCapability.exercise(a,b)}}.apply(Desires.ImproveHealth),Desires.ExploreSpace={},function(){this.name="Explore",this.dependsOnBeliefs="Improve Health",this.evaluate=function(a,b){return.5},this.findSatisfyingObjects=function(a){if(_.isUndefined(a.memoriesOfPathsUntried))return null;var b=[];for(var c in a.memoriesOfPathsUntried)if(a.memoriesOfPathsUntried.hasOwnProperty(c)){var d=a.memoriesOfPathsUntried[c];!_.isUndefined(d.x)&&!_.isUndefined(d.y)&&b.push([d.x,d.y])}for(var c in a.memoriesOfPathsUntriedByOtherAgents)if(a.memoriesOfPathsUntriedByOtherAgents.hasOwnProperty(c)){var e=a.memoriesOfPathsUntriedByOtherAgents[c];for(var f in e)if(e.hasOwnProperty(f)){var d=e[f];!_.isUndefined(d.x)&&!_.isUndefined(d.y)&&(d.x!=a.x||d.y!=a.y)&&b.push([d.x,d.y])}}b.sort(function(a,b){return a[1]!=b[1]?a[1]-b[1]:a[0]-b[0]});for(var c=1;c<b.length;c++)b[c][0]===b[c-1][0]&&b[c][1]===b[c-1][1]&&b.splice(c--,1);for(var c in a.memoriesOfPlacesVisited)if(a.memoriesOfPlacesVisited.hasOwnProperty(c)){var d=a.memoriesOfPlacesVisited[c],g=-1;b.forEach(function(a,b){a[0]==d.x&&a[1]==d.y&&(g=b)}),g>-1&&b.splice(g,1)}for(var c in a.memoriesOfPlacesVisitedByOtherAgents)if(a.memoriesOfPlacesVisitedByOtherAgents.hasOwnProperty(c)){var e=a.memoriesOfPlacesVisitedByOtherAgents[c];for(var f in e)if(e.hasOwnProperty(f)){var d=e[f],g=-1;b.forEach(function(a,b){a[0]==d.x&&a[1]==d.y&&(g=b)}),g>-1&&b.splice(g,1)}}return b},this.satisfy=function(a,b){}}.apply(Desires.ExploreSpace),Desires.Flee={},function(){this.name="Flee",this.dependsOnBeliefs="Improve Health",this.evaluate=function(a,b){var c=b.getVonNeumannNeighbourhood(a.x,a.y,!0),d=!1;return c.forEach(function(c){var e=b.getAgentsAtCell(c.x,c.y);e.forEach(function(b){b.id!=a.id&&b.culture!=a.culture&&b.capabilities.forEach(function(a){a==Capabilities.PreyOnOtherAgentsCapability&&(d=!0)})})}),d?1:0},this.findSatisfyingObjects=function(a){if(_.isUndefined(a.memoriesOfAgents))return null;var b=[];for(var c in a.memoriesOfAgents)if(a.memoriesOfAgents.hasOwnProperty(c)){var d=a.memoriesOfAgents[c];b.push([d.x,d.y])}return b},this.satisfy=function(a,b){}}.apply(Desires.Flee),Desires.Reproduce={},function(){this.name="Reproduce",this.evaluate=function(a,b){return.1},this.findSatisfyingObjects=function(a){if(_.isUndefined(a.memoriesOfAgents))return null;var b=[];for(var c in a.memoriesOfAgents)if(a.memoriesOfAgents.hasOwnProperty(c)){var d=a.memoriesOfAgents[c];b.push([d.x,d.y])}return b},this.satisfy=function(a,b){}}.apply(Desires.Reproduce),typeof exports!="undefined"&&(exports.Desires=Desires);var Capabilities=Capabilities||{};Capabilities.ConsumeResourcesCapability=new Capability,function(){this.name="ConsumeResourcesCapability",this.exercise=function(a,b){var c=a.x,d=a.y,e=b.getNeighbouringResources(c,d);for(var f=0,g=e.length;f<g;f++){var h=e[f],i=b.calculateResourceEffect(h);h.provideYield(a,i,!b.noSpeedChange)}},this.getCapabilities=function(a,b){var c=a.x,d=a.y,e=b.getNeighbouringResources(c,d);return{capability:this,arguments:e}}}.apply(Capabilities.ConsumeResourcesCapability),Capabilities.ProduceResourcesCapability=new Capability,function(){this.name="ProduceResourcesCapability",this.exercise=function(a,b){if(!b.isPositionOccupiedByResource(a.x,a.y)){var c=ModuleManager.currentModule.resourceSet.types[Math.floor(Math.random()*ModuleManager.currentModule.resourceSet.types.length)],d=Math.random();d<.1&&b.currentResourceStore>c.cost&&b.addResource(new Resource(c,a.x,a.y))}},this.getCapabilities=function(a,b){var c=a.x,d=a.y,e=b.getNeighbouringResources(c,d);return{capability:this,arguments:e}}}.apply(Capabilities.ProduceResourcesCapability),Capabilities.RegenerateCapability=new Capability,function(){this.name="RegenerateCapability",this.exercise=function(a,b){if(a.gender!="f"||a.age<a.culture.reproductionAge)return;var c=a.x,d=a.y,e=b.getNeighbouringAgents(c,d);for(var f=0;f<e.length;f++){var g=e[f],h=g.x,i=g.y;if(Math.abs(h-c)<=1&&Math.abs(i-d)<=1&&g.gender=="m"&&g.culture.name==a.culture.name&&g.age>a.culture.reproductionAge){var j=Math.random();if(j<a.culture.birthProbability&&b.getAgentsAtCell(c,d).length<=1&&(Universe.settings.agentsOwnTilesExclusively||b.agentsOwnTilesExclusively)){var k=new Agent(a.culture,a.x,a.y);k.delay=parseInt(Math.random()*k.culture.initialSpeed*5),k.bornAt=Lifecycle.worldCounter,k.parents=[a,g],a.children.push(k),g.children.push(k),Lifecycle.currentWorld.currentAgents.push(k),Lifecycle.currentWorld.addAgentToCell(k),Lifecycle.currentWorld.currentResourceStore+=10}}}},this.getCapabilities=function(a,b){if(a.gender!="f"||a.age<a.culture.reproductionAge)return undefined;var c=a.x,d=a.y,e=[],f=b.getNeighbouringAgents(c,d);return f.forEach(function(b){b.gender=="m"&&b.culture.name==a.culture.name&&b.age>b.culture.reproductionAge&&e.push(b)}),{capability:this,arguments:e}}}.apply(Capabilities.RegenerateCapability),Capabilities.PreyOnOtherAgentsCapability=new Capability,function(){this.name="PreyOnOtherAgentsCapability",this.exercise=function(a,b){var c=a.x,d=a.y,e=b.getNeighbouringAgents(c,d),f=!1;for(var g=0;g<e.length;g++){var h=e[g],i=h.x,j=h.y;if(h.culture.name!=a.culture.name&&Math.random()<a.culture.preyProbability){h.adjustGeneralHealth(a.culture.preyCost),a.adjustGeneralHealth(a.culture.predatorGain),f=!0;break}}f||a.adjustGeneralHealth(a.culture.moveCost)},this.getCapabilities=function(a,b){if(a.gender!="f"||a.age<a.culture.reproductionAge)return undefined;var c=a.x,d=a.y,e=[],f=b.getNeighbouringAgents(c,d),c=a.x,d=a.y,f=b.getNeighbouringAgents(c,d);for(var g=0;g<f.length;g++){var h=f[g];h.culture.name!=a.culture.name&&Math.random()<a.culture.preyProbability&&e.push(h)}return{capability:this,arguments:e}}}.apply(Capabilities.PreyOnOtherAgentsCapability),Capabilities.MoveRandomlyCapability=new Capability,function(){this.name="MoveRandomlyCapability",this.cost=0,this.exercise=function(a,b){var c=b.getCellsAtDistance(a.x,a.y,1,Distance.CHEBYSHEV_DISTANCE,!0),d=_.chain(c).map(function(a){if(a.agentsAllowed)return a}).compact().value(),e=Math.floor(Math.random()*d.length),f=d[e];a.moveTo(f.x,f.y)}}.apply(Capabilities.MoveRandomlyCapability),Capabilities.MoveRandomlyToFreeCellCapability=new Capability,function(){this.name="MoveRandomlyToFreeCellCapability",this.cost=0,this.exercise=function(a,b){var c=b.getMooreNeighbourhood(a.x,a.y,!1),d=_.shuffle(c);for(var e=0;e<d.length;e++){var f=d[e],g=b.getCell(f.x,f.y);g.agentsAllowed&&g.agents.length==0&&a.moveTo(f.x,f.y)}}}.apply(Capabilities.MoveRandomlyToFreeCellCapability),typeof exports!="undefined"&&(exports.Capabilities=Capabilities);var Plans=Plans||{};(function(){this.findPositionForNearestExit=function(a,b){var c=this.getAllPlans(a,b,a.x,a.y),d=c.trail;return d.length>1?d[1]:d[0]},this.MAX_DEPTH=1e3,this.getAllPlans=function(a,b,c,d){var e=d||!0,f=-1,g,h,i=a.x,j=a.y,k=[];for(var l=0,m=c.length;l<m;l++){var n=c[l],o=n[0],p=n[1],q=this.criticalPathToPoint(a,b,i,j,o,p);if(!_.isUndefined(q)){var r=q.length;k.push({distance:r,trail:q,point:n})}}return k},this.getBestPlans=function(a,b,c,d){var e=this.getAllPlans(a,b,c,d),f=[],g=-1;for(var h=0;h<e.length;h++){var i=e[h];if(g==-1||i.distance<g)g=i.distance}for(var h=0;h<e.length;h++){var i=e[h];i.distance==g&&f.push(i)}return f},this.criticalPathToPoint=function(a,b,c,d,e,f){var g=[c,d],h=[e,f],i=[],j={},k=0;i.push(g),j[d*b.cellsAcross+c]=[g];var l=[];l.push(g);while(k++<this.MAX_DEPTH){var m=[];for(var n=0,o=l.length;n<o;n++){var p=l[n],q=p[0],r=p[1];if(b.isSameCell(p,h))return j[r*b.cellsAcross+q];var s=this.getDirections(p,h);for(var t=0;t<s.length;t++){var u=q,v=r;switch(s[t]){case 0:u=q==b.cellsAcross-1&&b.allowOffscreenCycling?0:u+1;break;case 1:v=r==b.cellsDown-1&&b.allowOffscreenCycling?0:v+1;break;case 2:u=q==0&&b.allowOffscreenCycling?b.cellsAcross-1:u-1;break;case 3:v=r==0&&b.allowOffscreenCycling?b.cellsDown-1:v-1}var w=[u,v],x=!0;if(!_.isUndefined(a.memoriesOfPlacesVisited[w])||!_.isUndefined(a.memoriesOfPathsUntried[w]))x=!1;if(x){if(!_.isUndefined(a.memoriesOfPlacesVisitedByOtherAgents))for(var y in a.memoriesOfPlacesVisitedByOtherAgents)if(a.memoriesOfPlacesVisitedByOtherAgents.hasOwnProperty(y)){var z=a.memoriesOfPlacesVisitedByOtherAgents[y];_.isUndefined(z[w])||(x=!1)}if(!_.isUndefined(a.memoriesOfPathsUntriedByOtherAgents))for(var y in a.memoriesOfPathsUntriedByOtherAgents)if(a.memoriesOfPathsUntriedByOtherAgents.hasOwnProperty(y)){var z=a.memoriesOfPathsUntriedByOtherAgents[y];_.isUndefined(z[w])||(x=!1)}}if(x)continue;if(u<0||u>=b.cellsAcross||v<0||v>=b.cellsDown)continue;if(!b.areAgentsAllowed(w[0],w[1]))continue;if(b.isInHistory(w,i))continue;if((Universe.settings.resourcesOwnTilesExclusively||b.resourcesOwnTilesExclusively)&&b.isPositionOccupiedByResource(u,v))continue;m.push(w),i.push(w);var A=r*b.cellsAcross+q,B=j[A],C=v*b.cellsAcross+u,D=[];for(var y=0,E=B.length;y<E;y++)D.push(B[y]);D.push(w),j[C]=D}}l=[];for(var n=0,o=m.length;n<o;n++)l.push(m[n])}},this.getDirections=function(a,b){var c=a[0],d=a[1],e=b[0],f=b[1],g=e-c,h=f-d,i=[];return Math.abs(g)<Math.abs(h)?g<0?i=h<0?[2,3,1,0]:[2,1,3,0]:i=h<0?[0,3,1,2]:[0,1,3,2]:h<0?i=g<0?[3,2,0,1]:[3,0,2,1]:i=g<0?[1,2,0,3]:[1,0,2,3],i}}).apply(Plans),typeof exports!="undefined"&&(exports.Plans=Plans),Campaign.prototype={worlds:[],id:undefined,name:undefined,position:undefined},typeof exports!="undefined"&&(exports.Campaign=Campaign),typeof exports!="undefined"&&(exports.Cell=Cell),Distance={CHEBYSHEV_DISTANCE:0,MINKOWSKI_DISTANCE:1,TAXICAB_DISTANCE:2},typeof exports!="undefined"&&(exports.World=World),Wave.prototype={agents:[],a:function(){console.log("a")}},typeof exports!="undefined"&&(exports.Wave=Wave),ResourceCategory.prototype.addType=function(a){this.types.push(a.clone()),a.category=this},ResourceCategory.prototype.clearTypes=function(){this.types=[]},ResourceCategory.prototype.setEvaluateOtherCategoryImpact=function(a){this.evaluateOtherCategoryImpact=a},ResourceCategory.prototype.doEvaluateOtherCategoryImpact=function(a){return this.evaluateOtherCategoryImpact(a)},ResourceType.prototype.clone=function(){return new ResourceType(this.name,this.code,this.image,this.cost,this.upgradeCost,this.totalYield,this.perAgentYield)},typeof exports!="undefined"&&(exports.ResourceCategory=ResourceCategory,exports.ResourceType=ResourceType,exports.Resource=Resource);var DEFAULT_TERRAIN_COLOR="#0FFF1F",DEFAULT_TERRAIN_ALPHA=0;Terrain.DEFAULT_TERRAIN=new Terrain(one.color(DEFAULT_TERRAIN_COLOR).alpha(DEFAULT_TERRAIN_ALPHA)),typeof exports!="undefined"&&(exports.DEFAULT_TERRAIN_COLOR=DEFAULT_TERRAIN_COLOR,exports.DEFAULT_TERRAIN_ALPHA=DEFAULT_TERRAIN_ALPHA,exports.Terrain=Terrain);var DEFAULT_TILE_COLOR="0FFF1F";Tile.prototype.getPosition=function(){return[this.x,this.y]},Tile.prototype.moveTo=function(a,b){this.x=a,this.y=b},typeof exports!="undefined"&&(exports.DEFAULT_TILE_COLOR=DEFAULT_TILE_COLOR,exports.Tile=Tile);var ModuleManager=ModuleManager||{};(function(){var a={};this.currentModule,this.clearAllModules=function(){a={},this.currentModule=undefined},this.registerModule=function(b){a=a||{},typeof b!="undefined"&&b.id&&(a[b.id]=b),b.init&&b.init(),this.currentModule=b},this.getModule=function(b){return a[b]},this.setCurrentModule=function(a){this.currentModule=this.getModule(a)}}).apply(ModuleManager),typeof exports!="undefined"&&(exports.ModuleManager=ModuleManager);var FiercePlanet=FiercePlanet||{};typeof exports!="undefined"&&(exports.Module=Module);var Lifecycle=Lifecycle||{};(function(){this.debug=!1,this.lastTime=0,this.worldDelay=1500,this.waveDelay=200,this.worldDelayCounter=0,this.waveDelayCounter=0,this.waveCounter=0,this.worldCounter=0,this.universeCounter=0,this.waveOverride=0,this.maxWaveMoves=0,this.maxWorldMoves=0,this.resourceRecoveryCycle=5,this.interval=10,this.agentTimerId=0,this.inPlay=!1,this.currentWorld=null,this.currentCampaignID="Default",this.currentWorldNumber=1,this.currentWorldPreset=!0,this.existingCurrentWorld=null,this.currentWave=1,this.currentWaveNumber=0,this.numAgents=1,this.processAgents=function(){var a=new Date,b=!1;Lifecycle.preProcessCallback&&Lifecycle.preProcessCallback();if(Lifecycle.worldDelayCounter<Lifecycle.worldDelay/Lifecycle.interval){Lifecycle.worldDelayCounter++;return}if(Lifecycle.waveDelayCounter<Lifecycle.waveDelay/Lifecycle.interval){Lifecycle.waveDelayCounter++;return}Lifecycle.waveCounter++,Lifecycle.worldCounter++,Lifecycle.universeCounter++,FiercePlanet.Parameters.processParameters(),Lifecycle.currentWorld.tickFunction&&Lifecycle.currentWorld.tickFunction();var c=Lifecycle.currentWorld.currentAgents,d=[],e=0;for(var f=0;f<c.length;f++){var g=c[f];if(Lifecycle.waveCounter<g.delay)continue;var h=g.speed,i=g.countdownToMove%h;i==0&&g.reviseBeliefs(Lifecycle.currentWorld)}for(var f=0;f<c.length;f++){var g=c[f],h=g.speed,i=g.countdownToMove%h;i==0&&(Lifecycle.currentWorld.isExitPoint(g.x,g.y)?(Lifecycle.processSavedCallback&&Lifecycle.processSavedCallback(),Lifecycle.currentWorld.addSavedAgent(g,Lifecycle.worldCounter),g.die(Lifecycle.currentWorld)):g.health<=0&&!Universe.settings.godMode&&(Lifecycle.currentWorld.addExpiredAgent(g,Lifecycle.worldCounter),g.die(Lifecycle.currentWorld),(ModuleManager.currentModule.id="Default")&&typeof FiercePlanet!="undefined"&&FiercePlanet.Game.currentProfile.currentWorldExpired++))}for(var f=0;f<c.length;f++){e++;var g=c[f];if(Lifecycle.waveCounter<g.delay)continue;var h=g.speed,i=g.countdownToMove%h;i==0&&(b=!0,Lifecycle.currentWorld.isExitPoint(g.x,g.y)&&(Lifecycle.processSavedCallback&&Lifecycle.processSavedCallback(),Lifecycle.currentWorld.addSavedAgent(g,Lifecycle.worldCounter),g.die(Lifecycle.currentWorld)),g.health<=0&&!Universe.settings.godMode&&(Lifecycle.currentWorld.addExpiredAgent(g,Lifecycle.worldCounter),g.die(Lifecycle.currentWorld),(ModuleManager.currentModule.id="Default")&&typeof FiercePlanet!="undefined"&&FiercePlanet.Game.currentProfile.currentWorldExpired++),g.alive&&(g.resetCountdownToMove(),!Lifecycle.currentWorld.noSpeedChange&&Universe.settings.agentsCanAdjustSpeed&&g.adjustSpeed(),!Lifecycle.currentWorld.noWander&&Universe.settings.agentsCanAdjustWander&&(Universe.settings.showResourcesAsBoxes&&Universe.settings.isometricView?g.adjustWander(FiercePlanet.Orientation.cellWidth,0):g.adjustWander(FiercePlanet.Orientation.cellWidth,FiercePlanet.Orientation.pieceWidth)),g.age>Lifecycle.maxWaveMoves&&(Lifecycle.maxWaveMoves=g.age),g.update(Lifecycle.currentWorld))),g.incrementCountdownToMove()}Lifecycle.currentWorld.recoverResources();if(!Lifecycle.currentWorld.playIndefinitely){if(Lifecycle.currentWorld.expiredAgents.length>=Lifecycle.currentWorld.expiryLimit&&!Universe.settings.noGameOver)return Lifecycle.gameOver();if(Lifecycle.currentWorld.currentAgents.length==0)if(Lifecycle.currentWaveNumber<Lifecycle.currentWorld.waveNumber-1)Lifecycle.completeWave(),Lifecycle.newWave();else if(Lifecycle.currentWorld.isPresetWorld&&!Lifecycle.currentWorld.isTerminalWorld)Lifecycle.completeWorld(),Lifecycle.worldDelayCounter=0;else return Lifecycle.completeGame()}Lifecycle.postProcessCallback&&Lifecycle.postProcessCallback();var j=new Date;Lifecycle.debug&&(console.log(j-a),console.log(j-this.lastTime)),this.lastTime=j},this.newGame=function(){this.preNewGameCallback&&this.preNewGameCallback(),Lifecycle.universeCounter=0,Lifecycle.newWorld(),this.postNewGameCallback&&this.postNewGameCallback()},this.newWorld=function(){this.preNewWorldCallback&&this.preNewWorldCallback(),Lifecycle.worldDelayCounter=0,Lifecycle.worldCounter=0,Lifecycle.currentWorld!=undefined&&(Lifecycle.currentWorld.resetResources(),Lifecycle.currentWorld.teardown&&Lifecycle.currentWorld.teardown()),Lifecycle._initialiseGame(),this.doNewWorldCallback?this.doNewWorldCallback():Lifecycle.startWorld(),this.postNewWorldCallback&&this.postNewWorldCallback()},this.restartWorld=function(){this.preRestartWorldCallback&&this.preRestartWorldCallback(),Lifecycle.newWorld(),this.postRestartWorldCallback&&this.postRestartWorldCallback()},this.startWorld=function(){this.preStartWorldCallback&&this.preStartWorldCallback(),FiercePlanet.Parameters.processParameters(),this.currentWorld&&this.currentWorld.handleParameters&&this.currentWorld.handleParameters(),Lifecycle.currentWaveNumber=0,Lifecycle.numAgents=Lifecycle.currentWorld.initialAgentNumber,Lifecycle.newWave(),this.currentWorld&&this.currentWorld.postStartWorldCallback&&this.currentWorld.postStartWorldCallback(),this.postStartWorldCallback&&this.postStartWorldCallback()},this.newWave=function(){this.preNewWaveCallback&&this.preNewWaveCallback(),Lifecycle.maxWaveMoves=0,Lifecycle.waveCounter=0,Lifecycle.waveDelayCounter=0,this.currentWorld.waves[this.currentWaveNumber]&&(Lifecycle.currentWorld.currentAgents=this.currentWorld.waves[this.currentWaveNumber].agents,Lifecycle.currentWorld.currentAgents.forEach(function(a){a.speed=a.culture.initialSpeed})),this._startAgents(),this.postNewWaveCallback&&this.postNewWaveCallback()},this.completeWave=function(){this.preCompleteWaveCallback&&this.preCompleteWaveCallback(),Lifecycle.currentWaveNumber++,Lifecycle.numAgents++,Lifecycle._finaliseGame(),this.postCompleteWaveCallback&&this.postCompleteWaveCallback()},this.completeWorld=function(){this.preCompleteWorldCallback&&this.preCompleteWorldCallback(),Lifecycle.currentWorld.teardown&&Lifecycle.currentWorld.teardown(),Lifecycle.currentWorld.isPresetWorld&&Lifecycle.currentWorldNumber++,Lifecycle._finaliseGame(),this.postCompleteWorldCallback&&this.postCompleteWorldCallback()},this.completeGame=function(){this.preCompleteGameCallback&&this.preCompleteGameCallback(),Lifecycle.currentWorld.teardown&&Lifecycle.currentWorld.teardown(),Lifecycle._finaliseGame(),this.postCompleteGameCallback&&this.postCompleteGameCallback()},this.gameOver=function(){this.preGameOverCallback&&this.preGameOverCallback(),Lifecycle.currentWorld.teardown&&Lifecycle.currentWorld.teardown(),Lifecycle._finaliseGame(),this.postGameOverCallback&&this.postGameOverCallback()},this._initialiseGame=function(){this.preInitialiseGameCallback&&this.preInitialiseGameCallback(),typeof console!="undefined"&&console.log("Initialising Universe..."),Lifecycle._stopAgents(),Lifecycle.currentWorldPreset&&(Lifecycle.currentWorldNumber<0||Lifecycle.currentWorldNumber>1e3)&&(Lifecycle.currentWorldNumber=1),Lifecycle.currentCampaignID=Lifecycle.currentCampaignID||"Default";if(Lifecycle.currentWorldPreset)try{Lifecycle.currentWorld=ModuleManager.currentModule.getWorld(Lifecycle.currentCampaignID,Lifecycle.currentWorldNumber)}catch(a){Lifecycle.currentWorld=ModuleManager.currentModule.getWorld(Lifecycle.currentCampaignID,1)}else Lifecycle.currentWorld==undefined&&(Lifecycle.currentWorld=ModuleManager.currentModule.getWorld(Lifecycle.currentCampaignID,1));Lifecycle.currentWave=1,Lifecycle.currentWaveNumber=0,_.isUndefined(Lifecycle.currentWorld.initWorld)||Lifecycle.currentWorld.initWorld(),this.postInitialiseGameCallback&&this.postInitialiseGameCallback()},this._finaliseGame=function(){this.preFinaliseGameCallback&&this.preFinaliseGameCallback(),Lifecycle._stopAgents(),this.postFinaliseGameCallback&&this.postFinaliseGameCallback()},this._startAgents=function(){this.preStartAgentsCallback&&this.preStartAgentsCallback(),Lifecycle.startTime=new Date,typeof console!="undefined"&&console.log("Starting agents at "+Lifecycle.startTime),clearInterval(Lifecycle.agentTimerId),Lifecycle.inPlay=!0;var a=!_.isUndefined(Lifecycle.currentWorld.interval)&&Lifecycle.currentWorld.interval>0?Lifecycle.currentWorld.interval:Lifecycle.interval;this.processAgentsInBrowser(),this.postStartAgentsCallback&&this.postStartAgentsCallback()},this.processAgentsInBrowser=function(){Lifecycle.inPlay&&window&&(window.requestAnimationFrame(Lifecycle.processAgentsInBrowser),Lifecycle.processAgents())},this._stopAgents=function(){this.preStopAgentsCallback&&this.preStopAgentsCallback(),Lifecycle.stopTime=new Date,typeof console!="undefined"&&console.log("Pausing agents after "+(Lifecycle.stopTime-Lifecycle.startTime)),clearInterval(Lifecycle.agentTimerId),Lifecycle.inPlay=!1,this.postStopAgentsCallback&&this.postStopAgentsCallback()}}).apply(Lifecycle),typeof exports!="undefined"&&(exports.Lifecycle=Lifecycle);var Statistics={};(function(){this.populationStats=function(){var a=[];if(Lifecycle.worldCounter>0){var b=ModuleManager.currentModule.allCultures(),c=0;for(var d=0,e=b.length;d<e;d++){var f=b[d],g=0;Lifecycle.currentWorld.currentAgents.forEach(function(a){a.culture.name==f.name&&g++});var h=[f.name,g];c++,a.push(h)}}return a},this.healthStats=function(){var a=[];if(Lifecycle.worldCounter>0){var b=Lifecycle.currentWorld.currentAgentHealthStats();for(var c=0,d=ModuleManager.currentModule.resourceSet.categories.length;c<d;c++)a.push(ModuleManager.currentModule.resourceSet.categories[c].code,b[ModuleManager.currentModule.resourceSet.categories[c].code]);a.push("total",b.total)}return a},this.savedAndExpiredStats=function(){var a=[];if(Lifecycle.worldCounter>0){var b=Lifecycle.currentWorld.savedAgents.length,c=Lifecycle.currentWorld.expiredAgents.length;a.push(["Saved",b]),a.push(["Expired",c]),a.push(["Save rate",b/(c==0?1:c)])}return a},this.lifeExpectancyStats=function(){var a=[];if(Lifecycle.worldCounter>0){var b=0,c=0,d=0,e=0,f=0,g=0,h=0,i=0,j=0,k=0,l=0,m=0,n=0,o=0,p=0,q=0,r=Lifecycle.currentWorld.currentAgents.length,s=Lifecycle.currentWorld.savedAgents.length,t=Lifecycle.currentWorld.expiredAgents.length,u=s+t,v=0,w=0;r=r==0?1:r,s=s==0?1:s,t=t==0?1:t,u=u==0?1:u;var b=Lifecycle.currentWorld.expiredAgents.length;Lifecycle.currentWorld.expiredAgents.forEach(function(a){var b=a.diedAt-a.bornAt;c+=b;if(d==0||b<d)d=b;b>e&&(e=b)}),f=c/b,g=b,h=c,i=d,j=e,Lifecycle.currentWorld.savedAgents.forEach(function(a){var b=a.diedAt-a.bornAt;b>f&&(g++,h+=b,b>j&&(j=b))}),Lifecycle.currentWorld.currentAgents.forEach(function(a){var b=Lifecycle.worldCounter-a.bornAt;b>f&&(g++,h+=b,b>j&&(j=b))}),k=h/g,a.push(["Expired count",Math.floor(b)]),a.push(["Expired ave",Math.floor(f)]),a.push(["Expired min",Math.floor(d)]),a.push(["Expired max",Math.floor(e)]),a.push(["Recalibrated count",Math.floor(g)]),a.push(["Recalibrated ave",Math.floor(k)]),a.push(["Recalibrated min",Math.floor(i)]),a.push(["Recalibrated max",Math.floor(j)])}return a},this.lifeExpectancyByAgentCultureStats=function(){var a=[];if(Lifecycle.worldCounter>0)for(var b=0,c=ModuleManager.currentModule.cultures.length;b<c;b++){var d=ModuleManager.currentModule.cultures[b],e=0,f=0,g=0,h=Lifecycle.currentWorld.expiredAgents.length;h=h==0?1:h;for(var i in Lifecycle.currentWorld.expiredAgents){var j=Lifecycle.currentWorld.expiredAgents[i];if(j.culture.name==d.name){var k=j.diedAt-j.bornAt;e+=k,i==0?(f=k,g=k):(k<f&&(f=k),k>g&&(g=k))}}var l=e/h;a.push([d.name+" life expectancy",Math.floor(l)]),a.push([d.name+" min life",Math.floor(f)]),a.push([d.name+" max life",Math.floor(g)])}return a},this.hdiStats=function(){var a=[];if(Lifecycle.worldCounter>0){var b=Lifecycle.currentWorld.currentAgentHealthStats();a.push("total",b.total)}return a},this.hpiStats=function(){var a=[];if(Lifecycle.worldCounter>0){var b=Lifecycle.currentWorld.currentAgentHealthStats();for(var c=0,d=ModuleManager.currentModule.resourceSet.categories.length;c<d;c++)a.push(ModuleManager.currentModule.resourceSet.categories[c].code,b[ModuleManager.currentModule.resourceSet.categories[c].code]);a.push("total",b.total)}return a}}).apply(Statistics),typeof exports!="undefined"&&(exports.Statistics=Statistics);var DefaultCultures=DefaultCultures||{};DefaultCultures.Circular=new Culture("Circular",one.color("#000")),_.extend(DefaultCultures.Circular,{drawFunction:function(a,b,c,d,e,f,g,h,i){var j=e/4;a.lineWidth=1.5,a.beginPath(),a.arc(c+j,d+j,j,0,Math.PI*2,!1),a.closePath(),a.strokeStyle=b.color,a.stroke(),a.fillStyle=b.color,a.fill()}}),DefaultCultures.Square=new Culture("Square",one.color("#000")),_.extend(DefaultCultures.Square,{drawFunction:function(a,b,c,d,e,f,g,h,i){a.fillStyle=b.color,a.fillRect(c-FiercePlanet.Orientation.cellWidth/2,d-FiercePlanet.Orientation.cellHeight/2,FiercePlanet.Orientation.cellWidth,FiercePlanet.Orientation.cellHeight)}}),DefaultCultures.Stickman=new Culture("Stickman",one.color("#000")),_.extend(DefaultCultures.Stickman,{drawFunction:function(ctx,agent,x,y,width,height,newColor,counter,direction){var frames=4,speed=agent.speed,health=agent.health,countdown=agent.countdownToMove,frame=Math.floor(countdown/(speed+1)*frames),yHealthOffset=-5;for(var j in agent.culture.healthCategories){var rc=agent.culture.healthCategories[j],h=agent.getHealthForResourceCategory(rc),barLength=Math.floor(h/agent.culture.initialHealth*width/2);ctx.lineWidth=3,ctx.lineCap="round",ctx.beginPath(),ctx.moveTo(x+width/4,y+yHealthOffset),ctx.lineTo(x+width/4+barLength,y+yHealthOffset),ctx.closePath(),ctx.strokeStyle=rc.color,ctx.stroke(),yHealthOffset-=3}switch(frame){case 0:y=y-1;break;case 1:y=y-2;break;case 2:y=y-1;break;case 3:}var sf=new FiercePlanet.StickFigure(x,y,width,height,!0);if(!_.isUndefined(agent.culture.customStickFunction))sf.defaultAction=eval(agent.culture.customStickFunction);else if(health<=0){var explosionX=x+width/2,explosionY=y+width/8,radgrad=ctx.createRadialGradient(explosionX,explosionY,0,explosionX,explosionY,width/3);radgrad.addColorStop(0,"rgba(255, 168, 81,1)"),radgrad.addColorStop(.8,"#FFF354"),radgrad.addColorStop(1,"rgba(255, 168, 81,0)"),ctx.fillStyle=radgrad,ctx.fillRect(x,y-width/4,width,height+width/4),sf.defaultAction=sf.expire}else speed>CultureDefaults.DEFAULT_RUN_SPEED?sf.defaultAction=sf.walk:sf.defaultAction=sf.run;sf.defaultAction(frame,direction),sf.drawFigure(ctx),ctx.lineWidth=1.5,ctx.lineCap="round",ctx.strokeStyle=agent.color.hex(),ctx.stroke()}}),DefaultCultures.MovingStickman=_.clone(DefaultCultures.Stickman),_.extend(DefaultCultures.MovingStickman,{beliefs:[Beliefs.BeliefsAboutPaths,Beliefs.BeliefsAboutResources,Beliefs.BeliefsBasedOnOtherAgentsBeliefs],desires:[Desires.ExploreSpace,Desires.Flee],capabilities:[Capabilities.ConsumeResourcesCapability]}),typeof exports!="undefined"&&(exports.DefaultCultures=DefaultCultures,exports.CultureDefaults=CultureDefaults);var FiercePlanet=FiercePlanet||{};FiercePlanet.Profile=FiercePlanet.Profile||{},FiercePlanet.Profile.PROFILE_CLASSES=["Novice","Planner","Expert","Visionary","Genius"],FiercePlanet.Profile.PROFILE_UPGRADE_SCORES=[500,1e3,2500,5e3,0],FiercePlanet.Profile.CAPABILITY_COSTS=[0,100,200,300,500],FiercePlanet.Profile.NOVICE_CAPABILITIES=["farm","water","clinic"],FiercePlanet.Profile.PLANNER_CAPABILITIES=FiercePlanet.Profile.NOVICE_CAPABILITIES.concat(["shop","park","school"]),FiercePlanet.Profile.EXPERT_CAPABILITIES=FiercePlanet.Profile.PLANNER_CAPABILITIES.concat(["bank","air","legal"]),FiercePlanet.Profile.VISIONARY_CAPABILITIES=FiercePlanet.Profile.EXPERT_CAPABILITIES.concat(["factory","energy","democracy"]),FiercePlanet.Profile.GENIUS_CAPABILITIES=FiercePlanet.Profile.VISIONARY_CAPABILITIES.concat(["stockmarket","biodiversity","festival"]),FiercePlanet.Profile.STARTING_STORE=0,Profile.prototype._initialise=function(){this.currentWorldSaved=this.currentWorldSaved||0,this.currentWorldResourcesInStore=this.currentWorldResourcesInStore||FiercePlanet.Profile.Game.STARTING_STORE},Profile.prototype.resetCurrentStats=function(){this.currentWorldSaved=0,this.currentWorldExpired=0,this.currentWorldResourcesInStore=Lifecycle.currentWorld.initialResourceStore||FiercePlanet.Profile.STARTING_STORE,this.currentWorldResourcesSpent=0,this.currentWorldResourcesSpentByCategory={};if(_.isUndefined(ModuleManager.currentModule.resourceSet))return;for(var a=0;a<ModuleManager.currentModule.resourceSet.categories.length;a++){var b=ModuleManager.currentModule.resourceSet.categories[a];this.currentWorldResourcesSpentByCategory[b.code]=0}},Profile.prototype.initialiseResourceStore=function(a){this.currentWorldResourcesInStore=a||FiercePlanet.Profile.STARTING_STORE},Profile.prototype.compileProfileStats=function(a){this.currentWorld=a._id||this.currentWorld,this.currentWorldIsPreset=a.isPresetWorld||this.currentWorldIsPreset,this.gameHighestWorld<this.currentWorld&&(this.gameHighestWorld=this.currentWorld),this.gameScore<this.currentScore&&(this.gameScore=this.currentScore),this.gameTotalWorlds++,this.gameTotalSaved+=this.currentWorldSaved,this.gameTotalExpired+=this.currentWorldExpired,this.gameTotalResourcesSpent+=this.currentWorldResourcesSpent,this.gameAveSaved=this.gameTotalSaved/this.gameTotalWorlds,this.gameAveExpired=this.gameTotalExpired/this.gameTotalWorlds,this.gameAveResourcesSpent=this.gameTotalResourcesSpent/this.gameTotalWorlds;var b=Object.keys(this.currentWorldResourcesSpentByCategory);for(var c=0;c<b.length;c++){var d=b[c],e=this.currentWorldResourcesSpentByCategory[d],f=this.gameTotalResourcesSpentByCategory[d]||0;f+=e,this.gameTotalResourcesSpentByCategory[d]=f,this.gameAveResourcesSpentByCategory[d]=f/this.gameTotalWorlds}this.highestScore<this.currentScore&&(this.highestScore=this.currentScore),this.highestWorld<this.currentWorld&&(this.highestWorld=this.currentWorld),this.credits+=this.currentWorldResourcesInStore,this.totalWorlds++,this.totalSaved+=this.currentWorldSaved,this.totalExpired+=this.currentWorldExpired,this.totalResourcesSpent+=this.currentWorldResourcesSpent,this.aveSaved=this.totalSaved/this.totalWorlds,this.aveExpired=this.totalExpired/this.totalWorlds,this.aveResourcesSpent=this.totalResourcesSpent/this.totalWorlds;for(var c=0;c<b.length;c++){var d=b[c],e=this.currentWorldResourcesSpentByCategory[d],g=this.totalResourcesSpentByCategory[d]||0;g+=e,this.totalResourcesSpentByCategory[d]=g,this.aveResourcesSpentByCategory[d]=g/this.totalWorlds}this.evaluateProfileClass()},Profile.prototype.resetScores=function(){this.currentScore=this.gameScore=0},Profile.prototype.revertScore=function(){this.currentScore=this.gameScore},Profile.prototype.updateScore=function(){this.gameScore=this.currentScore},Profile.prototype.processSavedAgent=function(a){this.currentScore+=FiercePlanet.Game.SAVE_SCORE,this.highestScore<this.currentScore&&(this.highestScore=this.currentScore),this.currentWorldSaved++,this.currentWorldSavedThisWave++;var b=a<5?4:a<10?3:a<20?2:1;this.currentWorldResourcesInStore+=b},Profile.prototype.spendResource=function(a){var b=a.category.code;this.currentWorldResourcesInStore-=a.cost,this.currentWorldResourcesSpent+=a.cost,this.currentWorldResourcesSpentByCategory[b]+=1},Profile.prototype.evaluateProfileClass=function(){this.totalSaved>FiercePlanet.Profile.PROFILE_UPGRADE_SCORES[3]?(this.profileClass=FiercePlanet.Profile.PROFILE_CLASSES[4],this.progressTowardsNextClass=FiercePlanet.Profile.PROFILE_UPGRADE_SCORES[0]):this.totalSaved>FiercePlanet.Profile.PROFILE_UPGRADE_SCORES[2]?(this.profileClass=FiercePlanet.Profile.PROFILE_CLASSES[3],this.progressTowardsNextClass=FiercePlanet.Profile.PROFILE_UPGRADE_SCORES[3]-this.totalSaved):this.totalSaved>FiercePlanet.Profile.PROFILE_UPGRADE_SCORES[1]?(this.profileClass=FiercePlanet.Profile.PROFILE_CLASSES[2],this.progressTowardsNextClass=FiercePlanet.Profile.PROFILE_UPGRADE_SCORES[2]-this.totalSaved):this.totalSaved>FiercePlanet.Profile.PROFILE_UPGRADE_SCORES[0]?(this.profileClass=FiercePlanet.Profile.PROFILE_CLASSES[1],this.progressTowardsNextClass=FiercePlanet.Profile.PROFILE_UPGRADE_SCORES[1]-this.totalSaved):this.progressTowardsNextClass=FiercePlanet.Profile.PROFILE_UPGRADE_SCORES[0]-this.totalSaved},Profile.makeProfile=function(a){a.evaluateProfileClass=Profile.prototype.evaluateProfileClass,a.spendResource=Profile.prototype.spendResource,a.processSavedAgent=Profile.prototype.processSavedAgent,a.updateScore=Profile.prototype.updateScore,a.revertScore=Profile.prototype.revertScore,a.resetScores=Profile.prototype.resetScores,a.updateScore=Profile.prototype.updateScore,a.initialiseResourceStore=Profile.prototype.initialiseResourceStore,a.resetCurrentStats=Profile.prototype.resetCurrentStats,a.compileProfileStats=Profile.prototype.compileProfileStats,a._initialise=Profile.prototype._initialise,a._initialise()},typeof exports!="undefined"&&(exports.Profile=Profile),PlayerClass.prototype.getName=function(){return this.name},PlayerClass.prototype.setName=function(a){this.name=a},PlayerClass.prototype.getSavesRequired=function(){return this.savesRequired},PlayerClass.prototype.setSavesRequired=function(a){this.savesRequired=a};var FiercePlanet=FiercePlanet||{};EventTarget.prototype={constructor:EventTarget,addListener:function(a,b){_.isUndefined(this.listeners[a])&&(this.listeners[a]=[]),this.listeners[a].push(b)},fire:function(a){typeof a=="string"&&(a={type:a}),a.target||(a.target=this);if(!a.type)throw new Error("Event object missing 'type' property.");if(this.listeners[a.type]instanceof Array){var b=this.listeners[a.type];for(var c=0,d=b.length;c<d;c++)b[c].call(this,a)}},removeListener:function(a,b){if(this.listeners[a]instanceof Array){var c=this.listeners[a];for(var d=0,e=c.length;d<e;d++)if(c[d]===b){c.splice(d,1);break}}}},FiercePlanet.Event=FiercePlanet.Event||{},function(){this.hookUpCustomEventListeners=function(){FiercePlanet.Game.eventTarget.addListener("game",function(a){_.isUndefined(console)&&console.log("Game event "+a.event+" logged at:"+a.time)}),FiercePlanet.Game.eventTarget.addListener("resource",function(a){var b=a.source,c=a.worldContext;if(c.id==1){var d=b.category,e=d.name,f=d.color,g=d.code,h=Lifecycle.currentWorld.resourceCategoryCounts[g];h==1&&Log.info("Well done! You've added your first "+e+" resource!")}})}}.apply(FiercePlanet.Event);var FiercePlanet=FiercePlanet||{};FiercePlanet.Drawing=FiercePlanet.Drawing||{},function(){this.drawGame=function(){$("#actual_map").empty(),this.clearCanvas("#baseCanvas"),this.clearCanvas("#resourceCanvas"),this.clearCanvas("#scrollingCanvas"),this.clearCanvas("#noticeCanvas"),this.clearCanvas("#agentCanvas"),!_.isUndefined(Lifecycle.currentWorld.backgroundTerrain)&&Lifecycle.currentWorld.backgroundTerrain!=null?(this.drawBackgroundTerrain(),this.drawPath()):(this.drawMap(),this.drawPath()),this.drawEntryPoints(),this.drawExitPoints(),this.drawResources(),this.drawScrollingLayer(),this.drawScoreboard()},this.drawCanvases=function(){this.clearCanvas("#baseCanvas"),this.clearCanvas("#resourceCanvas"),this.clearCanvas("#agentCanvas"),!_.isUndefined(Lifecycle.currentWorld.backgroundTerrain)&&Lifecycle.currentWorld.backgroundTerrain!=null?(this.drawBackgroundTerrain(),this.drawPath()):this.drawPath(),this.drawEntryPoints(),this.drawExitPoints(),this.drawResourceAndAgents()},this.drawBackgroundTerrain=function(a){var b=a||"#baseCanvas",c=$(b)[0],d=c.getContext("2d"),e=Lifecycle.currentWorld.backgroundTerrain,f=e?e.color:"#fff";d.fillStyle=f,d.fillRect(0,0,FiercePlanet.Orientation.worldWidth,FiercePlanet.Orientation.worldHeight)},this.drawPath=function(a){var b="#baseCanvas",c=$(b)[0],d=c.getContext("2d"),e=Lifecycle.currentWorld,f=!_.isUndefined(e.drawAllCells)&&e.drawAllCells?_.map(e.cells,function(a){return[a.x,a.y]}):e.pathway,g=FiercePlanet.Orientation.halfWorldWidth,h=FiercePlanet.Orientation.halfWorldHeight;d.save(),d.translate(g,h),d.rotate(FiercePlanet.Orientation.rotationAngle);if(f)for(var i=0;i<f.length;i+=1){var j=f[i],k=j[0],l=j[1],m=k*FiercePlanet.Orientation.cellWidth*FiercePlanet.Orientation.zoomWorld,n=l*FiercePlanet.Orientation.cellHeight*FiercePlanet.Orientation.zoomWorld,o=Lifecycle.currentWorld.getCell(k,l).terrain,p=o?o.color:"#fff";if(Universe.settings.isometricView||Lifecycle.currentWorld.isometricView){var q=FiercePlanet.Isometric.doIsometricOffset(k,l),r=q.x+FiercePlanet.Orientation.cellWidth/2,s=q.y+FiercePlanet.Orientation.cellHeight;r=(r-FiercePlanet.Orientation.halfWorldWidth)*FiercePlanet.Orientation.zoomWorld,s=(s-FiercePlanet.Orientation.halfWorldHeight)*FiercePlanet.Orientation.zoomWorld,FiercePlanet.Isometric.draw3DTile(d,[r,s],FiercePlanet.Orientation.cellHeight*FiercePlanet.Orientation.zoomWorld),Universe.settings.hidePath||(d.fillStyle=p,d.fill()),Universe.settings.hidePathBorder||(d.lineWidth=1/FiercePlanet.Orientation.zoomWorld,d.strokeStyle=one.color("#ccc").hex(),d.stroke())}else{m=m-FiercePlanet.Orientation.halfWorldWidth*FiercePlanet.Orientation.zoomWorld,n=n-FiercePlanet.Orientation.halfWorldHeight*FiercePlanet.Orientation.zoomWorld;if(!Universe.settings.hidePath){if(l==0){var t=d.createLinearGradient(m,n,m,n+FiercePlanet.Orientation.cellHeight/4);t.addColorStop(0,"#ccc");try{t.addColorStop(1,p)}catch(u){console!==undefined&&console.log(p)}d.fillStyle=t}else d.fillStyle=p;d.fillRect(m,n,FiercePlanet.Orientation.cellWidth*FiercePlanet.Orientation.zoomWorld,FiercePlanet.Orientation.cellHeight*FiercePlanet.Orientation.zoomWorld)}Universe.settings.hidePathBorder||(d.lineWidth=1/FiercePlanet.Orientation.zoomWorld,d.strokeStyle="#ccc",d.strokeRect(m,n,FiercePlanet.Orientation.cellWidth,FiercePlanet.Orientation.cellHeight))}}d.restore()},this.drawBackgroundImage=function(){if(Lifecycle.currentWorld.backgroundImage!=undefined){var a=$("#baseCanvas")[0],b=a.getContext("2d");b.drawImage(Lifecycle.currentWorld.image,0,0)}},this.drawMap=function(){var a="#actual_map";if(Lifecycle.currentWorld!=undefined&&!Lifecycle.currentWorld.noMap){FiercePlanet.GoogleMapUtils.loadScript();var b=FiercePlanet.GoogleMapUtils.defaultOptions();Lifecycle.currentWorld.mapOptions&&$.extend(b,Lifecycle.currentWorld.mapOptions),FiercePlanet.Orientation.zoomWorld>1&&(b.zoom=b.zoom+Math.log(FiercePlanet.Orientation.zoomWorld)/Math.log(1.5)),Universe.settings.isometricView?b.tilt=45:b.tilt=0,FiercePlanet.Game.googleMap=FiercePlanet.GoogleMapUtils.createMap(b,a),FiercePlanet.Game.mapOptions=b}},this.drawExitPoints=function(a){var b=a||"#baseCanvas",c=$(b)[0],d=c.getContext("2d"),e=FiercePlanet.Orientation.worldWidth/2,f=FiercePlanet.Orientation.worldHeight/2;d.save(),d.translate(e,f),d.rotate(FiercePlanet.Orientation.rotationAngle);var g=Lifecycle.currentWorld.getExitPoints();for(var h=0;h<g.length;h++){var i=g[h],j=i.x,k=i.y,l=j*FiercePlanet.Orientation.cellWidth+FiercePlanet.Orientation.cellWidth/2,m=k*FiercePlanet.Orientation.cellHeight+FiercePlanet.Orientation.cellHeight/2;if(Universe.settings.isometricView||Lifecycle.currentWorld.isometricView){var n=FiercePlanet.Isometric.doIsometricOffset(i[0],i[1]);l=n.x+FiercePlanet.Orientation.cellWidth/2,m=n.y+FiercePlanet.Orientation.cellHeight/2}l=(l-FiercePlanet.Orientation.halfWorldWidth)*FiercePlanet.Orientation.zoomWorld,m=(m-FiercePlanet.Orientation.halfWorldHeight)*FiercePlanet.Orientation.zoomWorld;var o=FiercePlanet.Orientation.pieceHeight/2;d.beginPath(),d.arc(l,m,o,0,Math.PI*2,!1),d.closePath(),d.strokeStyle="#000",d.stroke(),d.fillStyle="#fff",d.fill();var p=(FiercePlanet.Game.currentWave-1)/Lifecycle.currentWorld.waveNumber;d.beginPath(),d.moveTo(l,m),d.arc(l,m,o,-Math.PI/2,-Math.PI/2+Math.PI*2*p,!1),d.closePath(),d.strokeStyle="#000",d.stroke(),d.fillStyle="#93C83E",d.fill()}d.restore()},this.drawEntryPoints=function(a){var b=a||"#baseCanvas",c=$(b)[0],d=c.getContext("2d"),e=FiercePlanet.Orientation.worldWidth/2,f=FiercePlanet.Orientation.worldHeight/2;d.save(),d.translate(e,f),d.rotate(FiercePlanet.Orientation.rotationAngle);var g=Lifecycle.currentWorld.getEntryPoints();for(var h=0;h<g.length;h++){var i=g[h],j=i.x,k=i.y,l=j*FiercePlanet.Orientation.cellWidth+FiercePlanet.Orientation.cellWidth/2,m=k*FiercePlanet.Orientation.cellHeight+FiercePlanet.Orientation.cellHeight/2;if(Universe.settings.isometricView||Lifecycle.currentWorld.isometricView){var n=FiercePlanet.Isometric.doIsometricOffset(i[0],i[1]);l=n.x+FiercePlanet.Orientation.cellWidth/2,m=n.y+FiercePlanet.Orientation.cellHeight/2}l=(l-FiercePlanet.Orientation.halfWorldWidth)*FiercePlanet.Orientation.zoomWorld,m=(m-FiercePlanet.Orientation.halfWorldHeight)*FiercePlanet.Orientation.zoomWorld;var o=FiercePlanet.Orientation.pieceHeight/2;d.beginPath(),d.arc(l,m,o,0,Math.PI*2,!1),d.closePath(),d.strokeStyle="#000",d.stroke(),d.fillStyle="#93C83E",d.fill();var p=(FiercePlanet.Game.currentWave-1)/Lifecycle.currentWorld.waveNumber;d.beginPath(),d.moveTo(l,m),d.arc(l,m,o,-Math.PI/2,-Math.PI/2+Math.PI*2*p,!1),d.closePath(),d.strokeStyle="#000",d.stroke(),d.fillStyle="#fff",d.fill()}d.restore()},this.drawNotice=function(a){if(FiercePlanet.Game.currentNotice!=null){var b=FiercePlanet.Game.currentNotice.text,c=FiercePlanet.Game.currentNotice.start,d=FiercePlanet.Game.currentNotice.duration,e=(d-(Lifecycle.worldCounter-c))/d,f=.1,g=Math.pow(e-f,.5),h=FiercePlanet.Game.currentNotice.x,i=FiercePlanet.Game.currentNotice.y,j=FiercePlanet.Game.currentNotice.width,k=FiercePlanet.Game.currentNotice.height,l=this.insertAlpha(FiercePlanet.Game.currentNotice.foregroundColor,g),m=this.insertAlpha(FiercePlanet.Game.currentNotice.backgroundColor,g),n=FiercePlanet.Game.currentNotice.lineWidth,o=FiercePlanet.Game.currentNotice.font;c>Lifecycle.worldCounter||c+d<Lifecycle.worldCounter?_.isUndefined(this.noticeDialog)||(this.noticeDialog.dialog("close"),this.noticeDialog=undefined):_.isUndefined(this.noticeDialog)&&(this.noticeDialog=$("<div></div>").html(b).dialog({autoOpen:!1,modal:!1,title:"Fierce Planet Notice!",buttons:{Close:function(){$(this).dialog("close"),Lifecycle._startAgents()}}}),this.noticeDialog.dialog("open"))}},this.drawTooltip=function(a,b){this.tooltipDialog=$("<div></div>").html(a).dialog({autoOpen:!0,modal:!1,title:"Fierce Planet Notice!",buttons:{Close:function(){$(this).dialog("close"),b()}}})},this.getTextLines=function(a,b,c){var d=a.measureText(b).width;if(d<c)return[b];var e=Math.ceil(d/c),f=b.length/e,g=[],h=b.split(" "),i="";for(var j=0;j<h.length;j++){var k=h[j];if(a.measureText(i+k+" ").width<c)i+=k+" ";else if(i.length==0&&a.measureText(k).width>=f){var l=a.measureText(k).width,m=Math.ceil(l/c),n=k.length/m;i+=k.substring(0,n-1)+"-";var o=k.substring(n,k.length);h.splice(j,0,o),g.push(i),i=""}else g.push(i),i=k+" "}return g.push(i),g},this.insertAlpha=function(a,b){var c=a;if(a.length==7||a.length==4)a=a.substring(1);if(a.length==6){var d=a.substring(0,2),e=a.substring(2,4),f=a.substring(4,6);c="rgba("+parseInt(d,16)+", "+parseInt(e,16)+", "+parseInt(f,16)+", "+b+")"}else if(a.length==3){var d=a.substring(0,1)+"f",e=a.substring(1,2)+"f",f=a.substring(2,3)+"f";c="rgba("+parseInt(d,16)+", "+parseInt(e,16)+", "+parseInt(f,16)+", "+b+")"}else c=a.split(")").join(", "+b+")");return c},this.drawResourceAndAgents=function(a,b){var c=a||"#resourceCanvas",d=Lifecycle.currentWorld,e=d.resources,f=d.getCurrentAgents(),g=Date.now(),h=FiercePlanet.Orientation.cellsAcross,i=$(c)[0],j=i.getContext("2d");j.save(),j.translate(FiercePlanet.Orientation.halfWorldWidth,FiercePlanet.Orientation.halfWorldHeight),j.rotate(FiercePlanet.Orientation.rotationAngle),this.clearAgentsInline(j);if((Universe.settings.isometricView||d.isometricView)&&e.length>0){var k=_.union(e,f).sort(function(a,b){return a.y*h-a.x>b.y*h-b.x?1:a.y*h-a.x<b.y*h-b.x?-1:0});for(var l=0;l<k.length;l+=1){var m=k[l];if(/(\w+)\(/.exec(m.constructor.toString())[1]=="Resource")FiercePlanet.Drawing.drawJustResource(j,m);else{var n=m.x,o=m.y,p=d.getNeighbouringResources(n,o);p.forEach(function(a){FiercePlanet.Drawing.drawResourceAgentInteraction(j,a,m)}),FiercePlanet.Drawing.drawAgent(j,m)}}}else e.forEach(function(a){FiercePlanet.Drawing.drawJustResource(j,a)}),f.forEach(function(a){var b=a.x,c=a.y,e=d.getNeighbouringResources(b,c);e.forEach(function(b){FiercePlanet.Drawing.drawResourceAgentInteraction(j,b,a)}),FiercePlanet.Drawing.drawAgent(j,a)});j.restore()},this.drawResources=function(a,b){var c=a||"#resourceCanvas",d=b||Lifecycle.currentWorld.resources;if((Universe.settings.isometricView||Lifecycle.currentWorld.isometricView)&&Universe.settings.showResourcesAsBoxes){this.clearCanvas(c);var e=FiercePlanet.Orientation.cellsAcross;d.sort(function(a,b){return a.y*e-a.x>b.y*e-b.x?1:a.y*e-a.x<b.y*e-b.x?-1:0})}var f=$(c)[0],g=f.getContext("2d");g.save(),g.translate(FiercePlanet.Orientation.halfWorldWidth,FiercePlanet.Orientation.halfWorldHeight),g.rotate(FiercePlanet.Orientation.rotationAngle);for(var h=0;h<d.length;h+=1){var i=d[h],j=i.x*FiercePlanet.Orientation.cellWidth,k=i.y*FiercePlanet.Orientation.cellHeight,l=i.totalYield/i.initialTotalYield*100,m=i.color,n=this.diluteColour(l,l,l,m),o=FiercePlanet.Orientation.cellHeight*(1-l/100)/1.2|0;o=o*FiercePlanet.Orientation.zoomWorld;var p=-FiercePlanet.Orientation.halfWorldWidth*FiercePlanet.Orientation.zoomWorld+j*FiercePlanet.Orientation.zoomWorld,q=-FiercePlanet.Orientation.halfWorldHeight*FiercePlanet.Orientation.zoomWorld+k*FiercePlanet.Orientation.zoomWorld+o,r=-FiercePlanet.Orientation.halfWorldHeight*FiercePlanet.Orientation.zoomWorld+k*FiercePlanet.Orientation.zoomWorld+FiercePlanet.Orientation.cellHeight*FiercePlanet.Orientation.zoomWorld,s=g.createLinearGradient(p,q,p,r);s.addColorStop(0,"#fff"),s.addColorStop(.5,m),s.addColorStop(1,m);if(Universe.settings.isometricView||Lifecycle.currentWorld.isometricView){var t=FiercePlanet.Isometric.offsets3DPoint([FiercePlanet.Orientation.cellHeight,0,0]),u=FiercePlanet.Isometric.doIsometricOffset(i.x,i.y),v=u.x+FiercePlanet.Orientation.cellWidth/2,w=u.y+FiercePlanet.Orientation.cellHeight;v=(v-FiercePlanet.Orientation.halfWorldWidth)*FiercePlanet.Orientation.zoomWorld,w=(w-FiercePlanet.Orientation.halfWorldHeight)*FiercePlanet.Orientation.zoomWorld,g.fillStyle="#fff",FiercePlanet.Isometric.draw3DTile(g,[v,w],FiercePlanet.Orientation.cellHeight*FiercePlanet.Orientation.zoomWorld),g.fill();var x=0;g.lineWidth=1/FiercePlanet.Orientation.zoomWorld,Universe.settings.showResourcesAsBoxes?(x=l/100*20,g.fillStyle=m,g.strokeStyle="#eee",FiercePlanet.Isometric.box(g,v,w,0,0,0,FiercePlanet.Orientation.cellHeight,x,FiercePlanet.Orientation.cellHeight),g.fill(),g.stroke()):(s=g.createLinearGradient(v,w-FiercePlanet.Orientation.cellHeight+o,v,w),s.addColorStop(0,"#fff"),s.addColorStop(.5,m),s.addColorStop(1,m),g.fillStyle=s,FiercePlanet.Isometric.draw3DTile(g,[v,w],FiercePlanet.Orientation.cellHeight),g.fill());if(i.kind.image){var y=v-t.x/2,z=w+t.y/2-x;try{g.drawImage(i.kind.actualImage,y,z,t.x,t.y)}catch(A){}}}else{j=(j-FiercePlanet.Orientation.halfWorldWidth)*FiercePlanet.Orientation.zoomWorld,k=(k-FiercePlanet.Orientation.halfWorldHeight)*FiercePlanet.Orientation.zoomWorld,g.clearRect(j,k,FiercePlanet.Orientation.cellWidth*FiercePlanet.Orientation.zoomWorld,FiercePlanet.Orientation.cellHeight*FiercePlanet.Orientation.zoomWorld),g.fillStyle="#fff",g.fillRect(j,k,FiercePlanet.Orientation.cellWidth*FiercePlanet.Orientation.zoomWorld,FiercePlanet.Orientation.cellHeight*FiercePlanet.Orientation.zoomWorld),g.fillStyle=s,g.strokeStyle="#333",g.fillRect(j,k+o,FiercePlanet.Orientation.cellWidth*FiercePlanet.Orientation.zoomWorld,FiercePlanet.Orientation.cellHeight*FiercePlanet.Orientation.zoomWorld-o),g.lineWidth=4/FiercePlanet.Orientation.zoomWorld,g.strokeStyle=n;if(i.kind.image)try{g.drawImage(i.kind.actualImage,j+4,k+4,FiercePlanet.Orientation.cellWidth*FiercePlanet.Orientation.zoomWorld-8,FiercePlanet.Orientation.cellHeight*FiercePlanet.Orientation.zoomWorld-8)}catch(A){}}}g.restore()},this.drawResource=function(a,b){var c=b||"#resourceCanvas",d=$(c)[0],e=d.getContext("2d");e.save(),e.translate(FiercePlanet.Orientation.halfWorldWidth,FiercePlanet.Orientation.halfWorldHeight),e.rotate(FiercePlanet.Orientation.rotationAngle);var f=a.x*FiercePlanet.Orientation.cellWidth,g=a.y*FiercePlanet.Orientation.cellHeight,h=a.totalYield/a.initialTotalYield*100,i=a.color,j=this.diluteColour(h,h,h,i),k=FiercePlanet.Orientation.cellHeight*(1-h/100)/1.2|0;k=k*FiercePlanet.Orientation.zoomWorld;var l=-FiercePlanet.Orientation.halfWorldWidth*FiercePlanet.Orientation.zoomWorld+f*FiercePlanet.Orientation.zoomWorld,m=-FiercePlanet.Orientation.halfWorldHeight*FiercePlanet.Orientation.zoomWorld+g*FiercePlanet.Orientation.zoomWorld+k,n=-FiercePlanet.Orientation.halfWorldHeight*FiercePlanet.Orientation.zoomWorld+g*FiercePlanet.Orientation.zoomWorld+FiercePlanet.Orientation.cellHeight*FiercePlanet.Orientation.zoomWorld,o=e.createLinearGradient(l,m,l,n);o.addColorStop(0,"#fff"),o.addColorStop(.5,i),o.addColorStop(1,i);if(Universe.settings.isometricView||Lifecycle.currentWorld.isometricView){var p=FiercePlanet.Isometric.offsets3DPoint([FiercePlanet.Orientation.cellHeight,0,0]),q=FiercePlanet.Isometric.doIsometricOffset(a.x,a.y),r=q.x+FiercePlanet.Orientation.cellWidth/2,s=q.y+FiercePlanet.Orientation.cellHeight;r=(r-FiercePlanet.Orientation.halfWorldWidth)*FiercePlanet.Orientation.zoomWorld,s=(s-FiercePlanet.Orientation.halfWorldHeight)*FiercePlanet.Orientation.zoomWorld,e.fillStyle="#fff",FiercePlanet.Isometric.draw3DTile(e,[r,s],FiercePlanet.Orientation.cellHeight*FiercePlanet.Orientation.zoomWorld),e.fill();var t=0;e.lineWidth=1,Universe.settings.showResourcesAsBoxes?(t=h/100*20,e.fillStyle=i,e.strokeStyle="#eee",FiercePlanet.Isometric.box(e,r,s,0,0,0,FiercePlanet.Orientation.cellHeight,t,FiercePlanet.Orientation.cellHeight),e.fill(),e.stroke()):(o=e.createLinearGradient(r,s-FiercePlanet.Orientation.cellHeight+k,r,s),o.addColorStop(0,"#fff"),o.addColorStop(.5,i),o.addColorStop(1,i),e.fillStyle=o,FiercePlanet.Isometric.draw3DTile(e,[r,s],FiercePlanet.Orientation.cellHeight),e.fill());if(a.kind.image){var u=r-p.x/2,v=s+p.y/2-t;e.drawImage(a.kind.actualImage,u,v,p.x,p.y)}}else f=(f-FiercePlanet.Orientation.halfWorldWidth)*FiercePlanet.Orientation.zoomWorld,g=(g-FiercePlanet.Orientation.halfWorldHeight)*FiercePlanet.Orientation.zoomWorld,e.clearRect(f,g,FiercePlanet.Orientation.cellWidth*FiercePlanet.Orientation.zoomWorld,FiercePlanet.Orientation.cellHeight*FiercePlanet.Orientation.zoomWorld),e.fillStyle="#fff",e.fillRect(f,g,FiercePlanet.Orientation.cellWidth*FiercePlanet.Orientation.zoomWorld,FiercePlanet.Orientation.cellHeight*FiercePlanet.Orientation.zoomWorld),e.fillStyle=o,e.strokeStyle="#333",e.fillRect(f,g+k,FiercePlanet.Orientation.cellWidth*FiercePlanet.Orientation.zoomWorld,FiercePlanet.Orientation.cellHeight*FiercePlanet.Orientation.zoomWorld-k),e.lineWidth=4,e.strokeStyle=j,a.kind.image&&e.drawImage(a.kind.actualImage,f+4,g+4,FiercePlanet.Orientation.cellWidth*FiercePlanet.Orientation.zoomWorld-8,FiercePlanet.Orientation.cellHeight*FiercePlanet.Orientation.zoomWorld-8);e.restore()},this.drawJustResource=function(a,b){var c=Lifecycle.currentWorld,d=b.x*FiercePlanet.Orientation.cellWidth,e=b.y*FiercePlanet.Orientation.cellHeight,f=c.ignoreResourceLevels?100:b.totalYield/b.initialTotalYield*100,g=b.color,h=this.diluteColour(f,f,f,g),i=FiercePlanet.Orientation.cellHeight*(1-f/100)/1.2|0;i=i*FiercePlanet.Orientation.zoomWorld;var j=-FiercePlanet.Orientation.halfWorldWidth*FiercePlanet.Orientation.zoomWorld+d*FiercePlanet.Orientation.zoomWorld,k=-FiercePlanet.Orientation.halfWorldHeight*FiercePlanet.Orientation.zoomWorld+e*FiercePlanet.Orientation.zoomWorld+i,l=-FiercePlanet.Orientation.halfWorldHeight*FiercePlanet.Orientation.zoomWorld+e*FiercePlanet.Orientation.zoomWorld+FiercePlanet.Orientation.cellHeight*FiercePlanet.Orientation.zoomWorld,m=a.createLinearGradient(j,k,j,l);m.addColorStop(0,"#fff"),m.addColorStop(.5,g),m.addColorStop(1,g);if(Universe.settings.isometricView||Lifecycle.currentWorld.isometricView){var n=FiercePlanet.Isometric.offsets3DPoint([FiercePlanet.Orientation.cellHeight,0,0]),o=FiercePlanet.Isometric.doIsometricOffset(b.x,b.y),p=o.x+FiercePlanet.Orientation.cellWidth/2,q=o.y+FiercePlanet.Orientation.cellHeight;p=(p-FiercePlanet.Orientation.halfWorldWidth)*FiercePlanet.Orientation.zoomWorld,q=(q-FiercePlanet.Orientation.halfWorldHeight)*FiercePlanet.Orientation.zoomWorld,a.fillStyle="#fff",FiercePlanet.Isometric.draw3DTile(a,[p,q],FiercePlanet.Orientation.cellHeight*FiercePlanet.Orientation.zoomWorld),a.fill();var r=0;a.lineWidth=1,Universe.settings.showResourcesAsBoxes?(r=f/100*20*FiercePlanet.Orientation.zoomWorld,a.fillStyle=g,a.strokeStyle="#eee",FiercePlanet.Isometric.box(a,p,q,0,0,0,FiercePlanet.Orientation.cellHeight*FiercePlanet.Orientation.zoomWorld,r,FiercePlanet.Orientation.cellHeight*FiercePlanet.Orientation.zoomWorld),a.fill(),a.stroke()):(m=a.createLinearGradient(p,q-FiercePlanet.Orientation.cellHeight+i,p,q),m.addColorStop(0,"#fff"),m.addColorStop(.5,g),m.addColorStop(1,g),a.fillStyle=m,FiercePlanet.Isometric.draw3DTile(a,[p,q],FiercePlanet.Orientation.cellHeight),a.fill());if(b.kind.image){var s=p-n.x/2,t=q+n.y/2-r;try{a.drawImage(b.kind.actualImage,s,t,n.x,n.y)}catch(u){}}}else{d=(d-FiercePlanet.Orientation.halfWorldWidth)*FiercePlanet.Orientation.zoomWorld,e=(e-FiercePlanet.Orientation.halfWorldHeight)*FiercePlanet.Orientation.zoomWorld,a.clearRect(d,e,FiercePlanet.Orientation.cellWidth*FiercePlanet.Orientation.zoomWorld,FiercePlanet.Orientation.cellHeight*FiercePlanet.Orientation.zoomWorld),a.fillStyle="#fff",a.fillRect(d,e,FiercePlanet.Orientation.cellWidth*FiercePlanet.Orientation.zoomWorld,FiercePlanet.Orientation.cellHeight*FiercePlanet.Orientation.zoomWorld),a.fillStyle=m,a.strokeStyle="#333",a.fillRect(d,e+i,FiercePlanet.Orientation.cellWidth*FiercePlanet.Orientation.zoomWorld,FiercePlanet.Orientation.cellHeight*FiercePlanet.Orientation.zoomWorld-i),a.lineWidth=4,a.strokeStyle=h;if(b.kind.image)try{a.drawImage(b.kind.actualImage,d+4,e+4,FiercePlanet.Orientation.cellWidth*FiercePlanet.Orientation.zoomWorld-8,FiercePlanet.Orientation.cellHeight*FiercePlanet.Orientation.zoomWorld-8)}catch(u){}}},this.drawResourceAgentInteraction=function(a,b,c){var d=b.x*FiercePlanet.Orientation.cellWidth+FiercePlanet.Orientation.cellWidth/2,e=b.y*FiercePlanet.Orientation.cellHeight+FiercePlanet.Orientation.cellHeight/2,f=c.wanderX,g=c.wanderY,h=this.getDrawingPosition(c,Lifecycle.waveCounter),i=h.intX,j=h.intY;if(Math.abs(i-b.x)>1||Math.abs(j-b.y)>1)return;var k=i*FiercePlanet.Orientation.cellWidth+f+FiercePlanet.Orientation.cellWidth/2,l=j*FiercePlanet.Orientation.cellHeight+g+FiercePlanet.Orientation.cellHeight/4;if(Universe.settings.isometricView||Lifecycle.currentWorld.isometricView){var m=FiercePlanet.Isometric.doIsometricOffset(b.x,b.y);d=m.x+FiercePlanet.Orientation.cellWidth/2,e=m.y+FiercePlanet.Orientation.cellHeight/2;var n=FiercePlanet.Isometric.doIsometricOffset(i,j);k=n.x+f+FiercePlanet.Orientation.cellWidth/2,l=n.y+g+FiercePlanet.Orientation.cellHeight/4}d=(d-FiercePlanet.Orientation.halfWorldWidth)*FiercePlanet.Orientation.zoomWorld,e=(e-FiercePlanet.Orientation.halfWorldHeight)*FiercePlanet.Orientation.zoomWorld,k=(k-FiercePlanet.Orientation.halfWorldWidth)*FiercePlanet.Orientation.zoomWorld,l=(l-FiercePlanet.Orientation.halfWorldHeight)*FiercePlanet.Orientation.zoomWorld;var o=b.totalYield/b.initialTotalYield*100,p=one.color(b.color),q=c.getHealthForResourceCategory(b.category),r=one.color(b.color).alpha(q/100),s=one.color(b.color).alpha(0),t=FiercePlanet.Orientation.cellWidth/5*FiercePlanet.Orientation.zoomWorld,u=FiercePlanet.Orientation.cellHeight*FiercePlanet.Orientation.zoomWorld,v=a.createRadialGradient(k,l,0,k,l,t);v.addColorStop(1,s.cssa()),v.addColorStop(.5,r.cssa()),v.addColorStop(0,p.cssa()),a.fillStyle=v,a.beginPath(),a.arc(k,l,t,0,Math.PI*2,!0),a.closePath(),a.fill()},this.diluteColour=function(a,b,c,d){d=d||"fff";var e=d.length==3?1:2,f=e==1?1:16,g=10,h=Math.pow(16,e),i=parseInt(d.slice(0,1*e),16),j=parseInt(d.slice(1*e,2*e),16),k=parseInt(d.slice(2*e,3*e),16),l=Math.floor((100-a)/100*(h-i)),m=Math.floor((100-b)/100*(h-j)),n=Math.floor((100-c)/100*(h-k)),o=(i+l<h?i+l:h-1).toString(16),p=(j+m<h?j+m:h-1).toString(16),q=(k+n<h?k+n:h-1).toString(16);o=o.length<e?o+"0":o,p=p.length<e?p+"0":p,q=q.length<e?q+"0":q;var r="#"+o+p+q;return one.color(r).hex()},this.getAgentDirection=function(a){var b=a.lastMemory.x,c=a.lastMemory.y,d=a.x,e=a.y;return b<d?0:1},this.getDrawingPosition=function(a,b){var c=a.lastMemory.x,d=a.lastMemory.y,e=a.x,f=a.y,g=a.wanderX,h=a.wanderY,i=a.speed,j=a.delay,k=a.countdownToMove,l=(i-(b-a.delay)%i)/i,m=(i-k)/i,n=(e-c)*m,o=(f-d)*m,p=e-n,q=f-o;if(Lifecycle.currentWorld.allowOffscreenCycling){var r=m<.5;e==FiercePlanet.Orientation.cellsAcross-1&&c==0?r?(n=(e-FiercePlanet.Orientation.cellsAcross)*m,p=e-n):(n=1-m,p=n):e==0&&c==FiercePlanet.Orientation.cellsAcross-1?r?(n=m,p=0-n):(n=(FiercePlanet.Orientation.cellsAcross-c)*m,p=FiercePlanet.Orientation.cellsAcross-n):f==FiercePlanet.Orientation.cellsDown-1&&d==0?r?(o=(f-FiercePlanet.Orientation.cellsDown)*m,q=f-o):(o=1-m,q=o):f==0&&d==FiercePlanet.Orientation.cellsDown-1&&(r?(o=m,q=0-o):(o=(FiercePlanet.Orientation.cellsDown-d)*m,q=FiercePlanet.Orientation.cellsDown-o))}return{intX:p,intY:q}},this.drawAgents=function(altCanvasName,altAgents){var canvasName=altCanvasName||"#agentCanvas",canvas=$(canvasName)[0],ctx=canvas.getContext("2d"),midTilePosX=FiercePlanet.Orientation.worldWidth/2,midTilePosY=FiercePlanet.Orientation.worldHeight/2;ctx.save(),ctx.translate(midTilePosX,midTilePosY),ctx.rotate(FiercePlanet.Orientation.rotationAngle);var agents=altAgents||Lifecycle.currentWorld.currentAgents;for(var i=0;i<agents.length;i+=1){var agent=agents[i],wx=agent.wanderX,wy=agent.wanderY,__ret=this.getDrawingPosition(agent,Lifecycle.waveCounter),xPos=__ret.intX,yPos=__ret.intY,x=xPos*FiercePlanet.Orientation.cellWidth+wx,y=yPos*FiercePlanet.Orientation.cellHeight+wy;if(Universe.settings.isometricView||Lifecycle.currentWorld.isometricView){var newOrigin=FiercePlanet.Isometric.doIsometricOffset(xPos,yPos);x=newOrigin.x+wx,y=newOrigin.y+wy}x=(x-FiercePlanet.Orientation.halfWorldWidth)*FiercePlanet.Orientation.zoomWorld,y=(y-FiercePlanet.Orientation.halfWorldHeight)*FiercePlanet.Orientation.zoomWorld;var direction=this.getAgentDirection(agent),blueH=agent.healthCategoryStats[ModuleManager.currentModule.resourceSet.categories[0].code],greenH=agent.healthCategoryStats[ModuleManager.currentModule.resourceSet.categories[1].code],redH=agent.healthCategoryStats[ModuleManager.currentModule.resourceSet.categories[2].code],c=agent.color.toString(),newColor=this.diluteColour(redH,greenH,blueH,c);try{eval(agent.culture.drawFunction)(ctx,agent,x,y,FiercePlanet.Orientation.pieceWidth,FiercePlanet.Orientation.pieceHeight,newColor,Lifecycle.waveCounter,direction)}catch(e){eval(DefaultCultures.CITIZEN_AGENT_TYPE.drawFunction)(ctx,agent,x,y,FiercePlanet.Orientation.pieceWidth,FiercePlanet.Orientation.pieceHeight,newColor,Lifecycle.waveCounter,direction)}}ctx.restore()},this.drawAgent=function(ctx,agent){var wx=agent.wanderX,wy=agent.wanderY,__ret=this.getDrawingPosition(agent,Lifecycle.waveCounter),xPos=__ret.intX,yPos=__ret.intY,x=xPos*FiercePlanet.Orientation.cellWidth+wx+(FiercePlanet.Orientation.cellWidth/2-FiercePlanet.Orientation.pieceWidth/2),y=yPos*FiercePlanet.Orientation.cellHeight+wy+FiercePlanet.Orientation.cellHeight/4;if(Universe.settings.isometricView||Lifecycle.currentWorld.isometricView){var newOrigin=FiercePlanet.Isometric.doIsometricOffset(xPos,yPos);x=newOrigin.x+wx+(FiercePlanet.Orientation.cellWidth/2-FiercePlanet.Orientation.pieceWidth/2),y=newOrigin.y+wy+FiercePlanet.Orientation.cellHeight/4}x=(x-FiercePlanet.Orientation.halfWorldWidth)*FiercePlanet.Orientation.zoomWorld,y=(y-FiercePlanet.Orientation.halfWorldHeight)*FiercePlanet.Orientation.zoomWorld;var direction=this.getAgentDirection(agent),newColor=agent.color||"fff";try{eval(agent.culture.drawFunction)(ctx,agent,x,y,FiercePlanet.Orientation.pieceWidth*FiercePlanet.Orientation.zoomWorld,FiercePlanet.Orientation.pieceHeight*FiercePlanet.Orientation.zoomWorld,newColor,Lifecycle.waveCounter,direction)}catch(e){eval(DefaultCultures.CITIZEN_AGENT_TYPE.drawFunction)(ctx,agent,x,y,FiercePlanet.Orientation.pieceWidth*FiercePlanet.Orientation.zoomWorld,FiercePlanet.Orientation.pieceHeight*FiercePlanet.Orientation.zoomWorld,newColor,Lifecycle.waveCounter,direction)}},this.drawExpiredAgent=function(a,b){var c=b||"#resourceCanvas",d=$(c)[0],e=d.getContext("2d");e.save(),e.translate(FiercePlanet.Orientation.halfWorldWidth,FiercePlanet.Orientation.halfWorldHeight),e.rotate(FiercePlanet.Orientation.rotationAngle),a.color=one.color("#f00"),FiercePlanet.Drawing.drawAgent(e,a),e.restore()},this.clearResource=function(a){if(Universe.settings.isometricView||Lifecycle.currentWorld.isometricView)FiercePlanet.Drawing.drawResources();else{var b=$("#resourceCanvas")[0],c=b.getContext("2d"),d=FiercePlanet.Orientation.worldWidth/2,e=FiercePlanet.Orientation.worldHeight/2,f=a.x*FiercePlanet.Orientation.cellWidth,g=a.y*FiercePlanet.Orientation.cellHeight;c.save(),c.translate(d,e),c.rotate(FiercePlanet.Orientation.rotationAngle),f=(f-FiercePlanet.Orientation.halfWorldWidth)*FiercePlanet.Orientation.zoomWorld,g=(g-FiercePlanet.Orientation.halfWorldHeight)*FiercePlanet.Orientation.zoomWorld,c.clearRect(f,g,FiercePlanet.Orientation.cellWidth,FiercePlanet.Orientation.cellHeight),c.restore()}},this.clearCanvas=function(a){var b=$(a)[0],c=b.getContext("2d"),d=b.width,e=b.height;c.clearRect(-d,-e,3*d,3*e)},this.clearTheseAgents=function(a){var b="#resourceCanvas",c=Lifecycle.currentWorld,d=FiercePlanet.Orientation.cellsAcross,e=$(b)[0],f=e.getContext("2d");f.save(),f.translate(FiercePlanet.Orientation.halfWorldWidth,FiercePlanet.Orientation.halfWorldHeight),f.rotate(FiercePlanet.Orientation.rotationAngle),this.clearAgentsInline(f,a),f.restore()},this.clearThisAgent=function(a){var b="#resourceCanvas",c=Lifecycle.currentWorld,d=FiercePlanet.Orientation.cellsAcross,e=$(b)[0],f=e.getContext("2d");f.save(),f.translate(FiercePlanet.Orientation.halfWorldWidth,FiercePlanet.Orientation.halfWorldHeight),f.rotate(FiercePlanet.Orientation.rotationAngle),this.clearAgentInline(f,a),f.restore()},this.clearAgents=function(a){this.clearAgentGroup(a,Lifecycle.currentWorld.currentAgents)},this.clearAgentGroup=function(a,b){var c=FiercePlanet.Orientation.worldWidth/2,d=FiercePlanet.Orientation.worldHeight/2;a.save(),a.translate(c,d),a.rotate(FiercePlanet.Orientation.rotationAngle);if(Lifecycle.waveCounter>0)for(var e=0;e<b.length;e+=1){var f=b[e],g=f.wanderX,h=f.wanderY,i=this.getDrawingPosition(f,Lifecycle.waveCounter-1),j=i.intX,k=i.intY,l=j*FiercePlanet.Orientation.cellWidth+g+1,m=k*FiercePlanet.Orientation.cellHeight+h+1;if(Universe.settings.isometricView||Lifecycle.currentWorld.isometricView){var n=FiercePlanet.Isometric.doIsometricOffset(j,k);l=n.x+g+1,m=n.y+h+1}l=l-FiercePlanet.Orientation.worldWidth/2,m=m-FiercePlanet.Orientation.worldHeight/2,a.clearRect(l,m,FiercePlanet.Orientation.cellWidth+g+1,FiercePlanet.Orientation.cellHeight+h+1),Universe.settings.agentTracing&&(a.beginPath(),a.arc(l+FiercePlanet.Orientation.cellWidth/2,m+FiercePlanet.Orientation.cellHeight*1.2,2,0,Math.PI*2,!1),a.closePath(),a.strokeStyle="#000",a.stroke(),a.fillStyle="#000",a.fill())}a.restore()},this.clearAgentsInline=function(a,b){if(Lifecycle.worldCounter>0){var b=b||Lifecycle.currentWorld.currentAgents;for(var c=0;c<b.length;c+=1){var d=b[c];FiercePlanet.Drawing.clearAgentInline(a,d)}}},this.clearAgentInline=function(a,b){if(Lifecycle.worldCounter>0){var c=b.wanderX,d=b.wanderY,e=this.getDrawingPosition(b,Lifecycle.waveCounter-1),f=e.intX,g=e.intY,h=f*FiercePlanet.Orientation.cellWidth+c+1,i=g*FiercePlanet.Orientation.cellHeight+d+1;if(Universe.settings.isometricView||Lifecycle.currentWorld.isometricView){var j=FiercePlanet.Isometric.doIsometricOffset(f,g);h=j.x+c+1,i=j.y+d+1}h=(h-FiercePlanet.Orientation.halfWorldWidth)*FiercePlanet.Orientation.zoomWorld,i=(i-FiercePlanet.Orientation.halfWorldHeight)*FiercePlanet.Orientation.zoomWorld,a.clearRect(h,i-17,FiercePlanet.Orientation.cellWidth+c+1,FiercePlanet.Orientation.cellHeight+d+1+17)}},this.drawScrollingLayer=function(a){if(Universe.settings.scrollingImageVisible){var b=a||"#scrollingCanvas";this.clearCanvas(b);var c=$(b)[0],d=c.getContext("2d");if(Universe.settings.catastrophesVisible&&Lifecycle.currentWorld.catastrophe!=undefined){var e=Lifecycle.currentWorld.catastrophe;e.notice.start<=Lifecycle.worldCounter&&e.start+e.duration>=Lifecycle.worldCounter&&(FiercePlanet.Game.currentNotice=e.notice);if(e.start<=FiercePlanet.worldCounter&&e.start+e.duration>=Lifecycle.worldCounter){FiercePlanet.worldCounter>=e.start+e.duration/2&&e.strike();var f=e.duration/FiercePlanet.Orientation.worldWidth,g=(Lifecycle.worldCounter-e.start)/f*2,h=(e.start+e.duration-Lifecycle.worldCounter)/f*2,i=FiercePlanet.Orientation.worldWidth-g,j=0,k=h,l=FiercePlanet.Orientation.worldHeight;d.fillStyle=this.insertAlpha(e.kind.color,.5),d.fillRect(i,j,k,l)}}}},this.drawWorld=function(){var a=$("#world-display")[0];a.innerHTML=Lifecycle.currentWorld.id},this.drawProfileClass=function(){var a=$("#profile-class-display")[0];a!=undefined&&(a.innerHTML=FiercePlanet.Game.currentProfile.profileClass)},this.drawScore=function(){var a=$("#score-display")[0];a.innerHTML=FiercePlanet.Utils.zeroFill(FiercePlanet.Game.currentProfile.currentScore,5)},this.drawHighestScore=function(){var a=$("#highest-score-display")[0],b=FiercePlanet.Game.currentProfile.highestScore;b==undefined&&(b=0),a.innerHTML=b.toString()},this.drawResourcesInStore=function(){var a=$("#goodness-display")[0];a.innerHTML=FiercePlanet.Game.currentProfile.currentWorldResourcesInStore.toString()},this.drawExpired=function(){var a=$("#expired-citizens")[0],b="";for(var c=0,d=Lifecycle.currentWorld.expiryLimit;c<d;c++)c<FiercePlanet.Game.currentProfile.currentWorldExpired?b+='<div id="expired-citizen"></div>':b+='<div id="healthy-citizen"></div>';a.innerHTML=b},this.drawSaved=function(){var a=$("#saved-display")[0],b=FiercePlanet.Game.currentProfile.currentWorldSaved.toString(),c=Lifecycle.currentWorld.getTotalSaveableAgents();a.innerHTML=b+" out of "+c},this.drawWaves=function(){var a=$("#waves-display")[0];a.innerHTML=Lifecycle.currentWaveNumber+" out of "+Lifecycle.currentWorld.waveNumber},this.drawScoreboard=function(){this.drawWorld(),this.drawScore(),this.drawHighestScore(),this.drawWaves(),this.drawSaved(),this.drawExpired(),this.drawResourcesInStore()},this.drawThumbnail=function(){var a=$("#imageCanvas")[0],b=$("#baseCanvas")[0],c=$("#resourceCanvas")[0],d=$("#scrollingCanvas")[0],e=$("#noticeCanvas")[0],f=$("#agentCanvas")[0];a.getContext("2d").drawImage(b,0,0),a.getContext("2d").drawImage(c,0,0),a.getContext("2d").drawImage(d,0,0),a.getContext("2d").drawImage(e,0,0),a.getContext("2d").drawImage(f,0,0);var g=a.toDataURL();$.post("/worlds/"+Lifecycle.currentWorld.id+"/save_thumbnail",{thumbnail:g},function(a){alert("data posted")})},this.drawGuideCell=function(a){var b=a.pageX-FiercePlanet.Dialogs.calculateWorldLeft(),c=a.pageY-FiercePlanet.Dialogs.calculateWorldTop(),d=FiercePlanet.GeneralUI.getCurrentPositionByCoordinates(b,c),e=d.posX,f=d.posY;this.clearGuide();if(e<0||e>=FiercePlanet.Orientation.cellsAcross||f<0||f>=FiercePlanet.Orientation.cellsDown)return;if(Lifecycle.currentWorld.getCell(e,f).agentsAllowed&&!Universe.settings.allowResourcesOnPath)return;var g=$("#guideCanvas")[0],h=g.getContext("2d");h.save(),h.translate(FiercePlanet.Orientation.halfWorldWidth,FiercePlanet.Orientation.halfWorldHeight),h.rotate(FiercePlanet.Orientation.rotationAngle),b=e*FiercePlanet.Orientation.cellWidth*FiercePlanet.Orientation.zoomWorld,c=f*FiercePlanet.Orientation.cellHeight*FiercePlanet.Orientation.zoomWorld;if(Universe.settings.isometricView||Lifecycle.currentWorld.isometricView){var i=FiercePlanet.Isometric.doIsometricOffset(e,f),j=i.x+FiercePlanet.Orientation.cellWidth/2,k=i.y+FiercePlanet.Orientation.cellHeight;j=j-FiercePlanet.Orientation.halfWorldWidth*FiercePlanet.Orientation.zoomWorld,k=k-FiercePlanet.Orientation.halfWorldHeight*FiercePlanet.Orientation.zoomWorld,FiercePlanet.Isometric.draw3DTile(h,[j,k],FiercePlanet.Orientation.cellHeight*FiercePlanet.Orientation.zoomWorld),h.lineWidth=4,h.strokeStyle="#f00",h.stroke()}else b=b-FiercePlanet.Orientation.halfWorldWidth*FiercePlanet.Orientation.zoomWorld,c=c-FiercePlanet.Orientation.halfWorldHeight*FiercePlanet.Orientation.zoomWorld,h.lineWidth=4,h.strokeStyle="#f00",h.strokeRect(b,c,FiercePlanet.Orientation.cellWidth*FiercePlanet.Orientation.zoomWorld,FiercePlanet.Orientation.cellHeight*FiercePlanet.Orientation.zoomWorld);h.restore()},this.clearGuide=function(a){FiercePlanet.Drawing.clearCanvas("#guideCanvas")},this.panByDrag=function(a,b){var c=$(".scrollable-canvas");a*=FiercePlanet.Orientation.zoomWorld,b*=FiercePlanet.Orientation.zoomWorld;for(var d=0;d<c.length;d++){var e=c[d],f=e.getContext("2d");f.clearRect(0,0,e.width,e.height),f.translate(a,b)}FiercePlanet.Orientation.offsetY+=b,FiercePlanet.Orientation.offsetX+=a,FiercePlanet.Game.googleMap&&FiercePlanet.Game.googleMap.panBy(-a,-b),this.drawCanvases()},this.pan=function(a){var b=10;switch(a){case 0:this.panByDrag(0,b);break;case 1:this.panByDrag(0,-b);break;case 2:this.panByDrag(b,0);break;case 3:this.panByDrag(-b,0);break;case 4:this.panByDrag(-FiercePlanet.Orientation.offsetX/FiercePlanet.Orientation.zoomWorld,-FiercePlanet.Orientation.offsetY/FiercePlanet.Orientation.zoomWorld)}},this.zoom=function(a){var b=$(".scrollable-canvas"),c=FiercePlanet.Orientation.zoomWorld,d=c,e=!1;switch(a){case-1:FiercePlanet.Orientation.zoomWorld>.1&&(d=FiercePlanet.Orientation.zoomWorld*(1/FiercePlanet.Orientation.zoomMagnificationFactor));break;case 0:d=1;break;case 1:FiercePlanet.Orientation.zoomWorld<10&&(d=FiercePlanet.Orientation.zoomWorld*FiercePlanet.Orientation.zoomMagnificationFactor)}if(FiercePlanet.Game.googleMap){var f=FiercePlanet.Game.googleMap.getZoom(),g=d,h=Math.log(c)/Math.log(FiercePlanet.Orientation.zoomMagnificationFactor),i=Math.log(g)/Math.log(FiercePlanet.Orientation.zoomMagnificationFactor),j=i-h,k=f+j<1?f:f+j>21?f:f+j;k==f&&(d=FiercePlanet.Orientation.zoomWorld),FiercePlanet.Game.googleMap.setZoom(k)}FiercePlanet.Orientation.zoomWorld=d,this.drawCanvases()},this.animateWorld=function(){var a=$("#baseCanvas, #scrollingCanvas, #noticeCanvas"),b=$("#world-container"),c=b.position().left,d=b.position().top,e=b.width(),f=b.height(),g=c+Math.floor(Math.random()*e),h=d+Math.floor(Math.random()*f);b.css({width:0,height:0,left:g,top:h}),b.animate({width:"100%",height:"68%",left:c,top:d},1500),a.css({width:0,height:0}),a.animate({width:e,height:f},1500)},this.contract=function(){var a=FiercePlanet.Drawing.Dimensions.worldWidth,b=FiercePlanet.Drawing.Dimensions.worldHeight;_.isUndefined(FiercePlanet.Drawing.Dimensions)||($("#world-container, #world-container > *").width(FiercePlanet.Drawing.Dimensions.width),$("#world-container, #world-container > *").height(FiercePlanet.Drawing.Dimensions.height),$("#world-container").css("padding",FiercePlanet.Drawing.Dimensions.padding),$("#gameworld").css("left",FiercePlanet.Drawing.Dimensions.gameworldLeft),$("#gameworld").css("top",FiercePlanet.Drawing.Dimensions.gameworldTop),$("#controls").css("left",FiercePlanet.Drawing.Dimensions.controlsLeft),$("#controls").css("top",FiercePlanet.Drawing.Dimensions.controlsTop)),$("#global-info-panel").show(),$("#notifications, .bg").show(),Universe.settings.useInlineResourceSwatch=!1,FiercePlanet.Orientation.adjustParameters(a,b),FiercePlanet.Drawing.drawGame()},this.expand=function(){var a=$(window).width(),b=$(window).height();FiercePlanet.Drawing.Dimensions={},FiercePlanet.Drawing.Dimensions.worldWidth=FiercePlanet.Orientation.worldWidth,FiercePlanet.Drawing.Dimensions.worldHeight=FiercePlanet.Orientation.worldHeight,FiercePlanet.Drawing.Dimensions.width=$("#world-container, #world-container > *").width(),FiercePlanet.Drawing.Dimensions.height=$("#world-container, #world-container > *").height(),FiercePlanet.Drawing.Dimensions.padding=$("#world-container").css("padding"),FiercePlanet.Drawing.Dimensions.gameworldLeft=$("#gameworld").css("left"),FiercePlanet.Drawing.Dimensions.gameworldTop=$("#gameworld").css("top"),FiercePlanet.Drawing.Dimensions.controlsLeft=$("#controls").css("left"),FiercePlanet.Drawing.Dimensions.controlsTop=$("#controls").css("top"),$("#global-info-panel").hide(),$(".bg").hide(),$("#world-container").css("padding",0),$("#gameworld").css("left",0),$("#gameworld").css("top",0),$("#controls").css("left",0),$("#controls").css("top","5%"),$("#world-container, #world-container > *").width($(window).width()),$("#world-container, #world-container > *").height($(window).height()),Universe.settings.useInlineResourceSwatch=!0,FiercePlanet.Orientation.adjustParameters(a,b),FiercePlanet.Drawing.drawGame()},this.toggle3d=function(){if(Universe.settings.isometricView)Universe.settings.isometricView=!1,$("#resourceCanvas").css({zIndex:5}),$("#agentCanvas").css({zIndex:6}),FiercePlanet.Orientation.mapPerspectiveAngle-=FiercePlanet.Orientation.DEFAULT_MAP_PERSPECTIVE_ANGLE,FiercePlanet.Orientation.mapRotationAngle-=FiercePlanet.Orientation.DEFAULT_MAP_ROTATION_ANGLE,$("#map_canvas").animate({width:FiercePlanet.Orientation.worldWidth+"px",height:FiercePlanet.Orientation.worldHeight+"px",top:"1%",left:"1%"},1e3),$("#3d")[0].innerHTML="View 3D";else{Universe.settings.isometricView=!0,$("#resourceCanvas").css({zIndex:6}),$("#agentCanvas").css({zIndex:5});var a=FiercePlanet.Orientation.worldHeight/FiercePlanet.Orientation.worldWidth,b=1/a*12;FiercePlanet.Orientation.mapPerspectiveAngle+=FiercePlanet.Orientation.DEFAULT_MAP_PERSPECTIVE_ANGLE,FiercePlanet.Orientation.mapRotationAngle+=FiercePlanet.Orientation.DEFAULT_MAP_ROTATION_ANGLE,$("#map_canvas").animate({width:FiercePlanet.Orientation.worldHeight+"px",height:FiercePlanet.Orientation.worldHeight+"px",top:"1%",left:b+"%"},1e3),$("#3d")[0].innerHTML="View 2D"}FiercePlanet.Drawing.transformMap(),FiercePlanet.Drawing.drawMap(),FiercePlanet.Drawing.drawCanvases()},this.resetView=function(){FiercePlanet.Drawing.zoom(0),FiercePlanet.Drawing.panByDrag(-FiercePlanet.Orientation.offsetX/FiercePlanet.Orientation.zoomWorld,-FiercePlanet.Orientation.offsetY/FiercePlanet.Orientation.zoomWorld),FiercePlanet.Orientation.reset(),FiercePlanet.Drawing.drawGame()},this.tiltUp=function(){FiercePlanet.Drawing.tilt(-0.05)},this.tiltDown=function(){FiercePlanet.Drawing.tilt(.05)},this.tilt=function(a){FiercePlanet.Orientation.perspectiveAngle=FiercePlanet.Orientation.perspectiveAngle+a,FiercePlanet.Orientation.mapPerspectiveAngle=FiercePlanet.Orientation.mapPerspectiveAngle-a*2.15,FiercePlanet.Drawing.drawCanvases(),FiercePlanet.Drawing.transformMap()},this.rotateLeft=function(){FiercePlanet.Drawing.rotate(-Math.PI/8)},this.rotateRight=function(){FiercePlanet.Drawing.rotate(Math.PI/8)},this.rotate=function(a){FiercePlanet.Orientation.rotationAngle=FiercePlanet.Orientation.rotationAngle+a,FiercePlanet.Orientation.mapRotationAngle=FiercePlanet.Orientation.mapRotationAngle+a,FiercePlanet.Drawing.drawCanvases(),FiercePlanet.Drawing.transformMap()},this.transformMap=function(){var a=FiercePlanet.Orientation.mapRotationAngle,b=FiercePlanet.Orientation.mapPerspectiveAngle;$("#map_canvas").css({"-webkit-transform":"rotate("+a+"rad) skewX("+b+"rad) skewY("+b+"rad)","-moz-transform":"rotate("+a+"rad) skewX("+b+"rad) skewY("+b+"rad)","-o-transform":"rotate("+a+"rad) skewX("+b+"rad) skewY("+b+"rad)","-ms-transform":"rotate("+a+"rad) skewX("+b+"rad) skewY( "+b+"rad)"})}}.apply(FiercePlanet.Drawing);var FiercePlanet=FiercePlanet||{};FiercePlanet.Orientation=FiercePlanet.Orientation||{},function(){this.DEFAULT_WORLD_WIDTH=600,this.DEFAULT_WORLD_HEIGHT=400,this.DEFAULT_ROTATION_ANGLE=0,this.DEFAULT_PERSPECTIVE_ANGLE=.46365,this.DEFAULT_MAP_ROTATION_ANGLE=-0.7854,this.DEFAULT_MAP_PERSPECTIVE_ANGLE=.33161,this.worldWidth=this.DEFAULT_WORLD_WIDTH,this.worldHeight=this.DEFAULT_WORLD_HEIGHT,this.halfWorldWidth=this.worldWidth/2,this.halfWorldHeight=this.worldHeight/2,this.cellsAcross=14,this.cellsDown=11,this.cellWidth=0,this.cellHeight=0,this.pieceWidth=0,this.pieceHeight=0,this.offsetX=0,this.offsetY=0,this.zoomWorld=1,this.externalZoomWorld=1,this.zoomMagnificationFactor=1.5,this.rotationAngle=this.DEFAULT_ROTATION_ANGLE,this.perspectiveAngle=this.DEFAULT_PERSPECTIVE_ANGLE,this.mapRotationAngle=this.DEFAULT_MAP_ROTATION_ANGLE,this.mapPerspectiveAngle=this.DEFAULT_MAP_PERSPECTIVE_ANGLE,this.reset=function(){this.offsetX=0,this.offsetY=0,this.zoomWorld=1,this.externalZoomWorld=1,this.zoomMagnificationFactor=1.5,this.rotationAngle=this.DEFAULT_ROTATION_ANGLE,this.perspectiveAngle=this.DEFAULT_PERSPECTIVE_ANGLE,this.adjustParameters(this.DEFAULT_WORLD_WIDTH,this.DEFAULT_WORLD_HEIGHT)},this.initialiseParameters=function(a,b){Universe.settings.isometricView?(this.mapRotationAngle=this.DEFAULT_MAP_ROTATION_ANGLE,this.mapPerspectiveAngle=this.DEFAULT_MAP_PERSPECTIVE_ANGLE):(this.mapRotationAngle=0,this.mapPerspectiveAngle=0),this.adjustParameters(a,b)},this.recalibrateParameters=function(){this.halfWorldWidth=this.worldWidth/2,this.halfWorldHeight=this.worldHeight/2,this.cellWidth=FiercePlanet.Orientation.worldWidth/FiercePlanet.Orientation.cellsAcross,this.cellHeight=FiercePlanet.Orientation.worldHeight/FiercePlanet.Orientation.cellsDown,this.pieceWidth=this.cellWidth*.5,this.pieceHeight=this.cellHeight*.5},this.adjustParameters=function(a,b){try{this.worldWidth=parseInt(a),this.worldHeight=parseInt(b)}catch(c){Log.warn(c)}this.resizeWorld(),this.recalibrateParameters()},this.resizeWorld=function(){try{var a=$("#imageCanvas, #map_canvas,#baseCanvas, #guideCanvas, #noticeCanvas, #agentCanvas, #resourceCanvas, #scrollingCanvas");$("#map_canvas")[0].width=this.worldWidth,$("#map_canvas")[0].height=this.worldHeight,$("#baseCanvas")[0].width=this.worldWidth,$("#baseCanvas")[0].height=this.worldHeight,$("#noticeCanvas")[0].width=this.worldWidth,$("#noticeCanvas")[0].height=this.worldHeight,$("#guideCanvas")[0].width=this.worldWidth,$("#guideCanvas")[0].height=this.worldHeight,$("#agentCanvas")[0].width=this.worldWidth,$("#agentCanvas")[0].height=this.worldHeight,$("#resourceCanvas")[0].width=this.worldWidth,$("#resourceCanvas")[0].height=this.worldHeight,$("#scrollingCanvas")[0].width=this.worldWidth,$("#scrollingCanvas")[0].height=this.worldHeight,a.width(this.worldWidth),a.height(this.worldHeight),$("#actual_map").css({width:this.worldWidth*1,height:this.worldHeight*1}),!!Universe.settings.mobile}catch(b){}},this.getRotationOffset=function(a,b){var c=FiercePlanet.Orientation.halfWorldWidth,d=FiercePlanet.Orientation.halfWorldHeight,e=a-c,f=b-d,g=Math.sqrt(Math.pow(e,2)+Math.pow(f,2)),h=Math.atan2(f,e),i=h-FiercePlanet.Orientation.rotationAngle,j=c+Math.cos(i)*g,k=d+Math.sin(i)*g;return{x:j,y:k}},this.makeFullScreen=function(){fullScreenApi.supportsFullScreen&&(fullScreenApi.isFullScreen()?fullScreenApi.cancelFullScreen():fullScreenApi.requestFullScreen(document.getElementsByTagName("html")[0]))}}.apply(FiercePlanet.Orientation),FiercePlanet.Isometric=FiercePlanet.Isometric||{},function(){this.offsets3DPoint=function(a){var b=a[0],c=a[1],d=a[2],e=(b-d)*Math.cos(FiercePlanet.Orientation.perspectiveAngle),f=e,g=c+(b+d)*Math.sin(FiercePlanet.Orientation.perspectiveAngle),h=-g;return{x:f,y:h}},this.generate2DPoint=function(a,b){var c=a[0],d=a[1],e=FiercePlanet.Isometric.offsets3DPoint(b),f=e.x+c,g=e.y+d;return{x:f,y:g}},this.lineTo3DPoint=function(a,b,c){var d=FiercePlanet.Isometric.generate2DPoint(b,c);return a.lineTo(d.x,d.y),d},this.draw3DTile=function(a,b,c){var d=[c,0,0],e=[0,c,0],f=[0,0,c],g=b[0],h=b[1],i=FiercePlanet.Isometric.offsets3DPoint(d),j=-i.y*2;e=[0,j,0],a.beginPath(),a.moveTo(g,h),FiercePlanet.Isometric.lineTo3DPoint(a,b,d),FiercePlanet.Isometric.lineTo3DPoint(a,b,e),FiercePlanet.Isometric.lineTo3DPoint(a,b,f),a.lineTo(g,h),a.closePath()},this.doIsometricOffset=function(a,b){var c=(FiercePlanet.Orientation.cellsAcross-1)/2,d=(FiercePlanet.Orientation.cellsDown-1)/2,e=c*FiercePlanet.Orientation.cellWidth,f=d*FiercePlanet.Orientation.cellHeight,g=e/f,h=FiercePlanet.Orientation.cellWidth,i=FiercePlanet.Orientation.cellHeight,j=FiercePlanet.Isometric.offsets3DPoint([i,0,0]),k=j.x,l=j.y,m=k*2/h,n=l*2/(i*g),o=a*h,p=b*i,q=o-e,r=p-f,s=q-r*g,t=s*.5,u=q-t,v=-t,w=m*u,x=n*v,y=e+w,z=f-x;return{x:y,y:z}},this.normaliseCoordinates=function(a,b){var c=FiercePlanet.Isometric.offsets3DPoint([FiercePlanet.Orientation.cellHeight,0,0]),d=FiercePlanet.Orientation.worldWidth/2,e=FiercePlanet.Orientation.worldHeight/2,f=d/e,g=FiercePlanet.Orientation.cellWidth,h=FiercePlanet.Orientation.cellHeight,c=FiercePlanet.Isometric.offsets3DPoint([h,0,0]),i=c.x,j=c.y,k=i*2/g,l=-j*2/(h*f),m=a-d,n=b-e,o=m/k,p=n/l,q=o-p,r=q,s=(o+p)/f,t=d+r,u=e+s,v=t,w=u;return{x:v,y:w}},this.roundTo=function(a,b){var c=a<0,d=c?Math.ceil(a):Math.floor(a),e=a%1;return!c&&e>b?a=d+b:c&&e<-b?a=d-b:a=d,a},this.xFla=function(a,b,c,d){var e=(b-d)*Math.cos(FiercePlanet.Orientation.perspectiveAngle),f=e+a;return f},this.yFla=function(a,b,c,d){var e=c+(b+d)*Math.sin(FiercePlanet.Orientation.perspectiveAngle),f=-e+a;return f},this.style=function(a,b,c,d,e){ctx.lineWidth=a,ctx.strokeStyle=rgb(b,c,d,e)},this.plot=function(a,b,c,d,e,f){a.moveTo(FiercePlanet.Isometric.xFla(b,d,e,f),FiercePlanet.Isometric.yFla(c,d,e,f))},this.draw=function(a,b,c,d,e,f){a.lineTo(FiercePlanet.Isometric.xFla(b,d,e,f),FiercePlanet.Isometric.yFla(c,d,e,f))},this.box=function(a,b,c,d,e,f,g,h,i){a.beginPath(),FiercePlanet.Isometric.plot(a,b,c,d,e,f),FiercePlanet.Isometric.draw(a,b,c,d+g,e,f),FiercePlanet.Isometric.draw(a,b,c,d+g,e+h,f),FiercePlanet.Isometric.draw(a,b,c,d,e+h,f),FiercePlanet.Isometric.draw(a,b,c,d,e,f),FiercePlanet.Isometric.plot(a,b,c,d,e+h,f),FiercePlanet.Isometric.draw(a,b,c,d+g,e+h,f),FiercePlanet.Isometric.draw(a,b,c,d+g,e+h,f+i),FiercePlanet.Isometric.draw(a,b,c,d,e+h,f+i),FiercePlanet.Isometric.draw(a,b,c,d,e+h,f),FiercePlanet.Isometric.plot(a,b,c,d,e,f),FiercePlanet.Isometric.draw(a,b,c,d,e+h,f),FiercePlanet.Isometric.draw(a,b,c,d,e+h,f+i),FiercePlanet.Isometric.draw(a,b,c,d,e,f+i),FiercePlanet.Isometric.draw(a,b,c,d,e,f),a.closePath()},this.boxFilled=function(a,b,c,d,e,f,g,h,i){a.beginPath(),FiercePlanet.Isometric.plot(a,b,c,d,e,f),FiercePlanet.Isometric.draw(a,b,c,d+g,e,f),FiercePlanet.Isometric.draw(a,b,c,d+g,e+h,f),FiercePlanet.Isometric.draw(a,b,c,d,e+h,f),FiercePlanet.Isometric.draw(a,b,c,d,e,f),FiercePlanet.Isometric.plot(a,b,c,d,e+h,f),FiercePlanet.Isometric.draw(a,b,c,d+g,e+h,f),FiercePlanet.Isometric.draw(a,b,c,d+g,e+h,f+i),FiercePlanet.Isometric.draw(a,b,c,d,e+h,f+i),FiercePlanet.Isometric.draw(a,b,c,d,e+h,f),FiercePlanet.Isometric.plot(a,b,c,d,e,f),FiercePlanet.Isometric.draw(a,b,c,d,e+h,f),FiercePlanet.Isometric.draw(a,b,c,d,e+h,f+i),FiercePlanet.Isometric.draw(a,b,c,d,e,f+i),FiercePlanet.Isometric.draw(a,b,c,d,e,f),a.closePath()}}.apply(FiercePlanet.Isometric),function(){var a={supportsFullScreen:!1,isFullScreen:function(){return!1},requestFullScreen:function(){},cancelFullScreen:function(){},fullScreenEventName:"",prefix:""},b="webkit moz o ms khtml".split(" ");if(!_.isUndefined(document.cancelFullScreen))a.supportsFullScreen=!0;else for(var c=0,d=b.length;c<d;c++){a.prefix=b[c];if(!_.isUndefined(document[a.prefix+"CancelFullScreen"])){a.supportsFullScreen=!0;break}}a.supportsFullScreen&&(a.fullScreenEventName=a.prefix+"fullscreenchange",a.isFullScreen=function(){switch(this.prefix){case"":return document.fullScreen;case"webkit":return document.webkitIsFullScreen;default:return document[this.prefix+"FullScreen"]}},a.requestFullScreen=function(a){return this.prefix===""?a.requestFullScreen():a[this.prefix+"RequestFullScreen"]()},a.cancelFullScreen=function(a){return this.prefix===""?document.cancelFullScreen():document[this.prefix+"CancelFullScreen"]()}),_.isUndefined(jQuery)||(jQuery.fn.requestFullScreen=function(){return this.each(function(){a.supportsFullScreen&&a.requestFullScreen(this)})}),window.fullScreenApi=a}();var FiercePlanet=FiercePlanet||{};FiercePlanet.StickFigure=function(a,b,c,d,e){this.drawFigure=function(a){a.beginPath(),a.moveTo(this.hipX,this.hipY),a.lineTo(this.shoulderX,this.shoulderY),a.moveTo(this.shoulderX,this.shoulderY),a.lineTo(this.neckX,this.neckY),a.moveTo(this.headX+this.headRadius,this.headY),a.arc(this.headX,this.headY,this.headRadius,0,Math.PI*2,!1),a.moveTo(this.shoulderX,this.shoulderY),a.lineTo(this.fElbowX,this.fElbowY),a.moveTo(this.fElbowX,this.fElbowY),a.lineTo(this.fHandX,this.fHandY),a.moveTo(this.fHandX,this.fHandY),a.lineTo(this.fFingerX,this.fFingerY),a.moveTo(this.shoulderX,this.shoulderY),a.lineTo(this.bElbowX,this.bElbowY),a.moveTo(this.bElbowX,this.bElbowY),a.lineTo(this.bHandX,this.bHandY),a.moveTo(this.bHandX,this.bHandY),a.lineTo(this.bFingerX,this.bFingerY),a.moveTo(this.hipX,this.hipY),a.lineTo(this.fKneeX,this.fKneeY),a.moveTo(this.fKneeX,this.fKneeY),a.lineTo(this.fFootX,this.fFootY),a.moveTo(this.fFootX,this.fFootY),a.lineTo(this.fToeX,this.fToeY),a.moveTo(this.hipX,this.hipY),a.lineTo(this.bKneeX,this.bKneeY),a.moveTo(this.bKneeX,this.bKneeY),a.lineTo(this.bFootX,this.bFootY),a.moveTo(this.bFootX,this.bFootY),a.lineTo(this.bToeX,this.bToeY),a.closePath()},this.stand=function(a,b){b==1&&this.flipHorizontalDirection(),this.generateCoordinates()},this.run=function(a,b){switch(a){case 0:this.fShoulderAngle=this.piSeg(12),this.fElbowAngle=this.piSeg(6),this.fHandAngle=this.piSeg(7),this.bShoulderAngle=this.piSeg(3),this.bElbowAngle=this.piSeg(20),this.bHandAngle=this.piSeg(18),this.fHipAngle=this.piSeg(9),this.fKneeAngle=this.piSeg(9),this.fFootAngle=this.piSeg(5),this.bHipAngle=this.piSeg(1),this.bKneeAngle=this.piSeg(7),this.bFootAngle=this.piSeg(3);break;case 1:this.fShoulderAngle=this.piSeg(11),this.fElbowAngle=this.piSeg(6),this.fHandAngle=this.piSeg(7),this.bShoulderAngle=this.piSeg(4),this.bElbowAngle=this.piSeg(21),this.bHandAngle=this.piSeg(19),this.fHipAngle=this.piSeg(9),this.fKneeAngle=this.piSeg(14),this.fFootAngle=this.piSeg(9),this.bHipAngle=this.piSeg(3),this.bKneeAngle=this.piSeg(4),this.bFootAngle=this.piSeg(-2);break;case 2:this.fShoulderAngle=this.piSeg(9),this.fElbowAngle=this.piSeg(5),this.fHandAngle=this.piSeg(6),this.bShoulderAngle=this.piSeg(5),this.bElbowAngle=this.piSeg(1),this.bHandAngle=this.piSeg(0),this.fHipAngle=this.piSeg(6),this.fKneeAngle=this.piSeg(13),this.fFootAngle=this.piSeg(7),this.bHipAngle=this.piSeg(5),this.bKneeAngle=this.piSeg(6),this.bFootAngle=this.piSeg(0);break;case 3:this.fShoulderAngle=this.piSeg(7),this.fElbowAngle=this.piSeg(5),this.fHandAngle=this.piSeg(4),this.bShoulderAngle=this.piSeg(6),this.bElbowAngle=this.piSeg(4),this.bHandAngle=this.piSeg(3),this.fHipAngle=this.piSeg(3),this.fKneeAngle=this.piSeg(13),this.fFootAngle=this.piSeg(7),this.bHipAngle=this.piSeg(7),this.bKneeAngle=this.piSeg(8),this.bFootAngle=this.piSeg(1)}b==1&&this.flipHorizontalDirection(),this.generateCoordinates()},this.runUpsideDown=function(a,b){this.run(a,b),this.flipVerticalDirection(),this.generateCoordinates()},this.walk=function(a,b){switch(a){case 0:this.fShoulderAngle=this.piSeg(9),this.fElbowAngle=this.piSeg(8),this.fHandAngle=this.piSeg(8),this.bShoulderAngle=this.piSeg(4),this.bElbowAngle=this.piSeg(3),this.bHandAngle=this.piSeg(2),this.fHipAngle=this.piSeg(8),this.fKneeAngle=this.piSeg(9),this.fFootAngle=this.piSeg(4),this.bHipAngle=this.piSeg(4),this.bKneeAngle=this.piSeg(4),this.bFootAngle=this.piSeg(-2);break;case 1:this.fShoulderAngle=this.piSeg(8),this.fElbowAngle=this.piSeg(7),this.fHandAngle=this.piSeg(7),this.bShoulderAngle=this.piSeg(5),this.bElbowAngle=this.piSeg(4),this.bHandAngle=this.piSeg(4),this.fHipAngle=this.piSeg(7),this.fKneeAngle=this.piSeg(9),this.fFootAngle=this.piSeg(2),this.bHipAngle=this.piSeg(5),this.bKneeAngle=this.piSeg(6),this.bFootAngle=this.piSeg(0);break;case 2:this.fShoulderAngle=this.piSeg(7),this.fElbowAngle=this.piSeg(6),this.fHandAngle=this.piSeg(5),this.bShoulderAngle=this.piSeg(6),this.bElbowAngle=this.piSeg(5),this.bHandAngle=this.piSeg(5),this.fHipAngle=this.piSeg(5),this.fKneeAngle=this.piSeg(9),this.fFootAngle=this.piSeg(1),this.bHipAngle=this.piSeg(6),this.bKneeAngle=this.piSeg(7),this.bFootAngle=this.piSeg(0);break;case 3:this.fShoulderAngle=this.piSeg(5),this.fElbowAngle=this.piSeg(4),this.fHandAngle=this.piSeg(4),this.bShoulderAngle=this.piSeg(7),this.bElbowAngle=this.piSeg(7),this.bHandAngle=this.piSeg(7),this.fHipAngle=this.piSeg(4),this.fKneeAngle=this.piSeg(8),this.fFootAngle=this.piSeg(0),this.bHipAngle=this.piSeg(7),this.bKneeAngle=this.piSeg(8),this.bFootAngle=this.piSeg(1)}b==1&&this.flipHorizontalDirection(),this.generateCoordinates()},this.explode=function(a,b){switch(a){case 0:this.fShoulderAngle=this.defaultAngle,this.fElbowAngle=this.defaultAngle,this.fHandAngle=this.piSeg(12),this.bShoulderAngle=this.defaultAngle,this.bElbowAngle=this.defaultAngle,this.bHandAngle=this.piSeg(0),this.fHipAngle=this.defaultAngle,this.fKneeAngle=this.defaultAngle,this.fFootAngle=this.piSeg(12),this.bHipAngle=this.defaultAngle,this.bKneeAngle=this.defaultAngle,this.bFootAngle=this.piSeg(0);break;case 1:this.fShoulderAngle=this.piSeg(9),this.fElbowAngle=this.piSeg(9),this.fHandAngle=this.piSeg(13),this.bShoulderAngle=this.piSeg(3),this.bElbowAngle=this.piSeg(3),this.bHandAngle=this.piSeg(23),this.fHipAngle=this.piSeg(7),this.fKneeAngle=this.piSeg(7),this.fFootAngle=this.piSeg(12),this.bHipAngle=this.piSeg(5),this.bKneeAngle=this.piSeg(5),this.bFootAngle=this.piSeg(0);break;case 2:this.fShoulderAngle=this.piSeg(12),this.fElbowAngle=this.piSeg(12),this.fHandAngle=this.piSeg(13),this.bShoulderAngle=this.piSeg(0),this.bElbowAngle=this.piSeg(0),this.bHandAngle=this.piSeg(23),this.fHipAngle=this.piSeg(8),this.fKneeAngle=this.piSeg(8),this.fFootAngle=this.piSeg(11),this.bHipAngle=this.piSeg(4),this.bKneeAngle=this.piSeg(4),this.bFootAngle=this.piSeg(1);break;case 3:this.fShoulderAngle=this.piSeg(14),this.fElbowAngle=this.piSeg(14),this.fHandAngle=this.piSeg(14),this.bShoulderAngle=this.piSeg(22),this.bElbowAngle=this.piSeg(22),this.bHandAngle=this.piSeg(22),this.fHipAngle=this.piSeg(10),this.fKneeAngle=this.piSeg(10),this.fFootAngle=this.piSeg(10),this.bHipAngle=this.piSeg(2),this.bKneeAngle=this.piSeg(2),this.bFootAngle=this.piSeg(2)}b==1&&this.flipHorizontalDirection(),this.generateCoordinates()},this.expire=function(a,b){switch(a){case 0:this.fShoulderAngle=this.defaultAngle,this.fElbowAngle=this.defaultAngle,this.fHandAngle=this.piSeg(12),this.bShoulderAngle=this.defaultAngle,this.bElbowAngle=this.defaultAngle,this.bHandAngle=this.piSeg(0),this.fHipAngle=this.defaultAngle,this.fKneeAngle=this.defaultAngle,this.fFootAngle=this.piSeg(12),this.bHipAngle=this.defaultAngle,this.bKneeAngle=this.defaultAngle,this.bFootAngle=this.piSeg(0);break;case 1:this.shiftY(15),this.torsoAngle=this.piSeg(3),this.torsoAngle=this.piSeg(3),this.neckAngle=this.piSeg(3),this.headAngle=this.piSeg(5),this.fShoulderAngle=this.piSeg(6),this.fElbowAngle=this.piSeg(6),this.fHandAngle=this.piSeg(3),this.bShoulderAngle=this.piSeg(3),this.bElbowAngle=this.piSeg(3),this.bHandAngle=this.piSeg(23),this.fHipAngle=this.piSeg(9),this.fKneeAngle=this.piSeg(10),this.fFootAngle=this.piSeg(5),this.bHipAngle=this.piSeg(11),this.bKneeAngle=this.piSeg(12),this.bFootAngle=this.piSeg(4);break;case 2:this.shiftY(30),this.torsoAngle=this.piSeg(1),this.neckAngle=this.piSeg(1),this.headAngle=this.piSeg(0),this.fHipAngle=this.piSeg(11),this.fKneeAngle=this.piSeg(12),this.fFootAngle=this.piSeg(6),this.bHipAngle=this.piSeg(13),this.bKneeAngle=this.piSeg(14),this.bFootAngle=this.piSeg(5);break;case 3:this.shiftY(49),this.torsoAngle=this.piSeg(0),this.neckAngle=this.piSeg(0),this.headAngle=this.piSeg(6),this.fShoulderAngle=this.piSeg(14),this.fElbowAngle=this.piSeg(14),this.fHandAngle=this.piSeg(20),this.bShoulderAngle=this.piSeg(0),this.bElbowAngle=this.piSeg(21),this.bHandAngle=this.piSeg(18),this.fHipAngle=this.piSeg(12),this.fKneeAngle=this.piSeg(13),this.fFootAngle=this.piSeg(19),this.bHipAngle=this.piSeg(13),this.bKneeAngle=this.piSeg(15),this.bFootAngle=this.piSeg(8)}b==1&&this.flipHorizontalDirection(),this.generateCoordinates()},this.defaultAction=this.run,this.flipHorizontalDirection=function(){this.headAngle=Math.PI-this.headAngle,this.torsoAngle=Math.PI-this.torsoAngle,this.neckAngle=Math.PI-this.neckAngle,this.fShoulderAngle=Math.PI-this.fShoulderAngle,this.fElbowAngle=Math.PI-this.fElbowAngle,this.fHandAngle=Math.PI-this.fHandAngle,this.bShoulderAngle=Math.PI-this.bShoulderAngle,this.bElbowAngle=Math.PI-this.bElbowAngle,this.bHandAngle=Math.PI-this.bHandAngle,this.fHipAngle=Math.PI-this.fHipAngle,this.fKneeAngle=Math.PI-this.fKneeAngle,this.fFootAngle=Math.PI-this.fFootAngle,this.bHipAngle=Math.PI-this.bHipAngle,this.bKneeAngle=Math.PI-this.bKneeAngle,this.bFootAngle=Math.PI-this.bFootAngle},this.flipVerticalDirection=function(){this.y=this.y+this.figureHeight,this.wholeBodyLength=this.figureHeight*1,this.headRadius=this.wholeBodyLength/8+.5|0,this.torsoLength=-this.torsoLength,this.shoulderToElbowLength=-this.shoulderToElbowLength,this.elbowToHandLength=-this.elbowToHandLength,this.hipToKneeLength=-this.hipToKneeLength,this.kneeToFootLength=-this.kneeToFootLength},this.piSeg=function(a){return Math.PI*(a/12)},this.generateCoordinates=function(){this.shoulderX=Math.floor(this.hipX+Math.cos(-this.torsoAngle)*this.torsoLength),this.shoulderY=Math.floor(this.hipY+Math.sin(-this.torsoAngle)*this.torsoLength),this.neckX=Math.floor(this.shoulderX+Math.cos(-this.neckAngle)*this.neckLength),this.neckY=Math.floor(this.shoulderY+Math.sin(-this.neckAngle)*this.neckLength),this.headX=Math.floor(this.neckX+Math.cos(-this.headAngle)*this.headRadius),this.headY=Math.floor(this.neckY+Math.sin(-this.headAngle)*this.headRadius),this.fElbowX=Math.floor(this.shoulderX+Math.cos(this.fShoulderAngle)*this.shoulderToElbowLength),this.fElbowY=Math.floor(this.shoulderY+Math.sin(this.fShoulderAngle)*this.shoulderToElbowLength),this.fHandX=Math.floor(this.fElbowX+Math.cos(this.fElbowAngle)*this.elbowToHandLength),this.fHandY=Math.floor(this.fElbowY+Math.sin(this.fElbowAngle)*this.elbowToHandLength),this.fFingerX=Math.floor(this.fHandX+Math.cos(this.fHandAngle)*this.handLength),this.fFingerY=Math.floor(this.fHandY+Math.sin(this.fHandAngle)*this.handLength),this.bElbowX=Math.floor(this.shoulderX+Math.cos(this.bShoulderAngle)*this.shoulderToElbowLength),this.bElbowY=Math.floor(this.shoulderY+Math.sin(this.bShoulderAngle)*this.shoulderToElbowLength),this.bHandX=Math.floor(this.bElbowX+Math.cos(this.bElbowAngle)*this.elbowToHandLength),this.bHandY=Math.floor(this.bElbowY+Math.sin(this.bElbowAngle)*this.elbowToHandLength),this.bFingerX=Math.floor(this.bHandX+Math.cos(this.bHandAngle)*this.handLength),this.bFingerY=Math.floor(this.bHandY+Math.sin(this.bHandAngle)*this.handLength),this.fKneeX=Math.floor(this.hipX+Math.cos(this.fHipAngle)*this.hipToKneeLength),this.fKneeY=Math.floor(this.hipY+Math.sin(this.fHipAngle)*this.hipToKneeLength),this.fFootX=Math.floor(this.fKneeX+Math.cos(this.fKneeAngle)*this.kneeToFootLength),this.fFootY=Math.floor(this.fKneeY+Math.sin(this.fKneeAngle)*this.kneeToFootLength),this.fToeX=Math.floor(this.fFootX+Math.cos(this.fFootAngle)*this.footLength),this.fToeY=Math.floor(this.fFootY+Math.sin(this.fFootAngle)*this.footLength),this.bKneeX=Math.floor(this.hipX+Math.cos(this.bHipAngle)*this.hipToKneeLength),this.bKneeY=Math.floor(this.hipY+Math.sin(this.bHipAngle)*this.hipToKneeLength),this.bFootX=Math.floor(this.bKneeX+Math.cos(this.bKneeAngle)*this.kneeToFootLength),this.bFootY=Math.floor(this.bKneeY+Math.sin(this.bKneeAngle)*this.kneeToFootLength),this.bToeX=Math.floor(this.bFootX+Math.cos(this.bFootAngle)*this.footLength),this.bToeY=Math.floor(this.bFootY+Math.sin(this.bFootAngle)*this.footLength)},this.generateCoordinatesOld=function(){this.headX=Math.floor(this.x+Math.cos(this.headAngle)*this.headRadius),this.headY=Math.floor(this.startOfHeadY+Math.sin(this.headAngle)*this.headRadius),this.neckX=Math.floor(this.x+Math.cos(this.headAngle)*this.headRadius),this.neckY=Math.floor(this.startOfHeadY+Math.sin(this.headAngle)*this.headRadius),this.shoulderX=Math.floor(this.x+Math.cos(this.headAngle)*this.headRadius),this.shoulderY=Math.floor(this.startOfHeadY+Math.sin(this.headAngle)*this.headRadius),this.hipX=Math.floor(this.x+Math.cos(this.headAngle)*this.headRadius),this.hipY=Math.floor(this.startOfHeadY+Math.sin(this.headAngle)*this.headRadius),this.fElbowX=Math.floor(this.x+Math.cos(this.fShoulderAngle)*this.shoulderToElbowLength),this.fElbowY=Math.floor(this.startOfShoulderY+Math.sin(this.fShoulderAngle)*this.shoulderToElbowLength),this.fHandX=Math.floor(this.fElbowX+Math.cos(this.fElbowAngle)*this.elbowToHandLength),this.fHandY=Math.floor(this.fElbowY+Math.sin(this.fElbowAngle)*this.elbowToHandLength),this.fFingerX=Math.floor(this.fHandX+Math.cos(this.fHandAngle)*this.handLength),this.fFingerY=Math.floor(this.fHandY+Math.sin(this.fHandAngle)*this.handLength),this.bElbowX=Math.floor(this.x+Math.cos(this.bShoulderAngle)*this.shoulderToElbowLength),this.bElbowY=Math.floor(this.startOfShoulderY+Math.sin(this.bShoulderAngle)*this.shoulderToElbowLength),this.bHandX=Math.floor(this.bElbowX+Math.cos(this.bElbowAngle)*this.elbowToHandLength),this.bHandY=Math.floor(this.bElbowY+Math.sin(this.bElbowAngle)*this.elbowToHandLength),this.bFingerX=Math.floor(this.bHandX+Math.cos(this.bHandAngle)*this.handLength),this.bFingerY=Math.floor(this.bHandY+Math.sin(this.bHandAngle)*this.handLength),this.fKneeX=Math.floor(this.x+Math.cos(this.fHipAngle)*this.hipToKneeLength),this.fKneeY=Math.floor(this.startOfHipY+Math.sin(this.fHipAngle)*this.hipToKneeLength),this.fFootX=Math.floor(this.fKneeX+Math.cos(this.fKneeAngle)*this.kneeToFootLength),this.fFootY=Math.floor(this.fKneeY+Math.sin(this.fKneeAngle)*this.kneeToFootLength),this.fToeX=Math.floor(this.fFootX+Math.cos(this.fFootAngle)*this.footLength),this.fToeY=Math.floor(this.fFootY+Math.sin(this.fFootAngle)*this.footLength),this.bKneeX=Math.floor(this.x+Math.cos(this.bHipAngle)*this.hipToKneeLength),this.bKneeY=Math.floor(this.startOfHipY+Math.sin(this.bHipAngle)*this.hipToKneeLength),this.bFootX=Math.floor(this.bKneeX+Math.cos(this.bKneeAngle)*this.kneeToFootLength),this.bFootY=Math.floor(this.bKneeY+Math.sin(this.bKneeAngle)*this.kneeToFootLength),this.bToeX=Math.floor(this.bFootX+Math.cos(this.bFootAngle)*this.footLength),this.bToeY=Math.floor(this.bFootY+Math.sin(this.bFootAngle)*this.footLength)},this.generateNormalDimensions=function(){this.wholeBodyLength=this.figureHeight*1,this.hipX=this.x+this.figureWidth/2,this.hipY=this.y+this.figureHeight*10/24,this.headRadius=this.proportionOfBody(3/48),this.neckLength=this.proportionOfBody(1/24),this.torsoLength=this.proportionOfBody(.25),this.shoulderToElbowLength=this.proportionOfBody(5/24),this.elbowToHandLength=this.proportionOfBody(.125),this.handLength=this.proportionOfBody(2/24),this.hipToKneeLength=this.proportionOfBody(8/24),this.kneeToFootLength=this.proportionOfBody(.25),this.footLength=this.proportionOfBody(2/24)},this.generateExaggeratedDimensions=function(){this.wholeBodyLength=this.figureHeight*1,this.hipX=this.x+this.figureWidth/2,this.hipY=this.y+this.figureHeight*12/24,this.headRadius=this.proportionOfBody(.125),this.neckLength=this.proportionOfBody(1/24),this.torsoLength=this.proportionOfBody(.25),this.shoulderToElbowLength=this.proportionOfBody(5/24),this.elbowToHandLength=this.proportionOfBody(.125),this.handLength=this.proportionOfBody(2/24),this.hipToKneeLength=this.proportionOfBody(.25),this.kneeToFootLength=this.proportionOfBody(.25),this.footLength=this.proportionOfBody(2/24)},this.generateDimensions=function(){this.exaggerated?this.generateExaggeratedDimensions():this.generateNormalDimensions()},this.proportionOfBody=function(a){return this.wholeBodyLength*a+.5|0},this.shiftX=function(a){this.hipX=this.hipX+a/100*this.figureWidth},this.shiftY=function(a){this.hipY=this.hipY+a/100*this.figureHeight},this.defaultAngle=Math.PI/2,this.headAngle=this.defaultAngle,this.neckAngle=this.defaultAngle,this.torsoAngle=this.defaultAngle,this.fShoulderAngle=this.defaultAngle,this.fElbowAngle=this.defaultAngle,this.fHandAngle=0,this.bShoulderAngle=this.defaultAngle,this.bElbowAngle=this.defaultAngle,this.bHandAngle=0,this.fHipAngle=this.defaultAngle,this.fKneeAngle=this.defaultAngle,this.fFootAngle=0,this.bHipAngle=this.defaultAngle,this.bKneeAngle=this.defaultAngle,this.bFootAngle=0,this.headX,this.headY,this.neckX,this.neckY,this.shoulderX,this.shoulderY,this.hipX,this.hipY,this.fElbowX,this.fElbowY,this.bElbowX,this.bElbowY,this.fHandX,this.fHandY,this.bHandX,this.bHandY,this.fFingerX,this.fFingerY,this.bFingerX,this.bFingerY,this.fKneeX,this.fKneeY,this.bKneeX,this.bKneeY,this.fFootX,this.fFootY,this.bFootX,this.bFootY,this.fToeX,this.fToeY,this.bToeX,this.bToeY,this.x=a,this.y=b,this.figureWidth=c,this.figureHeight=d,this.exaggerated=e,this.generateDimensions()};var FiercePlanet=FiercePlanet||{};FiercePlanet.Dialogs=FiercePlanet.Dialogs||{},function(){this.gameOverDialog=null,this.completeWorldDialog=null,this.completeGameDialog=null,this.upgradeDeleteDialog=null,this.resourceGalleryDialog=null,this.newWorldDialog=null,this.settingsDialog=null,this.profileDialog=null,this.creditsDialog=null,this.genericDialog=null,this.highScores=null,this.login=null,this.designFeaturesDialog=null,this.editPropertiesDialog=null,this.calculateWorldLeft=function(){var a=$("#content-pane"),b=$("#wrapper"),c=$("#world-container"),d=$("#gameworld"),e=a.position().left,f=b.position().left,g=c.position().left,h=d.position().left,i=e+f+g+h;return i},this.calculateWorldTop=function(){var a=$("#content-pane"),b=$("#wrapper"),c=$("#world-container"),d=$("#gameworld"),e=a.position().top,f=b.position().top,g=c.position().top,h=d.position().top,i=e+f+g+h;return i},this.setupDialogs=function(){var a=this,b=this.calculateWorldLeft(),c=this.calculateWorldTop(),d=FiercePlanet.Orientation.worldWidth*3/5,e=FiercePlanet.Orientation.worldHeight*3/4,f=b+(FiercePlanet.Orientation.worldWidth-d)/2,g=c+(FiercePlanet.Orientation.worldHeight-e)/2,h=function(){Lifecycle._initialiseGame(),a.newWorldDialog.dialog("close"),Lifecycle.startWorld()};this.newWorldDialog=$("#new-world-dialog").dialog({position:[b,c],width:FiercePlanet.Orientation.worldWidth+7,height:FiercePlanet.Orientation.worldHeight+7,autoOpen:!1,modal:!0,title:"New World",buttons:[{id:"btn-play",text:"Play",click:function(){FiercePlanet.Dialogs.doPlay()}},{id:"btn-cancel",text:"Cancel",click:function(){$(this).dialog("close")}}],open:function(){$("#new-world-tabs").tabs(),jqconsole.Disable(),$("#btn-play").focus()}}),this.doPlay=function(){FiercePlanet.Dialogs.newWorldDialog.dialog("close"),Lifecycle.startWorld()},this.completeWorldDialog=$("<div></div>").html("World Complete!").dialog({position:[b,c],width:FiercePlanet.Orientation.worldWidth+7,height:FiercePlanet.Orientation.worldHeight+7,autoOpen:!1,modal:!0,title:"World Complete!",buttons:{"Next World":function(){Lifecycle.newWorld(),$(this).dialog("close")},Cancel:function(){$(this).dialog("close")}}}),this.completeGameDialog=$("<div></div>").html("Complete game!").dialog({position:[b,c],width:FiercePlanet.Orientation.worldWidth+7,height:FiercePlanet.Orientation.worldHeight+7,autoOpen:!1,modal:!0,title:"Fierce Planet Complete!",buttons:{"Bonus World":function(){Lifecycle.newWorld(),$(this).dialog("close")},"New Game":function(){Lifecycle.newGame(),$(this).dialog("close")},Cancel:function(){$(this).dialog("close")}}}),this.gameOverDialog=$("<div></div>").html("Game Over!").dialog({position:[b,c],width:FiercePlanet.Orientation.worldWidth+7,height:FiercePlanet.Orientation.worldHeight+7,autoOpen:!1,modal:!0,title:"Game Over!",buttons:{"Restart World":function(){Lifecycle.restartWorld(),$(this).dialog("close")},"New Game":function(){Lifecycle.newGame(),$(this).dialog("close")}}}),this.upgradeDeleteDialog=$("#delete-upgrade-dialog").dialog({position:[b,c],width:FiercePlanet.Orientation.worldWidth+7,height:FiercePlanet.Orientation.worldHeight+7,autoOpen:!1,modal:!0,title:"Upgrade or Delete Resource",buttons:{Cancel:function(){$(this).dialog("close")}}}),this.resourceGalleryDialog=$("#resource-gallery-tabs").dialog({position:[b,c],width:FiercePlanet.Orientation.worldWidth+7,height:FiercePlanet.Orientation.worldHeight+7,autoOpen:!1,modal:!0,title:"Resource Gallery",buttons:{"Save Capabilities":function(){FiercePlanet.GeneralUI.refreshSwatch(),FiercePlanet.ResourceUI.setupResourceInteraction(),FiercePlanet.ProfileUI.saveCapabilities(),$(this).dialog("close")},Cancel:function(){$(this).dialog("close")}},open:function(){$("#resource-gallery-tabs").tabs()}}),FiercePlanet.WorldGallery.renderCampaigns(),this.worldGalleryDialog=$("#world-gallery-dialog").dialog({position:[b,c],width:FiercePlanet.Orientation.worldWidth+7,height:FiercePlanet.Orientation.worldHeight+7,autoOpen:!1,modal:!0,title:"World Gallery",buttons:{"Open world":function(){Lifecycle.newWorld(),$(this).dialog("close")},Cancel:function(){$(this).dialog("close")}},open:function(){$("#world-gallery-tabs").tabs()}}),this.worldEditorDialog=$("#world-editor-dialog").dialog({position:[b,c],width:FiercePlanet.Orientation.worldWidth+7,height:FiercePlanet.Orientation.worldHeight+7,autoOpen:!1,modal:!0,title:"World Editor",buttons:{"Open world":function(){$(this).dialog("close")},Cancel:function(){$(this).dialog("close")}},open:function(){}}),this.settingsDialog=$("#settings-dialog").dialog({position:[b,c],width:FiercePlanet.Orientation.worldWidth+7,height:FiercePlanet.Orientation.worldHeight+7,autoOpen:!1,modal:!0,title:"Settings",buttons:{Save:function(){FiercePlanet.Utils.setAndStoreProperties(),$(this).dialog("close")},Reset:function(){FiercePlanet.Utils.getAndRetrieveProperties()},Cancel:function(){$(this).dialog("close")}},open:function(){$("#settings-tabs").tabs()}}),this.loginDialog=$("#login-dialog").dialog({position:[b,c],width:FiercePlanet.Orientation.worldWidth+7,height:FiercePlanet.Orientation.worldHeight+7,autoOpen:!1,modal:!0,title:"Login",buttons:{Login:function(){$(this).dialog("close"),Lifecycle.startWorld()},Cancel:function(){$(this).dialog("close")}}}),this.profileDialog=$("#profile-dialog").dialog({position:[b,c],width:FiercePlanet.Orientation.worldWidth+7,height:FiercePlanet.Orientation.worldHeight+7,autoOpen:!1,modal:!0,title:"Profile",buttons:{"Update profile":function(){FiercePlanet.Game.currentProfile.nickname=$("#profile-nickname").val(),$(this).dialog("close"),FiercePlanet.ProfileUI.saveProfile(function(a){a=="1"&&($("#welcome-link")[0].innerHTML="Welcome "+FiercePlanet.Game.currentProfile.nickname)})},Cancel:function(){$(this).dialog("close")}}}),$("#agentCostPerMove").slider({value:Universe.settings.agentCostPerMove,min:-10,max:-1,step:1,animate:"normal",slide:function(a,b){$("#agentCostPerMoveDisplay")[0].innerHTML=b.value}}),$("#rateOfResourceRecovery").slider({value:Universe.settings.rateOfResourceRecovery,min:1,max:10,step:1,animate:"normal",slide:function(a,b){$("#rateOfResourceRecoveryDisplay")[0].innerHTML=b.value}}),$("#agentCostPerMoveDisplay")[0].innerHTML=Universe.settings.agentCostPerMove,$("#rateOfResourceRecoveryDisplay")[0].innerHTML=Universe.settings.rateOfResourceRecovery,this.statsDialog=$("<div></div>").dialog({position:[b,c],width:FiercePlanet.Orientation.worldWidth+7,height:FiercePlanet.Orientation.worldHeight+7,autoOpen:!1,modal:!0,title:"Vital Statistics",buttons:{OK:function(){$(this).dialog("close")}}}),this.designFeaturesDialog=$("#world-features").dialog({position:[f,g],width:d,height:e,autoOpen:!1,modal:!0,title:"Add design features",buttons:{Cancel:function(){$(this).dialog("close")}}}),this.worldListDialog=$("<div></div>").html("Open world editor").dialog({position:[b,c],width:487,height:407,autoOpen:!1,modal:!0,title:"World Setup",buttons:{Cancel:function(){$(this).dialog("close")}},open:function(){$("#world-list-tabs").tabs()}}),this.editPropertiesDialog=$("#world-properties-dialog").dialog({position:[b,c],width:FiercePlanet.Orientation.worldWidth+7,height:FiercePlanet.Orientation.worldHeight+7,autoOpen:!1,modal:!0,title:"Edit world properties",buttons:{"Save World":function(){FiercePlanet.WorldUI.saveWorld(),FiercePlanet.Drawing.drawCanvases(),$(this).dialog("close")},Cancel:function(){$(this).dialog("close")}},open:function(){$("#edit-properties-tabs").tabs(),$("#world-name").focus(),$("#world-name").select()}}),this.creditsDialog=$("<div></div>").html("<div class='   credits'>Development Director</div><div>Liam Magee</div><div class='credits'>Art &amp; Design</div><div>Steven Harris</div><div class='credits'>Game Conception &amp; Testing</div><div>Joshua Magee</div><div>Jakki Mann</div><div class='credits'>Images and Sounds</div><div><a href='http://www.publicdomainpictures.net'>Public Domain Pictures</a></div><div><a href='http://freesound.org'>thefreesoundproject</a></div><div><a href='http://opengameart.org'>OpenGameArt.org</a></div>").dialog({position:[b,c],width:487,height:407,autoOpen:!1,modal:!0,title:"Credits",buttons:{OK:function(){$(this).dialog("close")}}}),$("#del-button").click(function(){FiercePlanet.deleteCurrentResource(),FiercePlanet.upgradeDeleteDialog.dialog("close")}),$("#upg-button").click(function(){FiercePlanet.upgradeCurrentResource(),FiercePlanet.upgradeDeleteDialog.dialog("close")}),$("#tutorial").click(function(a){confirm("Stop current game and begin the tutorial?")&&(Lifecycle.currentWorldNumber=1,Lifecycle.currentWorldPreset=!0,FiercePlanet.Game.tutorialMode=!0,Lifecycle.restartWorld())})},this.showGameOverDialog=function(){var a=this;FiercePlanet.Game.currentProfile.saved?FiercePlanet.ProfileUI.saveProfile(function(b){a.openGameOverDialog()}):this.openGameOverDialog()},this.openGameOverDialog=function(){this.gameOverDialog.html("Unfortunately Fierce Planet has gotten the better of its citizens! Click 'Restart World' or 'New Game' to try again."+FiercePlanet.ProfileUI.generateStats()).dialog("open")},this.showCompleteGameDialog=function(){FiercePlanet.Game.currentProfile.saved?FiercePlanet.ProfileUI.saveProfile(function(a){FiercePlanet.Dialogs.openCompleteGameDialog()}):this.openCompleteGameDialog()},this.openCompleteGameDialog=function(){this.completeGameDialog.html("Congratulations! In spite of challenges ahead, the citizens of Fierce Planet look forward to a bright and sustainable future!"+FiercePlanet.ProfileUI.generateStats()).dialog("open")},this.showCompleteWorldDialog=function(){FiercePlanet.Game.currentProfile.saved?FiercePlanet.ProfileUI.saveProfile(function(a){FiercePlanet.Dialogs.openCompleteWorldDialog()}):this.openCompleteWorldDialog()},this.openCompleteWorldDialog=function(){this.completeWorldDialog.html("<div>"+Lifecycle.currentWorld.conclusion+"</div>"+FiercePlanet.ProfileUI.generateStats()).dialog("open")},this.showResourceGallery=function(){FiercePlanet.Game.pauseGame(),$("#current-profile-class")[0].innerHTML=FiercePlanet.Game.currentProfile.profileClass,$("#current-credits")[0].innerHTML=FiercePlanet.Game.currentProfile.credits,$("#current-capabilities")[0].innerHTML=FiercePlanet.Game.currentProfile.capabilities.join(", ");var a=[],b=[];FiercePlanet.profileClass==FiercePlanet.Profile.PROFILE_CLASSES[0]?a=FiercePlanet.Profile.NOVICE_CAPABILITIES:FiercePlanet.profileClass==FiercePlanet.Profile.PROFILE_CLASSES[1]?a=FiercePlanet.Profile.PLANNER_CAPABILITIES:FiercePlanet.profileClass==FiercePlanet.Profile.PROFILE_CLASSES[2]?a=FiercePlanet.Profile.EXPERT_CAPABILITIES:FiercePlanet.profileClass==FiercePlanet.Profile.PROFILE_CLASSES[3]?a=FiercePlanet.Profile.VISIONARY_CAPABILITIES:FiercePlanet.profileClass==FiercePlanet.Profile.PROFILE_CLASSES[4]&&(a=FiercePlanet.Profile.GENIUS_CAPABILITIES),a=FiercePlanet.Profile.GENIUS_CAPABILITIES;var c=$(".purchase");for(var d=0;d<c.length;d++){var e=c[d],f=e.id,g=f.split("-purchase")[0],h=0;$.inArray(g,FiercePlanet.Profile.PLANNER_CAPABILITIES)>-1?h=FiercePlanet.Profile.CAPABILITY_COSTS[1]:$.inArray(g,FiercePlanet.Profile.EXPERT_CAPABILITIES)>-1?h=FiercePlanet.Profile.CAPABILITY_COSTS[2]:$.inArray(g,FiercePlanet.Profile.VISIONARY_CAPABILITIES)>-1?h=FiercePlanet.Profile.CAPABILITY_COSTS[3]:$.inArray(g,FiercePlanet.Profile.GENIUS_CAPABILITIES)>-1&&(h=FiercePlanet.Profile.CAPABILITY_COSTS[4]),$.inArray(g,a)>-1&&$.inArray(g,FiercePlanet.Game.currentProfile.capabilities)==-1&&h<FiercePlanet.Game.currentProfile.credits&&b.push(e)}for(var d=0;d<b.length;d++){var e=b[d],f=e.id,g=f.split("-purchase")[0],h=0;$.inArray(g,FiercePlanet.Profile.PLANNER_CAPABILITIES)?h=FiercePlanet.Profile.CAPABILITY_COSTS[1]:$.inArray(g,FiercePlanet.Profile.EXPERT_CAPABILITIES)?h=FiercePlanet.Profile.CAPABILITY_COSTS[2]:$.inArray(g,FiercePlanet.Profile.VISIONARY_CAPABILITIES)?h=FiercePlanet.Profile.CAPABILITY_COSTS[3]:$.inArray(g,FiercePlanet.Profile.GENIUS_CAPABILITIES)&&(h=FiercePlanet.Profile.CAPABILITY_COSTS[4]),e.addEventListener("click",function(a){var b=this.id,c=b.split("-purchase")[0],d=$("#"+b+"")[0].title;return $.inArray(c,FiercePlanet.Game.currentProfile.capabilities)==-1&&confirm('Purchase item "'+d+'"?')&&(FiercePlanet.Game.currentProfile.credits-=h,FiercePlanet.Game.currentProfile.capabilities.push(c),$("#current-credits")[0].innerHTML=FiercePlanet.Game.currentProfile.credits,$("#current-capabilities")[0].innerHTML=FiercePlanet.Game.currentProfile.capabilities.join(", "),$("#"+b).removeClass("active"),$("#"+b).addClass("inactive")),a.stopPropagation(),!1},!0),$("#"+e.id).removeClass("inactive"),$("#"+e.id).addClass("active")}FiercePlanet.Dialogs.resourceGalleryDialog.dialog("open")},this.showSettings=function(){FiercePlanet.Game.pauseGame(),FiercePlanet.Dialogs.settingsDialog.dialog("open")},this.showWorldGallery=function(){FiercePlanet.Game.pauseGame(),FiercePlanet.Dialogs.worldGalleryDialog.dialog("open")},this.showCredits=function(){FiercePlanet.Game.pauseGame(),FiercePlanet.Dialogs.creditsDialog.dialog("open")},this.showLogin=function(){FiercePlanet.Game.pauseGame(),FiercePlanet.Dialogs.loginDialog.dialog("open")}}.apply(FiercePlanet.Dialogs);var FiercePlanet=FiercePlanet||{};FiercePlanet.Controls=FiercePlanet.Controls||{},function(){this.hookUpUIEventListeners=function(){FiercePlanet.Utils.getAndRetrieveProperties(),$("#login").click(FiercePlanet.Dialogs.showLogin),$("#logout").click(FiercePlanet.ProfileUI.logout),$("#welcome-link").click(FiercePlanet.ProfileUI.editProfile),$("#about").click(function(){window.open("http://blog.fierce-planet.com")}),$("#playAgents").click(FiercePlanet.Game.playGame),$("#slowDown").click(FiercePlanet.Game.slowDown),$("#speedUp").click(FiercePlanet.Game.speedUp),$("#newGame").click(Lifecycle.newGame),$("#restartWorld").click(Lifecycle.restartWorld),$("#showResourceGallery").click(FiercePlanet.Dialogs.showResourceGallery),$("#panUp").click(function(){FiercePlanet.Drawing.pan(0)}),$("#panDown").click(function(){FiercePlanet.Drawing.pan(1)}),$("#panLeft").click(function(){FiercePlanet.Drawing.pan(2)}),$("#panRight").click(function(){FiercePlanet.Drawing.pan(3)}),$("#panReset").click(function(){FiercePlanet.Drawing.pan(4)}),$("#zoomIn").click(function(){FiercePlanet.Drawing.zoom(1)}),$("#zoomOut").click(function(){FiercePlanet.Drawing.zoom(-1)}),$("#zoomReset").click(function(){FiercePlanet.Drawing.zoom(0)}),$("#contract").click(FiercePlanet.Drawing.contract),$("#expand").click(FiercePlanet.Drawing.expand),$("#fullscreen").click(FiercePlanet.Orientation.makeFullScreen),$("#3d").click(FiercePlanet.Drawing.toggle3d),$("#resetView").click(FiercePlanet.Drawing.resetView),$("#tiltUp").click(FiercePlanet.Drawing.tiltUp),$("#tiltDown").click(FiercePlanet.Drawing.tiltDown),$("#rotateLeft").click(FiercePlanet.Drawing.rotateLeft),$("#rotateRight").click(FiercePlanet.Drawing.rotateRight),$("#settings").click(FiercePlanet.Dialogs.showSettings),$("#credits").click(FiercePlanet.Dialogs.showCredits),$("#openWorldGallery").click(FiercePlanet.Dialogs.showWorldGallery),$("#editor").click(FiercePlanet.WorldUI.listWorlds),$("#debug").click(Lifecycle.processAgents),$("#replay").click(FiercePlanet.Recording.replayUniverse),$("#story-board").click(FiercePlanet.Storyboard.showStoryboard),$("#high-scores").click(FiercePlanet.ProfileUI.showHighScores),$("#world-information-link").click(function(){var a=_.isUndefined(Lifecycle.currentWorld.information)?Lifecycle.currentWorld.introduction:Lifecycle.currentWorld.information,b="";_.isUndefined(Lifecycle.currentWorld.location)||(b+="<h3>Location</h3><div>"+Lifecycle.currentWorld.location+"</div>"),b+="<h3>Information</h3><div>"+a+"</div>",$("#world-information").html(b)});try{$("#show-world-properties").click(FiercePlanet.WorldUI.showWorldProperties),$("#refresh-tiles").click(FiercePlanet.Editor.refreshTiles),$("#fill-all").click(FiercePlanet.Editor.fillAllTiles),$("#undo-action").click(FiercePlanet.Editor.undoAction),$("#cancel-world-editor").click(FiercePlanet.Editor.cancelWorldEditor),$("#save-world").click(FiercePlanet.WorldUI.saveWorld),$("#clear-entry-points").click(FiercePlanet.Editor.clearEntryPoints),$("#clear-exit-points").click(FiercePlanet.Editor.clearExitPoints),$("#toggle-mode").click(FiercePlanet.Editor.toggleMode),$("#edit-map").click(FiercePlanet.Editor.editMap),$("#save-map").click(FiercePlanet.Editor.saveMap),$("#close-map").click(FiercePlanet.Editor.closeMap)}catch(a){_.isUndefined(console)||console.log(a)}var b={lines:12,length:7,width:5,radius:10,color:"#000",speed:1,trail:100,shadow:!0};FiercePlanet.Game.spinner=new Spinner(b),$("#spinner").hide().ajaxStart(function(){$(this).show()}).ajaxStop(function(){$(this).hide()}),Universe.settings.disableKeyboardShortcuts||($(document).unbind("keydown"),$(document).keydown(FiercePlanet.Keyboard.handleKeyboardShortcuts),$("input, textarea, select, form").focus(function(){$(document).unbind("keydown")}).blur(function(){$(document).keydown(FiercePlanet.Keyboard.handleKeyboardShortcuts)}),$(document).ajaxComplete(function(){$("input, textarea, select").focus(function(){$(document).unbind("keydown")}).blur(function(){$(document).keydown(FiercePlanet.Keyboard.handleKeyboardShortcuts)})})),FiercePlanet.Mouse.bindGameMouseEvents(),FiercePlanet.GeneralUI.makeElementsMovable(),FiercePlanet.Console.registerEvents()}}.apply(FiercePlanet.Controls);var FiercePlanet=FiercePlanet||{};FiercePlanet.Keyboard=FiercePlanet.Keyboard||{},function(){this.handleKeyboardShortcuts=function(a){if(Universe.settings.disableKeyboardShortcuts)return;if(a.ctrlKey||a.altKey||a.metaKey)return;if(Universe.settings.firstPerson){var b=Lifecycle.currentWorld.currentAgents[0];if(b){switch(a.which){case 37:case 65:b.x>0&&(b.x=b.x-1,FiercePlanet.Drawing.panByDrag(FiercePlanet.Orientation.cellWidth,0));break;case 39:case 68:b.x<FiercePlanet.Orientation.cellsAcross&&(b.x=b.x+1,FiercePlanet.Drawing.panByDrag(-FiercePlanet.Orientation.cellWidth,0));break;case 38:case 87:b.y>0&&(b.y=b.y-1,FiercePlanet.Drawing.panByDrag(0,FiercePlanet.Orientation.cellWidth));break;case 40:case 83:b.y<FiercePlanet.Orientation.cellsDown&&(b.y=b.y+1,FiercePlanet.Drawing.panByDrag(0,-FiercePlanet.Orientation.cellWidth))}b.lastMemory.x=b.x,b.lastMemory.y=b.y,FiercePlanet.Drawing.drawResourceAndAgents()}}else switch(a.which){case 27:jqconsole.Focus();break;case 192:$("#notifications").height()>40?($("#console").css({height:20}),$("#notifications").height(40)):($("#console").css({height:180}),$("#notifications").height(200));break;case 107:FiercePlanet.Drawing.zoom(1);break;case 109:FiercePlanet.Drawing.zoom(-1);break;case 96:FiercePlanet.Drawing.zoom(0);break;case 37:FiercePlanet.Drawing.pan(2);break;case 38:FiercePlanet.Drawing.pan(0);break;case 39:FiercePlanet.Drawing.pan(3);break;case 40:FiercePlanet.Drawing.pan(1);break;case 72:FiercePlanet.Drawing.pan(4);break;case 80:Lifecycle.playGame();break;case 78:Lifecycle.newGame();break;case 82:Lifecycle.restartWorld();break;case 87:Lifecycle.slowDown();break;case 70:Lifecycle.speedUp();break;case 84:$("#tutorial").click();break;case 71:$("#world-gallery").click();break;case 83:FiercePlanet.Dialogs.showSettings();break;case 69:$("#editor").click();break;case 52:a.shiftKey&&FiercePlanet.Dialogs.showResourceGallery()}}}.apply(FiercePlanet.Keyboard);var FiercePlanet=FiercePlanet||{};FiercePlanet.Mouse=FiercePlanet.Mouse||{},function(){this.bindGameMouseEvents=function(){var a=FiercePlanet.GeneralUI.getTopMostCanvas();a.click(FiercePlanet.GeneralUI.handleNoticeEvents),a.click(FiercePlanet.ResourceUI.processResourceCanvasClick),a.mousemove(FiercePlanet.Mouse.registerMouseMove),Universe.settings.allowInlinePanning&&(a.mousedown(FiercePlanet.Mouse.registerMouseDown),a.mouseup(FiercePlanet.Mouse.registerMouseUp)),a.bind("contextmenu",function(a){return!1}),a.mousewheel(function(a,b){return FiercePlanet.Drawing.zoom(b),a.preventDefault(),!1})},this.unbindGameMouseEvents=function(){var a=FiercePlanet.GeneralUI.getTopMostCanvas();a.unbind("click"),a.unbind("mousedown",FiercePlanet.Mouse.registerMouseDown),a.unbind("mousemove",FiercePlanet.Mouse.registerMouseMove),a.unbind("mouseup",FiercePlanet.Mouse.registerMouseUp),a.unbind("contextmenu")},this.registerMouseDown=function(a){FiercePlanet.Game.isMouseDown=!0,FiercePlanet.Game.isMouseMoving=!1;if(a.offsetX||a.offsetX==0)FiercePlanet.Game.currentX=a.offsetX,FiercePlanet.Game.currentY=a.offsetY},this.registerMouseMove=function(a){FiercePlanet.Game.isMouseDown&&Universe.settings.allowInlinePanning&&(FiercePlanet.Game.isMouseMoving=!0,FiercePlanet.Mouse.doMove(a))},this.doMove=function(a){if(FiercePlanet.Game.isMouseDown){var b,c;if(a.offsetX||a.offsetX==0)b=a.offsetX,c=a.offsetY;var d=b-FiercePlanet.Game.currentX,e=c-FiercePlanet.Game.currentY;if(!Universe.settings.reverseMouseClickEffects&&a.which!=1||Universe.settings.reverseMouseClickEffects&&a.which==1){var f=FiercePlanet.Orientation.halfWorldWidth,g=FiercePlanet.Orientation.halfWorldHeight,h=FiercePlanet.Game.currentX-f,i=FiercePlanet.Game.currentY-g,j=b-f,k=c-g,l=Math.atan2(i,h),m=Math.atan2(k,j),n=(m-l)*(Math.abs(j)/f+Math.abs(k)/g);FiercePlanet.Orientation.rotationAngle=FiercePlanet.Orientation.rotationAngle+n,FiercePlanet.Orientation.perspectiveAngle=FiercePlanet.Orientation.perspectiveAngle+e/FiercePlanet.Orientation.halfWorldHeight,FiercePlanet.Orientation.mapRotationAngle=FiercePlanet.Orientation.mapRotationAngle+n,Universe.settings.isometricView&&(FiercePlanet.Orientation.mapPerspectiveAngle=FiercePlanet.Orientation.mapPerspectiveAngle-e*2.15/FiercePlanet.Orientation.halfWorldHeight),FiercePlanet.Drawing.transformMap()}else FiercePlanet.Drawing.panByDrag(d,e);FiercePlanet.Drawing.drawCanvases(),FiercePlanet.Game.currentX=b,FiercePlanet.Game.currentY=c}},this.registerMouseUp=function(a){return a.preventDefault&&a.preventDefault(),FiercePlanet.Game.isMouseDown&&FiercePlanet.Game.isMouseMoving&&(FiercePlanet.Mouse.doMove(a),FiercePlanet.Game.isMouseDown=!1),!1}}.apply(FiercePlanet.Mouse);var FiercePlanet=FiercePlanet||{};FiercePlanet.Editor=FiercePlanet.Editor||{},function(){this.showDesignFeaturesDialog=function(a){$("#make-tile").click(function(a){Lifecycle.currentWorld.forbidAgentOnCell(FiercePlanet.Game.currentX,FiercePlanet.Game.currentY),Lifecycle.currentWorld.generatePath(),FiercePlanet.Dialogs.designFeaturesDialog.dialog("close"),FiercePlanet.Drawing.drawCanvases()}),$("#add-exit-point").click(function(a){Lifecycle.currentWorld.addExitPoint(FiercePlanet.Game.currentX,FiercePlanet.Game.currentY),FiercePlanet.Dialogs.designFeaturesDialog.dialog("close"),FiercePlanet.Drawing.drawCanvases()}),$("#add-entry-point").click(function(a){Lifecycle.currentWorld.removeEntryPoint(0,0),Lifecycle.currentWorld.addEntryPoint(FiercePlanet.Game.currentX,FiercePlanet.Game.currentY),FiercePlanet.Dialogs.designFeaturesDialog.dialog("close"),FiercePlanet.Drawing.drawCanvases()}),$("#remove-entry-point").click(function(a){Lifecycle.currentWorld.removeEntryPoint(FiercePlanet.Game.currentX,FiercePlanet.Game.currentY),FiercePlanet.Dialogs.designFeaturesDialog.dialog("close"),FiercePlanet.Drawing.drawCanvases()}),$("#remove-exit-point").click(function(a){Lifecycle.currentWorld.removeExitPoint(FiercePlanet.Game.currentX,FiercePlanet.Game.currentY),FiercePlanet.Dialogs.designFeaturesDialog.dialog("close"),FiercePlanet.Drawing.drawCanvases()}),$("#remove-resource").click(function(a){Lifecycle.currentWorld.removeResourceByPosition(FiercePlanet.Game.currentX,FiercePlanet.Game.currentY),FiercePlanet.Dialogs.designFeaturesDialog.dialog("close"),FiercePlanet.Drawing.drawCanvases()}),FiercePlanet.Dialogs.designFeaturesDialog.dialog("open")},this.setupWorldEditor=function(){$("#delete-upgrade").hide();var a=FiercePlanet.GeneralUI.getTopMostCanvas();a.unbind("click"),a.unbind("mousedown"),a.unbind("mousemove"),a.unbind("mouseup"),a.mousedown(FiercePlanet.Editor.handleEditorMouseDown),a.mousemove(FiercePlanet.Editor.handleEditorMouseMove),a.mouseup(FiercePlanet.Editor.handleEditorMouseUp),FiercePlanet.Game.inDesignMode=!0,Universe.settings.isometricView=!1,$("#world-editor").show()},this.handleEditorMouseDown=function(a){return FiercePlanet.Game.oldCells=Lifecycle.currentWorld.cells.slice(),FiercePlanet.Game.isMouseDown=!0,FiercePlanet.Game.isMouseMoving=!1,!1},this.handleEditorMouseMove=function(a){a.preventDefault&&a.preventDefault();if(FiercePlanet.Game.isMouseDown){FiercePlanet.Game.isMouseMoving=!0;var b=FiercePlanet.GeneralUI.getCurrentPosition(a);if(b.posX<0||b.posX>=Lifecycle.currentWorld.cellsAcross||b.posY<0||b.posY>=Lifecycle.currentWorld.cellsDown)return;if(FiercePlanet.Editor.clearMode){var c=Lifecycle.currentWorld.areAgentsAllowed(b.posX,b.posY);if(c){var d=Lifecycle.currentWorld.getCell(b.posX,b.posY);d.agentsAllowed=!1}}else{var d=Lifecycle.currentWorld.getCell(b.posX,b.posY);d.agentsAllowed=!0}Lifecycle.currentWorld.generatePath(),Lifecycle.currentWorld.cells.forEach(function(a){a.agentsAllowed?a.terrain=new Terrain(one.color("#aaa").alpha(.8).cssa()):a.terrain=Terrain.DEFAULT_TERRAIN}),FiercePlanet.Drawing.drawCanvases()}return!1},this.handleEditorMouseUp=function(a){a.preventDefault&&a.preventDefault();var b=FiercePlanet.GeneralUI.getCurrentPosition(a);if(b.posX<0||b.posX>=Lifecycle.currentWorld.cellsAcross||b.posY<0||b.posY>=Lifecycle.currentWorld.cellsDown)return;FiercePlanet.Game.currentX=b.posX,FiercePlanet.Game.currentY=b.posY;var c=Lifecycle.currentWorld.areAgentsAllowed(FiercePlanet.Game.currentX,FiercePlanet.Game.currentY);if(FiercePlanet.Editor.clearMode){if(c){var d=Lifecycle.currentWorld.getCell(b.posX,b.posY);d.agentsAllowed=!1,FiercePlanet.Drawing.drawCanvases()}}else if(c&&!FiercePlanet.Game.isMouseMoving)FiercePlanet.Editor.showDesignFeaturesDialog(a);else{var d=Lifecycle.currentWorld.getCell(b.posX,b.posY);d.agentsAllowed=!0,FiercePlanet.Drawing.drawCanvases()}return FiercePlanet.Game.isMouseDown=!1,!1},this.cancelWorldEditor=function(){FiercePlanet.Game.inDesignMode=!1,FiercePlanet.Editor.closeMap();var a=FiercePlanet.GeneralUI.getTopMostCanvas();a.unbind("mousedown",FiercePlanet.Editor.handleEditorMouseDown),a.unbind("mousemove",FiercePlanet.Editor.handleEditorMouseMove),a.unbind("mouseup",FiercePlanet.Editor.handleEditorMouseUp),FiercePlanet.Mouse.bindGameMouseEvents(),FiercePlanet.Console.maximise(),$("#world-editor").hide(),$("#swatch").show()},this.undoAction=function(){Lifecycle.currentWorld.cells=FiercePlanet.Game.oldCells,FiercePlanet.Drawing.drawCanvases()},this.refreshTiles=function(){Lifecycle.currentWorld.forbidAgentsOnAllCells(),Lifecycle.currentWorld.addEntryPoint(0,0),FiercePlanet.Drawing.drawCanvases()},this.fillAllTiles=function(){Lifecycle.currentWorld.allowAgentsOnAllCells(),Lifecycle.currentWorld.addEntryPoint(0,0),FiercePlanet.Drawing.drawCanvases()},this.clearEntryPoints=function(){Lifecycle.currentWorld.resetEntryPoints(),FiercePlanet.Drawing.drawCanvases()},this.clearExitPoints=function(){Lifecycle.currentWorld.resetExitPoints(),FiercePlanet.Drawing.drawCanvases()},this.toggleMode=function(){FiercePlanet.Editor.clearMode?($("#toggle-mode").html("Clear Mode"),FiercePlanet.Editor.clearMode=!1):($("#toggle-mode").html("Fill Mode"),FiercePlanet.Editor.clearMode=!0)},this.editMap=function(){FiercePlanet.Game.editingMap=!0,$("#map_canvas").css({zIndex:8}),$("canvas").hide();var a=FiercePlanet.GoogleMapUtils.defaultOptions();$.extend(a,Lifecycle.currentWorld.mapOptions),$.extend(a,{disableDefaultUI:!1,mapTypeControl:!0,overviewMapControl:!0,panControl:!0,rotateControl:!0,scaleControl:!0,streetViewControl:!0,zoomControl:!0}),FiercePlanet.Game.googleMap=FiercePlanet.GoogleMapUtils.createMap(a)},this.saveMap=function(){var a=[FiercePlanet.Game.googleMap.getCenter().lat(),FiercePlanet.Game.googleMap.getCenter().lng()],b=FiercePlanet.Game.googleMap.getTilt(),c=FiercePlanet.Game.googleMap.getZoom(),d=FiercePlanet.Game.googleMap.getMapTypeId();Lifecycle.currentWorld.mapOptions={center:a,tilt:b,zoom:c,mapTypeId:d},FiercePlanet.WorldUI.saveWorld()},this.closeMap=function(){FiercePlanet.Game.editingMap=!1,$("#map_canvas").css({zIndex:2}),$("canvas").show();var a=FiercePlanet.GoogleMapUtils.defaultOptions();$.extend(a,Lifecycle.currentWorld.mapOptions),$.extend(a,{disableDefaultUI:!0,mapTypeControl:!1,overviewMapControl:!1,panControl:!1,rotateControl:!1,scaleControl:!1,streetViewControl:!1,zoomControl:!1}),FiercePlanet.Game.googleMap=FiercePlanet.GoogleMapUtils.createMap(a),FiercePlanet.Drawing.drawCanvases()}}.apply(FiercePlanet.Editor);var FiercePlanet=FiercePlanet||{};FiercePlanet.GeneralUI=FiercePlanet.GeneralUI||{},function(){this.getTopMostCanvas=function(){return $("#noticeCanvas")},this.addButtonEffects=function(a){var b=a.src;if(b!=undefined){var c=b.split(".");c.splice(c.length-1,0,"down");var d=c.join(".");a.addEventListener("mouseover",function(){a.src=d},!1),a.addEventListener("mouseout",function(){a.src=b},!1),a.addEventListener("mousedown",function(){a.src=d},!1),a.addEventListener("mouseup",function(){a.src=b},!1)}},this.handleNoticeEvents=function(a){if(FiercePlanet.Game.currentNotice!=null){var b=FiercePlanet.Game.currentNotice,c=b.start,d=b.duration;if(c>Lifecycle.worldCounter||c+d<Lifecycle.worldCounter)return;var e=b.x,f=b.y,g=b.width,h=b.height,i,j;if(a.offsetX||a.offsetX==0)i=a.offsetX,j=a.offsetY;i>=e&&i<=e+g&&j>=f&&j<=f+h&&(FiercePlanet.Game.currentNotice=undefined,FiercePlanet.Drawing.clearCanvas("#noticeCanvas"))}},this.getWorldCoordinates=function(a){var b,c;return!_.isUndefined(a.offsetX)&&!_.isUndefined(a.offsetX)?(b=a.offsetX,c=a.offsetY):(b=a.clientX-$(a.target).offset().left,c=a.clientY-$(a.target).offset().top),{x:b,y:c}},this.getCurrentPosition=function(a){var b=a.pageX-FiercePlanet.Dialogs.calculateWorldLeft(),c=a.pageY-FiercePlanet.Dialogs.calculateWorldTop();return FiercePlanet.GeneralUI.getCurrentPositionByCoordinates(b,c)},this.getCurrentPositionByCoordinates=function(a,b){a-=FiercePlanet.Orientation.offsetX,b-=FiercePlanet.Orientation.offsetY;var c=FiercePlanet.Orientation.halfWorldWidth,d=FiercePlanet.Orientation.halfWorldHeight,e=a-c,f=b-d;a=c+e/FiercePlanet.Orientation.zoomWorld,b=d+f/FiercePlanet.Orientation.zoomWorld,a-=1/FiercePlanet.Orientation.zoomWorld,b-=1/FiercePlanet.Orientation.zoomWorld;var g=FiercePlanet.Orientation.getRotationOffset(a,b);a=g.x,b=g.y;var h=Math.floor(a/FiercePlanet.Orientation.cellWidth),i=Math.floor(b/FiercePlanet.Orientation.cellHeight),j=$("#baseCanvas").width(),k=$("#baseCanvas").height();h=Math.floor(h/(j/FiercePlanet.Orientation.worldWidth)),i=Math.floor(i/(k/FiercePlanet.Orientation.worldHeight));if(Universe.settings.isometricView||Lifecycle.currentWorld.isometricView){var l=FiercePlanet.Isometric.normaliseCoordinates(a,b);h=Math.floor(l.x/FiercePlanet.Orientation.cellWidth),i=Math.floor(l.y/FiercePlanet.Orientation.cellHeight)}return{posX:h,posY:i}},this.notify=function(a){Log.info(a)},this.makeElementsMovable=function(){if(Universe.settings.makeElementsMovable&&!Universe.settings.mobile)$("#graph-area, #controls").draggable({cursor:"pointer"}),$("#global-info-panel").draggable({cancel:"#swatch",cursor:"pointer"});else try{$("#graph-area, #controls").draggable("destroy"),$("#gameworld").draggable("destroy"),$("#global-info-panel").draggable("destroy")}catch(a){}$("#gameworld").disableSelection(),$(".swatch-draggable").css({zIndex:1e3}),$(".swatch-instance").css({zIndex:1e3})},this.worldInfo=function(){var a="",b="",c=Lifecycle.currentWorld;c.image!=undefined&&(a+='<img src="'+c.image+'" alt="City Image" width="460" height="140">',c.imageAttribution&&(a+='<div style="font-size: 0.8em; text-align: right">'+c.imageAttribution+"</div>")),c.name!=undefined&&(a+="<h3>"+c.name+"</h3>"),c.introduction!=undefined&&(a+=c.introduction),$("#world-introduction").html(a),_.isUndefined(c.information)?_.isUndefined(c.introduction)||$("#world-information").html(c.introduction):$("#world-information").html(c.information),c.sourceCode!=undefined&&$("#world-code").html(c.sourceCode),$("#world-parameters").html(""),c.parameters!=undefined&&$("#world-parameters").html(c.parameters),$("#world-parameters").prepend('<button id="paramRestart">Restart</button>'),$("#world-parameters").prepend('<button id="paramStep">Step</button>'),$("#world-parameters").prepend('<button id="paramPausePlay">Pause / Play</button>'),$("button").button(),$("#paramPausePlay").click(function(){FiercePlanet.Game.playGame()}),$("#paramStep").click(function(){Lifecycle.inPlay&&FiercePlanet.Game.pauseGame(),Lifecycle.processAgents()}),$("#paramRestart").click(function(){Lifecycle.inPlay&&FiercePlanet.Game.pauseGame(),Lifecycle._initialiseGame(),Lifecycle.currentWorld&&Lifecycle.currentWorld.setupParameters(),Lifecycle.startWorld()}),c.setupParameters&&c.setupParameters();var d=!ModuleManager.currentModule.persistSetupScreen&&!Lifecycle.currentWorld.persistSetupScreen;FiercePlanet.Dialogs.newWorldDialog.dialog("option","modal",d),FiercePlanet.Dialogs.newWorldDialog.dialog("open")},this.refreshSwatch=function(){for(var a=0;a<FiercePlanet.Profile.GENIUS_CAPABILITIES.length;a++){var b=$.trim(FiercePlanet.Profile.GENIUS_CAPABILITIES[a]);try{var c=$("#"+b);c.addClass("inactive")}catch(d){}}if(FiercePlanet.Game.currentProfile.capabilities)for(var a=0;a<FiercePlanet.Game.currentProfile.capabilities.length;a++){var b=$.trim(FiercePlanet.Game.currentProfile.capabilities[a]);try{var c=$("#"+b);c.removeClass("inactive"),$("#"+c.id).draggable({cursor:"pointer",helper:"clone",start:function(a,b){FiercePlanet.Game.currentResourceId=this.id}}),$("#"+c.id).click(function(){FiercePlanet.Game.currentResourceId=this.id})}catch(d){}}}}.apply(FiercePlanet.GeneralUI);var FiercePlanet=FiercePlanet||{};FiercePlanet.WorldGallery=FiercePlanet.WorldGallery||{},function(){this.init=function(){$("#difficulty-input-"+FiercePlanet.Game.levelOfDifficulty).attr("checked","checked"),$(".difficultyInput").click(FiercePlanet.WorldGallery.changeDifficulty);var a="tn-"+Lifecycle.currentCampaignID+"-"+Lifecycle.currentWorldNumber;FiercePlanet.WorldGallery.highlightGalleryItem(a,Lifecycle.currentWorldNumber)},this.renderCampaigns=function(){var a=ModuleManager.currentModule.allCampaigns();for(var b=0,c=a.length;b<c;b++){var d=a[b];$("#world-gallery-tabs>ul").prepend('<li><a href="#'+d.id+'"> '+d.name+"</a></li>");var e=$('<div class="quests" id="'+d.id+'"></div>'),f=$('<div class="thumbnails"></div>');$("#world-gallery-tabs").append(e),e.append(f);for(var g=0,h=d.worlds.length;g<h;g++){var i=d.worlds[g],j=i.thumbnail?i.thumbnail:"/images/worlds/world-thumbnail-default.png",k=$('<div class="thumbnail" id="tn-'+b+"-"+i.id+'">'+'<img src="'+j+'"/>'+"<div><strong>World "+i.id+":</strong>"+"</div>"+"<div>"+i.name+"</div>"+"</div>");k.data("set",d.id),k.data("world",g),f.append(k)}}$(".thumbnail, .customWorld").click(FiercePlanet.WorldGallery.changePresetWorldDirectly)},this.changePresetWorld=function(){var a=$("#worldInput").val();Lifecycle.currentWorldNumber=FiercePlanet.Utils.checkInteger(a),Lifecycle.currentWorldPreset=!0,FiercePlanet.ProfileUI.storeProfileData()},this.changePresetWorldDirectly=function(){var a=$(this).attr("id"),b=$(this).data("set"),c=$(this).data("world"),d="tn-"+b+"-"+c;FiercePlanet.WorldGallery.highlightGalleryItem(a,c),Lifecycle.currentCampaignID=b,Lifecycle.currentWorldNumber=FiercePlanet.Utils.checkInteger(c),Lifecycle.currentWorldPreset=!0,FiercePlanet.ProfileUI.storeProfileData()},this.changeWorldDirectly=function(){var a=$(this).attr("id");a=a.substring(11),FiercePlanet.WorldUI.openWorldFromServer(a)},this.highlightGalleryItem=function(a,b){$(".thumbnail").css({color:"inherit",backgroundColor:"inherit"}),b>=0&&b<=1e3&&$("#"+a).animate({color:"#000",backgroundColor:"#ffffaa"},500)},this.changeDifficulty=function(){var a=$("input[name=difficultyInput]:checked").val();FiercePlanet.Game.levelOfDifficulty=FiercePlanet.Utils.checkInteger(a)}}.apply(FiercePlanet.WorldGallery);var FiercePlanet=FiercePlanet||{};FiercePlanet.WorldUI=FiercePlanet.WorldUI||{},function(){this.listWorlds=function(){Lifecycle._stopAgents(),$("#world-list-tabs").tabs(),$("#new-world").click(FiercePlanet.WorldUI.newWorld),FiercePlanet.WorldUI.ajaxListWorlds()},this.newWorld=function(){Lifecycle._stopAgents(),FiercePlanet.Dialogs.worldEditorDialog.dialog("close"),FiercePlanet.previousWorld=Lifecycle.currentWorld,Lifecycle.currentWorld=new World,Lifecycle.currentWorldNumber=-1,Lifecycle.currentWorldPreset=!1,Lifecycle.currentWorld.name="[Enter the world name here]",Lifecycle.currentWorld.forbidAgentsOnAllCells(),FiercePlanet.WorldUI.prepareWorldPropertiesForm(),FiercePlanet.Drawing.drawGame(),FiercePlanet.Dialogs.editPropertiesDialog.dialog("open")},this.showWorldProperties=function(){FiercePlanet.Game.pauseGame(),FiercePlanet.WorldUI.prepareWorldPropertiesForm(),FiercePlanet.Dialogs.editPropertiesDialog.dialog("open")},this.openWorld=function(){$(this).parent().attr("id")&&$.get("/worlds/"+$(this).parent().attr("id"),function(a){FiercePlanet.WorldUI.constructWorld(a),FiercePlanet.Editor.setupWorldEditor(),FiercePlanet.Dialogs.worldEditorDialog.dialog("close")})},this.deleteWorld=function(){$(this).parent().attr("id")&&$.get("/worlds/destroy/"+$(this).parent().attr("id"),function(a){a&&($("#existing-worlds").empty(),a.forEach(function(a){$("#existing-worlds").append('<div id="'+a._id+'"><a class="world-editor" href="#">'+a.name+'</a> (<a class="delete-world" href="#">Delete</a>)</div>')}),$(".world-editor").click(FiercePlanet.WorldUI.openWorld),$(".delete-world").click(FiercePlanet.WorldUI.deleteWorld))})},this.saveWorld=function(){var a=Lifecycle.currentWorld,b=a.cellsAcross,c=a.cellsDown,d=$("#world-properties").serializeArray();d.forEach(function(b){var c=b.value;isNaN(c)?a[b.name]=b.value||"":a[b.name]=parseFloat(b.value)}),!Lifecycle.currentWorld._id||a.cellsAcross==b&&a.cellsDown==c?Lifecycle.currentWorld._id||(_.isUndefined(Lifecycle.currentWorld.initWorld)||Lifecycle.currentWorld.initWorld(),a.forbidAgentsOnAllCells()):confirm("The world dimensions have changed, and the current maze will be deleted. Should we proceed?")||(a.cellsAcross=b,a.cellsDown=c,_.isUndefined(Lifecycle.currentWorld.initWorld)||Lifecycle.currentWorld.initWorld()),FiercePlanet.Orientation.cellsAcross=Lifecycle.currentWorld.cellsAcross,FiercePlanet.Orientation.cellsDown=Lifecycle.currentWorld.cellsDown,FiercePlanet.Orientation.cellWidth=Math.round(FiercePlanet.Orientation.worldWidth/FiercePlanet.Orientation.cellsAcross),FiercePlanet.Orientation.cellHeight=Math.round(FiercePlanet.Orientation.worldHeight/FiercePlanet.Orientation.cellsDown),FiercePlanet.Orientation.pieceWidth=Math.round(FiercePlanet.Orientation.cellWidth*.5),FiercePlanet.Orientation.pieceHeight=Math.round(FiercePlanet.Orientation.cellHeight*.5),$.post("/worlds/save",{world:JSON.stringify(a)},function(a){a._id&&!Lifecycle.currentWorld._id&&(Lifecycle.currentWorld._id=a._id),FiercePlanet.Editor.setupWorldEditor()})},this.constructWorld=function(a){if(a){var b=FiercePlanet.Utils.makeFromJSONObject(a,new World);_.isUndefined(b.cells)&&(b.cells=[]),_.isUndefined(b.resources)&&(b.resources=[]),Lifecycle.currentWorldNumber=b.id,Lifecycle.currentWorldPreset=!1,Lifecycle.currentWorld=b,FiercePlanet.WorldUI.prepareWorldPropertiesForm(),FiercePlanet.Drawing.drawGame()}},this.prepareWorldPropertiesForm=function(){var a=Lifecycle.currentWorld;$("#world-object-id").val(a._id),$("#world-name").val(a.name),$("#world-url").attr("href","/worlds/share/"+a._id),$("#world-url-display").val("http://www.fierce-planet.com/worlds/share/"+a._id),$("#world-width").val(a.cellsAcross),$("#world-height").val(a.cellsDown),$("#world-initial-agent-number").val(a.initialAgentNumber),$("#world-wave-number").val(a.waveNumber),$("#world-expiry-limit").val(a.expiryLimit),$("#world-notice").val(a.notice),$("#world-allow-offscreen-cycling").val(a.allowOffscreenCycling),$("#world-allow-patches-on-path").val(a.allowResourcesOnPath)},this.ajaxListWorlds=function(){$.get("/worlds/list",function(a){a&&($("#existing-worlds").empty(),a.forEach(function(a){$("#existing-worlds").append('<div id="'+a._id+'"><a class="world-editor" href="#">'+a.name+'</a> (<a class="delete-world" href="#">Delete</a>)</div>')}),$(".world-editor").click(FiercePlanet.WorldUI.openWorld),$(".delete-world").click(FiercePlanet.WorldUI.deleteWorld)),FiercePlanet.Dialogs.worldEditorDialog.dialog("open")})},this.openWorldFromServer=function(a){$.get("/worlds/"+a,function(a){if(a){FiercePlanet.Utils.makeFromJSONObject(a,new World);for(var b=0,c=a.resources.length;b<c;b++)FiercePlanet.Utils.makeFromJSONObject(a.resources[b],new Resource);a.worldResources=a.resources,Lifecycle.currentWorld=a,Lifecycle.currentWorldNumber=a.id,Lifecycle.currentWorldPreset=!1,Lifecycle.currentWaveNumber=0,FiercePlanet.ProfileUI.storeProfileData(),FiercePlanet.Dialogs.worldGalleryDialog.dialog("close"),Lifecycle.currentWorld.initWorld=undefined,Lifecycle.currentWorld.waves=undefined,Lifecycle.currentWorld.initialiseWaves(Lifecycle.currentWorld.waveNumber),Lifecycle.newWorld()}})},this.makeWorldFromJSON=function(a){FiercePlanet.Utils.makeFromJSONObject(a,new World);for(var b=0,c=a.resources.length;b<c;b++)FiercePlanet.Utils.makeFromJSONObject(a.resources[b],new Resource);a.worldResources=a.resources,Lifecycle.currentWorld=a,Lifecycle.currentWorldNumber=a.id,Lifecycle.currentWorldPreset=!1,FiercePlanet.ProfileUI.storeProfileData(),FiercePlanet.Dialogs.worldGalleryDialog.dialog("close"),Lifecycle.newWorld()}}.apply(FiercePlanet.WorldUI);var NoticeDimensions={};NoticeDimensions.WAVE_NOTICE_WIDTH=200,NoticeDimensions.WAVE_NOTICE_HEIGHT=500,typeof exports!="undefined"&&(exports.Notice=Notice);var FiercePlanet=FiercePlanet||{};FiercePlanet.ProfileUI=FiercePlanet.ProfileUI||{},function(){this.getProfile=function(){try{$.get("/profile/get",function(a){a&&a.currentScore&&(FiercePlanet.Game.currentProfile=FiercePlanet.Utils.makeFromJSONObject(a.profile,Profile.prototype),FiercePlanet.Game.currentProfile.saved=!0,FiercePlanet.GeneralUI.refreshSwatch(),FiercePlanet.ResourceUI.setupResourceInteraction())})}catch(a){}},this.editProfile=function(){FiercePlanet.ProfileUI.getProfile(),$("#profile-nickname").val(FiercePlanet.Game.currentProfile.nickname),$("#profile-profileClass").innerHTML=FiercePlanet.Game.currentProfile.profileClass,$("#profile-progressTowardsNextClass").innerHTML=FiercePlanet.Game.currentProfile.progressTowardsNextClass,$("#profile-credits").innerHTML=FiercePlanet.Game.currentProfile.credits,$("#profile-capabilities").innerHTML=FiercePlanet.Game.currentProfile.capabilities,$("#profile-totalSaved").innerHTML=FiercePlanet.Game.currentProfile.totalSaved,$("#profile-totalExpired").innerHTML=FiercePlanet.Game.currentProfile.totalExpired,$("#profile-totalResourcesSpent").innerHTML=FiercePlanet.Game.currentProfile.totalResourcesSpent,$("#profile-currentScore").innerHTML=FiercePlanet.Game.currentProfile.currentScore,$("#profile-highestScore").innerHTML=FiercePlanet.Game.currentProfile.highestScore,$("#profile-currentWorld").innerHTML=FiercePlanet.Game.currentProfile.currentWorld,$("#profile-highestWorld").innerHTML=FiercePlanet.Game.currentProfile.highestWorld,FiercePlanet.Dialogs.profileDialog.dialog("open")},this.loadProfileSettingsFromStorage=function(){Lifecycle.currentWorldNumber=localStorage.currentWorldNumber!=undefined?parseInt(localStorage.currentWorldNumber):Lifecycle.currentWorldNumber,Lifecycle.currentWorldPreset=localStorage.currentWorldPreset!=undefined?localStorage.currentWorldPreset==="true":Lifecycle.currentWorldPreset,FiercePlanet.Game.currentScore=localStorage.currentScore!=undefined?parseInt(localStorage.currentScore):FiercePlanet.Game.currentScore;if(localStorage.currentProfile)var a=localStorage.currentProfile},this.storeProfileData=function(){try{localStorage.currentWorldNumber=Lifecycle.currentWorldNumber,Lifecycle.currentCampaignID&&(localStorage.currentCampaignID=Lifecycle.currentCampaignID),Lifecycle.currentWorld&&(localStorage.currentWorldPreset=Lifecycle.currentWorld.isPresetWorld)}catch(a){}},this.serializeProfile=function(){return{profile:JSON.stringify(FiercePlanet.Game.currentProfile)}},this.saveProfile=function(a){try{$.post("/profile/update",FiercePlanet.ProfileUI.serializeProfile(),function(b){a(b)})}catch(b){}},this.showHighScores=function(){$.post("/profiles/high_scores",function(a){console.log(a)})},this.saveCapabilities=function(){FiercePlanet.ProfileUI.saveProfile(function(a){Log.info("Saved profile")})},this.generateStats=function(){var a="<table><tr><td>World:</td><td>"+Lifecycle.currentWorld.id+"</td>"+"</tr>"+"<tr>"+"<td>Waves survived:</td>"+"<td>"+FiercePlanet.Game.currentWave+"</td>"+"</tr>"+"<tr>"+"<td>Score:</td>"+"<td>"+FiercePlanet.Game.currentProfile.currentScore+"</td>"+"</tr>"+"<tr>"+"<td>Citizens saved:</td>"+"<td>"+FiercePlanet.Game.currentProfile.currentWorldSaved+"</td>"+"</tr>"+"<tr>"+"<td>Citizens expired:</td>"+"<td>"+FiercePlanet.Game.currentProfile.currentWorldExpired+"</td>"+"</tr>"+"<tr>"+"<td>Resources spent:</td>"+"<td>"+FiercePlanet.Game.currentProfile.currentWorldResourcesSpent+"</td>"+"</tr>"+"<tr>"+"<td>Resources remaining:</td>"+"<td>"+FiercePlanet.Game.currentProfile.currentWorldResourcesInStore+"</td>"+"</tr>"+"<tr>"+"<td></td>"+"<td></td>"+"</tr>"+"<tr>"+"<td>Total saved:</td>"+"<td>"+FiercePlanet.Game.currentProfile.gameTotalSaved+"</td>"+"</tr>"+"<tr>"+"<td>Total expired:</td>"+"<td>"+FiercePlanet.Game.currentProfile.gameTotalExpired+"</td>"+"</tr>"+"<tr>"+"<td>Total resources spent:</td>"+"<td>"+FiercePlanet.Game.currentProfile.gameTotalResourcesSpent+"</td>"+"</tr>"+"<tr>"+"<td>Profile class:</td>"+"<td>"+FiercePlanet.Game.currentProfile.profileClass+"</td>"+"</tr>"+"<tr>"+"<td>Credits:</td>"+"<td><span style='font-weight:bold'>"+FiercePlanet.Game.currentProfile.credits+"</span></td>"+"</tr>"+"</table>";return a}}.apply(FiercePlanet.ProfileUI);var FiercePlanet=FiercePlanet||{};FiercePlanet.ResourceUI=FiercePlanet.ResourceUI||{},function(){this.setupResourceInteraction=function(){var a=FiercePlanet.GeneralUI.getTopMostCanvas(),b=$(".swatch-draggable"),c=null;for(var d=0;d<b.length;d++)c=b[d],c.id&&$.inArray(c.id,FiercePlanet.Game.currentProfile.capabilities)!=-1&&($("#"+c.id).draggable({cursor:"pointer",helper:"clone",zIndex:1e3,start:function(a,b){a.originalEvent&&(a=a.originalEvent),FiercePlanet.Game.currentResourceId=this.id},drag:function(a,b){a.originalEvent&&(a=a.originalEvent),FiercePlanet.Drawing.drawGuideCell(a)},stop:function(a,b){a.originalEvent&&(a=a.originalEvent),FiercePlanet.Drawing.clearGuide()}}),$("#"+c.id).click(function(){FiercePlanet.Game.currentResourceId=this.id}));a.droppable({drop:function(a,b){a.originalEvent&&(a=a.originalEvent);var c=$(this).offset(),d=a.pageX-c.left,e=a.pageY-c.top,f=FiercePlanet.GeneralUI.getCurrentPositionByCoordinates(d,e);FiercePlanet.ResourceUI.dropItem(f.posX,f.posY)}})},this.processResourceCanvasClick=function(a){FiercePlanet.isMouseDown=!1;if(FiercePlanet.isMouseMoving)return;var b=FiercePlanet.GeneralUI.getCurrentPosition(a),c=b.posX,d=b.posY,e=!1;for(var f=0;f<Lifecycle.currentWorld.resources.length;f++){var g=Lifecycle.currentWorld.resources[f];if(g.x==c&&g.y==d){FiercePlanet.Game.currentResource=g,confirm("Are you sure you want to delete this resource?")&&FiercePlanet.ResourceUI.deleteCurrentResource();return}}var h=Lifecycle.currentWorld.areAgentsAllowed(c,d);if(Universe.settings.tilesMutable)if(h){var i=Lifecycle.currentWorld.getCell(c,d);i.agentsAllowed=!1,Lifecycle.currentWorld.forbidAgentOnCell(c,d),FiercePlanet.Drawing.drawCanvases()}else if(!e&&FiercePlanet.Game.currentResourceId!=null)FiercePlanet.ResourceUI.dropItem(c,d);else{var i=Lifecycle.currentWorld.getCell(c,d);i.agentsAllowed=!0,FiercePlanet.Drawing.drawCanvases()}else e||(FiercePlanet.Game.currentResourceId!=null?FiercePlanet.ResourceUI.dropItem(c,d):Universe.settings.useInlineResourceSwatch&&FiercePlanet.ResourceUI.showInlineResourcePanel(a));FiercePlanet.Game.isMouseDown=!1},this.showInlineResourcePanel=function(a){var b=FiercePlanet.GeneralUI.getCurrentPosition(a),c=b.posX,d=b.posY;if(Lifecycle.currentWorld.areAgentsAllowed(c,d)&&!Lifecycle.currentWorld.allowResourcesOnPath)return;if(Lifecycle.currentWorld.isPositionOccupiedByResource(c,d))return;var e=FiercePlanet.Dialogs.calculateWorldLeft(),f=FiercePlanet.Dialogs.calculateWorldTop(),g=FiercePlanet.GeneralUI.getWorldCoordinates(a),h=g.x,i=g.y,j=200,k=240;c=e+h-j/2,d=f+i-k/2,c=c<e?e:c+j>e+FiercePlanet.Orientation.worldWidth?e+FiercePlanet.Orientation.worldWidth-j:c,d=d<f?f:d+k>f+FiercePlanet.Orientation.worldHeight?f+FiercePlanet.Orientation.worldHeight-k:d;var l=$("#swatch").clone();l.attr("id","inline-swatch"),l.css("left",0),l.css("top",0),FiercePlanet.inlineResourcePanel=$("<div></div>").html(l).dialog({title:"Add a Resource",position:[c,d],width:j,height:k,autoOpen:!1}),$('#inline-swatch div[class="title"]').remove();var m=$("#inline-swatch .swatch-draggable"),n=null;for(var o=0;o<m.length;o++)n=m[o],console.log(n.id),n.id&&$.inArray(n.id,FiercePlanet.Game.currentProfile.capabilities)!=-1&&n.addEventListener("click",function(b){var c=FiercePlanet.GeneralUI.getCurrentPosition(a),d=c.posX,e=c.posY;if(Lifecycle.currentWorld.areAgentsAllowed(d,e)&&!Lifecycle.currentWorld.allowResourcesOnPath)return;if(Lifecycle.currentWorld.isPositionOccupiedByResource(d,e))return;FiercePlanet.Game.currentResourceId=this.id,FiercePlanet.ResourceUI.dropItem(d,e),FiercePlanet.Game.currentResourceId=null,FiercePlanet.inlineResourcePanel.dialog("close")},!1);FiercePlanet.inlineResourcePanel.dialog("open")},this.deleteCurrentResource=function(){var a=Lifecycle.currentWorld.getCurrentResourceIndex(FiercePlanet.Game.currentResource);a>-1&&(FiercePlanet.Game.currentProfile.currentWorldResourcesInStore+=5,FiercePlanet.Game.currentProfile.currentWorldResourcesSpent-=5,Lifecycle.currentWorld.removeResource(FiercePlanet.Game.currentResource),FiercePlanet.Drawing.drawResourcesInStore(),FiercePlanet.Drawing.clearResource(FiercePlanet.Game.currentResource))},this.upgradeCurrentResource=function(){var a=Lifecycle.currentWorld.getCurrentResourceIndex(FiercePlanet.Game.currentResource);if(a>-1){var b=Lifecycle.currentWorld.resources[a];b.upgradeWorld<=4&&FiercePlanet.Game.currentProfile.currentWorldResourcesInStore>=b.upgradeCost&&(FiercePlanet.Game.currentProfile.currentWorldResourcesInStore-=b.upgradeCost,FiercePlanet.Game.currentProfile.currentWorldResourcesSpent+=b.upgradeCost,b.upgradeWorld=b.upgradeWorld+1,FiercePlanet.Drawing.drawResource(b),FiercePlanet.Drawing.drawResourcesInStore())}},this.dropItem=function(a,b){if(Lifecycle.currentWorld.areAgentsAllowed(a,b)&&!Lifecycle.currentWorld.allowResourcesOnPath)return;if(Lifecycle.currentWorld.isPositionOccupiedByResource(a,b))return;var c=FiercePlanet.Game.currentResourceId,d=ModuleManager.currentModule.resolveResourceType(c),e=new Resource(d,a,b);if(FiercePlanet.Game.currentProfile.currentWorldResourcesInStore<e.cost){FiercePlanet.Game.currentNotice=new Notice("Not enough resources for now - save some more agents!");return}return FiercePlanet.Game.currentProfile.spendResource(e),Lifecycle.currentWorld.addResource(e),FiercePlanet.Drawing.drawResources(),FiercePlanet.Drawing.drawResourcesInStore(),FiercePlanet.Game.eventTarget.fire(new Event("resource",e,"added",Lifecycle.universeCounter,Lifecycle.currentWorld)),Universe.settings.sendEventsToServer&&FiercePlanet.Comms.notifyServerOfEvent("resources",Lifecycle.currentWorld.resources),Universe.settings.useInlineResourceSwatch&&(FiercePlanet.Game.currentResourceId=null),!1},this.initialiseAndLoadResources=function(){if(_.isUndefined(ModuleManager.currentModule.resourceSet))return;$("#swatch").empty(),$("#gallery-items").empty();for(var a=0;a<ModuleManager.currentModule.resourceSet.categories.length;a++){var b=ModuleManager.currentModule.resourceSet.categories[a],c='<div class="swatch-category" id="'+b.code+'"></div>';$("#swatch").append(c);var d=$("#"+b.code),e='<div class="title">'+b.name+"</div>";d.append(e),d.css("background",b.color);var f='<div class="gallery-category" id="gallery-'+b.code+'"></div>';$("#gallery-items").append(f);var g=$("#gallery-"+b.code),h='<div class="title">'+b.name+"</div>";g.append(h),g.css("background",b.color);var i=0;for(var j=0;j<b.types.length;j++){var k=b.types[j],l='<div class="swatch-instance" title="'+k.name+'">'+'<div class="swatch-draggable" id="'+k.code+'"><img src="'+k.image+'" alt=""></div>'+"<div>"+k.cost+"</div>"+"</div>";d.append(l);var m=$("#"+k.code);i>0&&m.addClass("inactive");var n='<div class="swatch-instance inactive purchase" id="'+k.code+'-purchase" title="'+k.name+'">'+'<img src="'+k.image+'" alt="">'+"</div>";g.append(n),i++}}}}.apply(FiercePlanet.ResourceUI);var FiercePlanet=FiercePlanet||{};FiercePlanet.Graph=FiercePlanet.Graph||{},function(){this.plot;var a,b,c,d,e,f={"pop-count":this.PopulationStats,"pop-health":this.HealthStats,"saved-expired":this.SavedExpiredStats,hdi:this.HDIStats,hpi:this.HPIStats};this.openDialog=function(){f={"pop-count":this.PopulationStats,"pop-health":this.HealthStats,"saved-expired":this.SavedExpiredStats,hdi:this.HDIStats,hpi:this.HPIStats},$("#graph-config").change(function(){var a=$("#graph-config option:selected")[0].getAttribute("name");c=f[a],FiercePlanet.Graph.plot=c.setup()}),e||(e=$("#graph-dialog").dialog({position:[1300,35],width:550,height:560,autoOpen:!1,modal:!1,title:"Fierce Planet Graph",buttons:{"Pause / Play":function(){FiercePlanet.Game.playGame()},Step:function(){Lifecycle.inPlay&&FiercePlanet.Game.pauseGame(),Lifecycle.processAgents()},Restart:function(){Lifecycle.startWorld()},Close:function(){$(this).dialog("close")}},open:function(){$("#model-tabs").tabs()}})),$("#model-tabs").tabs(),e.dialog("open")},this.drawGraph=function(){$("#world-graph")[0]&&($("#world-graph").show(),this.refreshGraph(),a=50,this.updateGraph())},this.refreshGraph=function(){$("#world-graph")[0]&&(d=0,c=this.PopulationStats,this.plot=c.setup())},this.clearGraph=function(){$("#world-graph")[0]&&($("#world-graph").hide(),this.plot=null,a=250,clearTimeout(b))},this.updateGraph=function(){if($("#world-graph")[0]&&Universe.settings.showGraph){if(Lifecycle.inPlay){c.update(FiercePlanet.Graph.plot),d++;var e=1;d%e==0&&(FiercePlanet.Graph.plot.setupGrid(),FiercePlanet.Graph.plot.draw())}b=setTimeout(FiercePlanet.Graph.updateGraph,a)}},this.setupData=function(){b&&clearTimeout(b);var a={series:{shadowSize:0},yaxis:{min:0,max:100},legend:{position:"sw"}},c=[],d=FiercePlanet.Graph.setupData.arguments;for(var e=0,f=d.length;e<f;e++){var g=d[e];c.push({label:g.label,color:g.color,data:[[0,0]],lines:{show:!0}})}FiercePlanet.Graph.plot=$.plot($("#world-graph"),c,a)},this.plotData=function(){if($("#world-graph")[0]&&Lifecycle.inPlay){var a=FiercePlanet.Graph.plot.getData(),b=FiercePlanet.Graph.plotData.arguments;for(var c=0;c<b.length;c++)a[c].data.push([Lifecycle.worldCounter,b[c]]);FiercePlanet.Graph.plot.setData(a),d++;var e=1;d%e==0&&(FiercePlanet.Graph.plot.setupGrid(),FiercePlanet.Graph.plot.draw())}},this.PopulationStats={setup:function(){var a=Lifecycle.numAgents,b={series:{shadowSize:0},yaxis:{min:0,max:a}},c=[],d=ModuleManager.currentModule.allCultures();for(var e=0,f=d.length;e<f;e++){var g=d[e];c.push({color:g.color,data:[[0,Lifecycle.numAgents]],lines:{show:!0}})}return $.plot($("#world-graph"),c,b)},update:function(a){var b=a.getData();if(Lifecycle.worldCounter>0){var c=ModuleManager.currentModule.allCultures(),d=0;for(var e=0,f=c.length;e<f;e++){var g=c[e],h=0;Lifecycle.currentWorld.currentAgents.forEach(function(a){a.culture.name==g.name&&h++});var i=[Lifecycle.worldCounter,h];d++,b[e].data.push(i)}}a.setData(b)}},this.HealthStats={setup:function(){var a=100,b={series:{shadowSize:0},yaxis:{min:0,max:a}},c=[];for(var d=0,e=ModuleManager.currentModule.resourceSet.categories.length;d<e;d++){var f=ModuleManager.currentModule.resourceSet.categories[d];c.push({color:f.color,data:[[0,100]],lines:{show:!0}})}return c.push({color:"#333",data:[[0,100]],lines:{show:!0}}),$.plot($("#world-graph"),c,b)},update:function(a){var b=a.getData();if(Lifecycle.worldCounter>0){var c=Lifecycle.currentWorld.currentAgentHealthStats(),d=0;for(var e in c)if(c.hasOwnProperty(e)){var f=[Lifecycle.worldCounter,c[e]];b[d].data.push(f),d++}}a.setData(b)}},this.SavedExpiredStats={setup:function(){var a=FiercePlanet.currentWorld?FiercePlanet.currentWorld.getTotalSaveableAgents():55,b={series:{shadowSize:0},yaxis:{min:0,max:a}},c=[];return c.push({color:"#0f0",data:[[0,0]],lines:{show:!0}}),c.push({color:"#f00",data:[[0,0]],lines:{show:!0}}),$.plot($("#world-graph"),c,b)},update:function(a){var b=a.getData();if(Lifecycle.worldCounter>0){var c=b[0].data,d=b[1].data;c.push([Lifecycle.worldCounter,FiercePlanet.Game.currentProfile.currentWorldSaved]),d.push([Lifecycle.worldCounter,FiercePlanet.Game.currentProfile.currentWorldExpired])}a.setData(b)}},this.HDIStats={setup:function(){var a=100,b={series:{shadowSize:0},yaxis:{min:0,max:a}},c=[];for(var d=0,e=ModuleManager.currentModule.resourceSet.categories.length;d<e;d++){var f=ModuleManager.currentModule.resourceSet.categories[d];c.push({color:f.color,data:[[0,100]],lines:{show:!0}})}return c.push({color:"#333",data:[[0,100]],lines:{show:!0}}),$.plot($("#world-graph"),c,b)},update:function(a){var b=a.getData();if(Lifecycle.worldCounter>0){var c=Lifecycle.currentWorld.currentAgentHealthStats(),d=0;for(var e in c)if(c.hasOwnProperty(e)){var f=[Lifecycle.worldCounter,c[e]];b[d].data.push(f),d++}}a.setData(b)}},this.HPIStats={setup:function(){var a=100,b={series:{shadowSize:0},yaxis:{min:0,max:a}},c=[];return c.push({color:"#333",data:[[0,100]],lines:{show:!0}}),$.plot($("#world-graph"),c,b)},update:function(a){var b=a.getData();if(Lifecycle.worldCounter>0){var c=Lifecycle.currentWorld.currentAgentHealthStats(),d=0;for(var e in c)if(c.hasOwnProperty(e)){var f=[Lifecycle.worldCounter,c[e]];b[d].data.push(f),d++}}a.setData(b)}}}.apply(FiercePlanet.Graph);var FiercePlanet=FiercePlanet||{};FiercePlanet.Slider=FiercePlanet.Slider||{},function(){this.createSlider=function(a,b,c,d,e){var f=a+"Slider";$("#"+f)[0]||($("#"+a).before('<div class="slider-container"><div id="'+f+'" class="param-slider"></div></div>'),$("#"+f).slider({value:e,min:b,max:c,step:d,slide:function(b,c){$("#"+a).val(c.value),$("#"+f+" .ui-slider-handle").text(c.value)}}),$("#"+f+" .ui-slider-handle").css("text-decoration","none").css("text-align","center").css("width","2.4em").text(e),$("#"+f).before('<span class="min-slider">'+b+"</span>"),$("#"+f).after('<span class="max-slider">'+c+"</span>"))}}.apply(FiercePlanet.Slider);var FiercePlanet=FiercePlanet||{};FiercePlanet.ModuleEditor=FiercePlanet.ModuleEditor||{},function(){var moduleEditorDialog,moduleEditor;this.moduleEditor=null,this.openDialog=function(){moduleEditorDialog||(moduleEditorDialog=$("#module-editor-dialog").dialog({position:[1100,605],width:800,height:560,autoOpen:!1,modal:!1,title:"Module Editor",buttons:{Run:function(){if(FiercePlanet.ModuleEditor.moduleEditor){var code=FiercePlanet.ModuleEditor.moduleEditor.getValue();try{eval(code)}catch(e){console.log(e)}}},Cancel:function(){$(this).dialog("close")}}})),moduleEditorDialog.dialog("open")},this.buildEditorFromUrl=function(a,b){var c=$("#module-editor");$.get(a,function(a){b=b||"",c.html(a+"\n\n"+b),FiercePlanet.ModuleEditor.moduleEditor||(FiercePlanet.ModuleEditor.moduleEditor=CodeMirror.fromTextArea(c[0],{lineNumbers:!0,matchBrackets:!0,mode:"javascript"}))})}}.apply(FiercePlanet.ModuleEditor);var FiercePlanet=FiercePlanet||{};FiercePlanet.Parameters=FiercePlanet.Parameters||{},function(){this.processParameters=function(){var a=$(".world-parameters");for(var b=0;b<a.length;b++){var c=a[b];c.type&&c.type=="checkbox"?FiercePlanet.Parameters[c.name]=c.checked:FiercePlanet.Parameters[c.name]=c.value}}}.apply(FiercePlanet.Parameters);var FiercePlanet=FiercePlanet||{};FiercePlanet.Console=FiercePlanet.Console||{},function(){this.minimise=function(){$(".jqconsole").height(20),$("#notifications").height(40)},this.maximise=function(){$(".jqconsole").height(180),$("#notifications").height(200)},this.registerEvents=function(){}}.apply(FiercePlanet.Console),$(function(){var a="Welcome to Fierce Planet!\n\nType 'help' to review a list of commands.\n";window.jqconsole=$("#console").jqconsole(a,"Ask me: "),jqconsole.zone={},jqconsole.JSMode=!1,jqconsole.RegisterShortcut("Z",function(){jqconsole.AbortPrompt(),jqconsole.zone.name&&c()}),jqconsole.RegisterShortcut("`",function(){$("#console").css({height:30}),jqconsole.Reset(),h()}),jqconsole.RegisterMatching("{","}","brace"),jqconsole.RegisterMatching("(",")","paran"),jqconsole.RegisterMatching("[","]","bracket");var b=function(){jqconsole.Write("Hi! I'm here to help...\n"),jqconsole.Write("Here's some commands that tell me what to do:\n"),jqconsole.Write("help","code"),jqconsole.Write(" - this thing right here!\n"),jqconsole.Write("js","code"),jqconsole.Write(" - enter JavaScript zone.\n"),jqconsole.Write("chat","code"),jqconsole.Write(" - enter Chat zone.\n"),jqconsole.Write("fp","code"),jqconsole.Write(" - enter 'Fierce Planet' zone.\n"),jqconsole.Write("tutorial","code"),jqconsole.Write(" - enter Tutorial zone.\n"),jqconsole.Write("zone","code"),jqconsole.Write(" - tells you what zone you're in!\n"),jqconsole.Write("exit","code"),jqconsole.Write(" - gets you of the zone...\n")},c=function(){jqconsole.prompt_label_main="Ask me: ",jqconsole.Write("Bye - you're leaving the "),jqconsole.Write(jqconsole.zone.name,"quote"),jqconsole.Write(" zone.\n"),jqconsole.zone={},h()},d=function(){jqconsole.Write("Let's work together!\n\n"),jqconsole.Write("You tell me some things to do, and I try to do them.\n\n")},e=function(){jqconsole.Write("You're now entering the "),jqconsole.Write(jqconsole.zone.name,"quote"),jqconsole.Write(" zone.\n"),f()},f=function(){jqconsole.Write("Leave the "),jqconsole.Write(jqconsole.zone.name,"quote"),jqconsole.Write(" zone by typing: "),jqconsole.Write("Ctrl + Z","quote"),jqconsole.Write(".\n")},g=function(){jqconsole.zone.name?(jqconsole.Write("You're in the "),jqconsole.Write(jqconsole.zone.name,"quote"),jqconsole.Write(" zone.\n")):jqconsole.Write("You're not in any zone at all!\n")},h=function(a){a&&(a=="zone"?g():a=="exit"?c():jqconsole.zone.js?l(a):jqconsole.zone.fp?i(a):jqconsole.zone.chat?j(a):jqconsole.zone.duel?k(a):jqconsole.zone.login?m(a):jqconsole.zone.password?n(a):jqconsole.zone.agent?o(a):a=="help"||a=="h"||a=="?"?b():a=="js"?(jqconsole.prompt_label_main="js: ",jqconsole.JSMode=!0,jqconsole.zone.name="JavaScript",jqconsole.zone.js=!0,e(),jqconsole.Write("Try entering a JavaScript command, like this:\n\n"),jqconsole.Write("alert('Hello Fierce Planet!')\n\n","code")):a=="fp"?(jqconsole.prompt_label_main="fp: ",jqconsole.zone.name="Fierce Planet",jqconsole.zone.fp=!0,e(),jqconsole.Write("Now you can play with Fierce Planet settings!\n\n"),jqconsole.Write("For example, try the following: \n\n"),jqconsole.Write("reset \n\n","code")):a=="chat"?(jqconsole.prompt_label_main="chat: ",jqconsole.zone.name="Chat",jqconsole.zone.chat=!0,e()):a=="tute"||a=="tutorial"?(jqconsole.prompt_label_main="tute: ",jqconsole.zone.name="Tutorial",jqconsole.zone.chat=!0,e()):a=="agent"?(jqconsole.prompt_label_main="agent: ",jqconsole.zone.name="Agent",jqconsole.zone.agent=!0,e(),jqconsole.Write("\nNow you can set up an agent simulation!\n"),jqconsole.Write('Type "new" to set one up\n\n')):a=="login"?(jqconsole.Write("Please tell me who you are.\n\n"),jqconsole.Write("Email:\n\n"),jqconsole.zone.name="Login",jqconsole.zone.login=!0):a=="zone"?g():(jqconsole.Write("Oops! Not sure what "),jqconsole.Write(a,"quote"),jqconsole.Write(" means.\n\n"),b())),jqconsole.Prompt(!0,h,function(a){return/\\$/.test(a)})},i=function(a){if(a=="settings"||a=="s"){for(var b in Universe.settings)Universe.settings.hasOwnProperty(b)&&jqconsole.Write(b+": "+Universe.settings[b]+"\n");jqconsole.Write('To something, type "set [value]" \n')}else if(a=="login"||a=="li")FiercePlanet.Dialogs.showLogin();else if(a=="logout"||a=="lo")FiercePlanet.ProfileUI.logout();else if(a=="play"||a=="pause"||a=="p")Lifecycle.playGame();else if(a=="draw"||a=="d")FiercePlanet.Drawing.drawGame();else if(a=="speed-up"||a=="su")Lifecycle.speedUp();else if(a=="slow-down"||a=="sd")Lifecycle.slowDown();else if(a=="new-game"||a=="ng")Lifecycle.newGame();else if(a=="restart-world"||a=="rl")Lifecycle.restartWorld();else if(a=="show-resources"||a=="srg")FiercePlanet.Dialogs.showResourceGallery();else if(a=="pan-up"||a=="pu")FiercePlanet.Drawing.pan(0);else if(a=="pan-down"||a=="pd")FiercePlanet.Drawing.pan(1);else if(a=="pan-left"||a=="pl")FiercePlanet.Drawing.pan(2);else if(a=="pan-right"||a=="pr")FiercePlanet.Drawing.pan(3);else if(a=="pan-reset"||a=="ps")FiercePlanet.Drawing.pan(4);else if(a=="zoom-in"||a=="zi")FiercePlanet.Drawing.zoom(1);else if(a=="zoom-out"||a=="zo")FiercePlanet.Drawing.zoom(-1);else if(a=="zoom-reset"||a=="zr")FiercePlanet.Drawing.zoom(0);else if(a=="settings")FiercePlanet.Dialogs.showSettings();else if(a=="credits")FiercePlanet.Dialogs.showCredits();else if(a=="gallery"||a=="gal")FiercePlanet.Dialogs.showWorldGallery();else if(a=="editor"||a=="ed")FiercePlanet.WorldUI.showWorldEditor();else if(a=="toggle"||a=="tog")FiercePlanet.Drawing.toggle3d();else if(a=="3d")Universe.settings.isometricView=!0,$("#3d")[0].innerHTML="View 2D";else if(a=="2d")Universe.settings.isometricView=!1,$("#3d")[0].innerHTML="View 3D";else if(a=="tilt-up"||a=="tu")FiercePlanet.Drawing.tiltUp();else if(a=="tilt-down"||a=="td")FiercePlanet.Drawing.tiltDown();else if(a=="rotate-left"||a=="rl")FiercePlanet.Drawing.rotateLeft();else if(a=="rotate-right"||a=="rr")FiercePlanet.Drawing.rotateRight();else if(a=="reset"||a=="r")FiercePlanet.Drawing.resetView();else if(a=="debug"||a=="d")Lifecycle.processAgents();else if(a=="storyboard"||a=="sb")FiercePlanet.Storyboard.showStoryboard();else if(a=="fullscreen"||a=="fs")FiercePlanet.Orientation.makeFullScreen();else if(/set/.test(a))try{var c=a.split("=").reverse(),d=c.splice(0,1),e=c.splice(1,2),f=e.replace(/set/,"").trim();f.length>0&&d.length>0&&(Universe.settings[f]=d,jqconsole.Write("Set "+f+": "+Universe.settings[f]+"\n"))}catch(g){jqconsole.Write("Correct syntax: set [property name] [property value]\n\n")}else if(/resize/.test(a)){jqconsole.Write(a+"\n");try{var h=a.split(" "),i=h[1],j=h[2];jqconsole.Write(i+"\n"),jqconsole.Write(j+"\n"),FiercePlanet.Orientation.adjustParameters(i,j),FiercePlanet.Drawing.drawGame()}catch(g){jqconsole.Write(g+"\n")}}else if(/rs/.test(a)||/resourcesets/.test(a))try{var h=a.split(" "),k=h[1];jqconsole.Write(k+"\n"),k=="tbl"?(ModuleManager.currentModule.resourceSet=TBL,ModuleManager.currentModule.resourceSet.doSetup&&ModuleManager.currentModule.resourceSet.doSetup(),FiercePlanet.Game.currentProfile.capabilities=["farm","water","clinic"]):k=="cos"&&(ModuleManager.currentModule.resourceSet=CoS,ModuleManager.currentModule.resourceSet.doSetup&&ModuleManager.currentModule.resourceSet.doSetup(),FiercePlanet.Game.currentProfile.capabilities=["farm","water","clinic","legal"]),FiercePlanet.ResourceUI.initialiseAndLoadResources(),FiercePlanet.ResourceUI.setupResourceInteraction(),Lifecycle.newWorld()}catch(g){jqconsole.Write(g+"\n")}else a=="help"?(jqconsole.Write("settings || s\n"),jqconsole.Write("play || pause || p\n"),jqconsole.Write("draw || d\n"),jqconsole.Write("login || li\n"),jqconsole.Write("logout || lo\n"),jqconsole.Write("speed-up || su\n"),jqconsole.Write("slow-down || sd\n"),jqconsole.Write("credits\n"),jqconsole.Write("gallery\n"),jqconsole.Write("show-resources\n"),jqconsole.Write("pan-up || pu\n"),jqconsole.Write("pan-down || pd\n"),jqconsole.Write("pan-left || pl\n"),jqconsole.Write("pan-right || pr\n"),jqconsole.Write("pan-reset || ps\n"),jqconsole.Write("zoom-in || zi\n"),jqconsole.Write("zoom-out || zi\n"),jqconsole.Write("zoom-reset || zr\n"),jqconsole.Write("3d\n"),jqconsole.Write("2d\n"),jqconsole.Write("reset\n"),jqconsole.Write("debug\n"),jqconsole.Write("storyboard || sb\n"),jqconsole.Write("set [parameter = value]\n"),jqconsole.Write("resize [width, height]\n"),jqconsole.Write("webgl\n")):a=="webgl"&&jqconsole.Write("WebGL\n")},j=function(a){a=="list"?b():a=="help"?b():(jqconsole.Write("me: "+a+"\n"),socket.emit("user message",a))},k=function(a){a=="list"?b():a=="help"?b():socket.emit("user message",a)},l=function(a){try{jqconsole.Write("==> "+window.eval(a)+"\n")}catch(b){jqconsole.Write("ERROR: "+b.message+"\n","error")}},m=function(a){jqconsole.userCredentials=jqconsole.userCredentials||{},jqconsole.userCredentials.email=a,jqconsole.Write("Please now enter your password:\n\n"),jqconsole.zone.login=!1,jqconsole.zone.password=!0},n=function(a){_.isUndefined(jqconsole.userCredentials)?jqconsole.Write("Please enter your login details:\n"):(jqconsole.userCredentials.password=a,$.post("/login",{email:jqconsole.userCredentials.email,password:jqconsole.userCredentials.password},function(a){a.match(/canvas/)?(jqconsole.Write("Login successful!\n"),jqconsole.zone.password=!1):(jqconsole.Write("Login failed!\n"),jqconsole.zone.password=!1,jqconsole.zone.login=!0)}))},o=function(a){if(jqconsole.zone.agentSetup>-1)switch(jqconsole.zone.agentSetup){case 1:Lifecycle.currentWorld.cellsAcross=parseInt(a),Lifecycle.currentWorld.generatePath(),FiercePlanet.Orientation.cellsAcross=Lifecycle.currentWorld.cellsAcross,FiercePlanet.Orientation.recalibrateParameters(),FiercePlanet.Drawing.drawCanvases(),jqconsole.zone.agentSetup=2,jqconsole.Write("The world width is "+Lifecycle.currentWorld.cellsDown+".\n"),jqconsole.Write("What height would you like?\n");break;case 2:Lifecycle.currentWorld.cellsDown=parseInt(a),Lifecycle.currentWorld.generatePath(),FiercePlanet.Orientation.cellsDown=Lifecycle.currentWorld.cellsDown,FiercePlanet.Orientation.recalibrateParameters(),FiercePlanet.Drawing.drawCanvases(),jqconsole.zone.agentSetup=3,jqconsole.Write("The world height is "+Lifecycle.currentWorld.cellsDown+".\n"),jqconsole.Write("How many agents would you like?\n");break;case 3:Lifecycle.currentWorld.initialAgentNumber=parseInt(a),FiercePlanet.numAgents=Lifecycle.currentWorld.initialAgentNumber,Lifecycle.currentWorld.expiryLimit=Lifecycle.currentWorld.initialAgentNumber,jqconsole.Write("You've got "+Lifecycle.currentWorld.initialAgentNumber+" agents!\n"),jqconsole.Write("How many resources would you like?\n"),jqconsole.zone.agentSetup=4;break;case 4:Lifecycle.currentWorld.initialResourceNumber=parseInt(a),jqconsole.Write("You've got "+Lifecycle.currentWorld.initialResourceNumber+" resources!\n"),Lifecycle.currentWorld.generateWorldResources(),FiercePlanet.Drawing.drawCanvases(),jqconsole.zone.agentSetup=-1}else a=="new"?(Lifecycle.currentWorld=new World,Lifecycle.currentWorld.randomiseAgents=!0,Lifecycle.currentWorld.randomiseResources=!0,Lifecycle.currentWorld.waveNumber=1,FiercePlanet.Drawing.drawGame(),jqconsole.Write("What width would you like?\n"),jqconsole.zone.agentSetup=1):a=="start"?Lifecycle.newWave():a=="help"&&showAgentHelp()};h(),FiercePlanet.Dialogs.newWorldDialog!=null&&FiercePlanet.Dialogs.newWorldDialog.dialog("isOpen")&&$("#btn-play").focus()});var FiercePlanet=FiercePlanet||{};FiercePlanet.Storyboard=FiercePlanet.Storyboard||{},function(){this.showStoryboard=function(){var a="";a+=FiercePlanet.Dev.buildStoryboardForWorld(FiercePlanet.PresetWorlds.world0),a+=FiercePlanet.Dev.buildStoryboardForWorld(FiercePlanet.PresetWorlds.world1),a+=FiercePlanet.Dev.buildStoryboardForWorld(FiercePlanet.PresetWorlds.world2),a+=FiercePlanet.Dev.buildStoryboardForWorld(FiercePlanet.PresetWorlds.world3),a+=FiercePlanet.Dev.buildStoryboardForWorld(FiercePlanet.PresetWorlds.world4),a+=FiercePlanet.Dev.buildStoryboardForWorld(FiercePlanet.PresetWorlds.world5),a+=FiercePlanet.Dev.buildStoryboardForWorld(FiercePlanet.PresetWorlds.world6),a+=FiercePlanet.Dev.buildStoryboardForWorld(FiercePlanet.PresetWorlds.world7),a+=FiercePlanet.Dev.buildStoryboardForWorld(FiercePlanet.PresetWorlds.world8),a+=FiercePlanet.Dev.buildStoryboardForWorld(FiercePlanet.PresetWorlds.world9),a+=FiercePlanet.Dev.buildStoryboardForWorld(FiercePlanet.PresetWorlds.world10),a+=FiercePlanet.Dev.buildStoryboardForWorld(FiercePlanet.PresetWorlds.world11);var b=window.open("","RecipeWindow","width=600,height=600"),c='<html><head><title>FiercePlanet Storyboard</title></head><body><div id="storyboard">'+$("<div></div>").append($(a).clone()).html()+"</div></body></html>";return b.document.open(),b.document.write(c),b.document.close(),!1},this.buildStoryboardForWorld=function(a){var b="";return a.name&&(b+="<h3>"+a.name+"</h3>"),b+="<div>World ID: "+a.id+"</div>",b+="<div>Initial number of agents: "+a.initialAgentNumber+"</div>",b+="<div>Number of waves: "+a.waveNumber+"</div>",b+="<div>Expiry limit: "+a.expiryLimit+"</div>",b+="<div>Initial resource store: "+a.initialResourceStore+"</div>",a.image&&(b+="<h4>World Image</h4>",b+='<img src="'+a.image+'" alt="City Image" width="460" height="140">'),a.introduction&&(b+="<h4>Introduction</h4>",b+=a.introduction),a.tip&&(b+="<h4>Tip</h4>",b+=a.tip.text),a.catastrophe&&(b+="<h4>Catastrohe</h4>",b+=a.catastrophe.notice.text),a.conclusion&&(b+="<h4>Conclusion</h4>",b+=a.conclusion),b+="<hr/>",b}}.apply(FiercePlanet.Storyboard);var FiercePlanet=FiercePlanet||{};FiercePlanet.GoogleMapUtils=FiercePlanet.GoogleMapUtils||{},function(){function g(a,b,c){var d=a.y,e=a.x,f=1<<b;if(d<0||d>=f)return null;if(e<0||e>=f)e=(e%f+f)%f;return c({x:e,y:d},b)}function h(a,b,c){var d=Math.pow(2,c),e=b.x,f=b.y,g=["t"];for(var h=0;h<c;h++)d=d/2,f<d?e<d?g.push("q"):(g.push("r"),e-=d):e<d?(g.push("t"),f-=d):(g.push("s"),e-=d,f-=d);return a+g.join("")+".jpg"}function i(a){f.innerHTML=a+" -"}var a=!1,b={},c,d=[],e={},f=document.createElement("div");f.id="credit-control",f.style.fontSize="11px",f.style.fontFamily="Arial, sans-serif",f.style.margin="0 2px 2px 0",f.style.whitespace="nowrap",f.index=0,this.loadScript=function(){if(!a){var b=document.createElement("script");b.type="text/javascript";var c="http://maps.googleapis.com/maps/api/js?sensor=true&callback=FiercePlanet.GoogleMapUtils.initMaps";b.src=c,document.body.appendChild(b)}},this.initMaps=function(){typeof google!="undefined"&&typeof google.maps!="undefined"&&(b.moon={getTileUrl:function(a,b){return g(a,b,function(a,b){var c=Math.pow(2,b);return"http://mw1.google.com/mw-planetary/lunar/lunarmaps_v1/clem_bw/"+ +b+"/"+a.x+"/"+(c-a.y-1)+".jpg"})},tileSize:new google.maps.Size(256,256),isPng:!1,maxZoom:9,minZoom:0,radius:1738e3,name:"Moon",credit:"Image Credit: NASA/USGS"},b.sky={getTileUrl:function(a,b){return g(a,b,function(a,b){return"http://mw1.google.com/mw-planetary/sky/skytiles_v1/"+a.x+"_"+a.y+"_"+b+".jpg"})},tileSize:new google.maps.Size(256,256),isPng:!1,maxZoom:13,radius:57.2957763671875,name:"Sky",credit:"Image Credit: SDSS, DSS Consortium, NASA/ESA/STScI"},b.mars_elevation={getTileUrl:function(a,b){return g(a,b,function(a,b){return h("http://mw1.google.com/mw-planetary/mars/elevation/",a,b)})},tileSize:new google.maps.Size(256,256),isPng:!1,maxZoom:8,radius:3396200,name:"Mars Elevation",credit:"Image Credit: NASA/JPL/GSFC"},b.mars_visible={getTileUrl:function(a,b){return g(a,b,function(a,b){return h("http://mw1.google.com/mw-planetary/mars/visible/",a,b)})},tileSize:new google.maps.Size(256,256),isPng:!1,maxZoom:9,radius:3396200,name:"Mars Visible",credit:"Image Credit: NASA/JPL/ASU/MSSS"},b.mars_infrared={getTileUrl:function(a,b){return g(a,b,function(a,b){return h("http://mw1.google.com/mw-planetary/mars/infrared/",a,b)})},tileSize:new google.maps.Size(256,256),isPng:!1,maxZoom:9,radius:3396200,name:"Mars Infrared",credit:"Image Credit: NASA/JPL/ASU"}),a=!0},this.initializePlanetaryTypes=function(){var a;for(a in b)d.push(a);e={mapTypeIds:d,style:google.maps.MapTypeControlStyle.DROPDOWN_MENU};var g={zoom:0,center:new google.maps.LatLng(0,0),mapTypeControlOptions:{mapTypeIds:d,style:google.maps.MapTypeControlStyle.DROPDOWN_MENU}};c=new google.maps.Map(document.getElementById("actual_map"),g),c.controls[google.maps.ControlPosition.BOTTOM_RIGHT].push(f);for(a in b)c.mapTypes.set(a,new google.maps.ImageMapType(b[a]));google.maps.event.addListener(c,"maptypeid_changed",function(){i(b[c.getMapTypeId()].credit)})},this.serializeCurrentMap=function(){var a=this.defaultOptions();return FiercePlanet.Game.googleMap&&(a.center=FiercePlanet.Game.googleMap.getCenter(),a.mapTypeId=FiercePlanet.Game.googleMap.getMapTypeId(),a.tilt=FiercePlanet.Game.googleMap.getTilt(),a.zoom=FiercePlanet.Game.googleMap.getZoom()),a},this.createMap=function(a,d){if(typeof google=="undefined"||typeof google.maps=="undefined")return;var e=d||"#actual_map";a&&!_.isUndefined(a.rotate)&&$("#actual_map").css({"-webkit-transform":"rotate("+a.rotate+"deg)"}),a&&!a.center.lat&&(a.center=new google.maps.LatLng(a.center[0],a.center[1])),c=new google.maps.Map($(e)[0],a);var g=new google.maps.TrafficLayer;g.setMap(c);var h=new google.maps.weather.WeatherLayer({temperatureUnits:google.maps.weather.TemperatureUnit.FAHRENHEIT});h.setMap(c);var j=new google.maps.weather.CloudLayer;j.setMap(c),c.controls[google.maps.ControlPosition.BOTTOM_RIGHT].push(f);for(var k in b)c.mapTypes.set(k,new google.maps.ImageMapType(b[k]));return google.maps.event.addListener(c,"maptypeid_changed",function(){_.isUndefined(c.getMapTypeId())||i(b[c.getMapTypeId()].credit)}),c},this.defaultOptions=function(){if(typeof google=="undefined"||typeof google.maps=="undefined")return c;d=[google.maps.MapTypeId.ROADMAP,google.maps.MapTypeId.SATELLITE,google.maps.MapTypeId.HYBRID,google.maps.MapTypeId.TERRAIN];for(var a in b)d.push(a);e={mapTypeIds:d,style:google.maps.MapTypeControlStyle.DROPDOWN_MENU};var c={backgroundColor:"#ffffff",center:new google.maps.LatLng(69.13811902334064,-32.86834716796875),disableDefaultUI:!1,disableDoubleClickZoom:!1,draggable:!0,heading:0,keyboardShortcuts:!0,mapTypeControl:!1,mapTypeControlOptions:e,mapTypeId:"sky",maxZoom:null,minZoom:null,noClear:!1,overviewMapControl:!0,panControl:!1,rotateControl:!1,scaleControl:!1,scrollwheel:!1,streetViewControl:!1,tilt:0,zoom:7,zoomControl:!1};return c},this.interactiveOptions=function(){var a=this.defaultOptions();return a.disableDefaultUI=!1,a},this.currentLocation=function(){function f(d){d==!0?(alert("Geolocation service failed."),a=c):(alert("Your browser doesn't support geolocation. We've placed you in Siberia."),a=b)}var a,b=new google.maps.LatLng(60,105),c=new google.maps.LatLng(40.69847032728747,-73.9514422416687),d=new Boolean;if(navigator.geolocation)d=!0,navigator.geolocation.getCurrentPosition(function(b){a=new google.maps.LatLng(b.coords.latitude,b.coords.longitude)},function(){f(d)});else if(google.gears){d=!0;var e=google.gears.factory.create("beta.geolocation");e.getCurrentPosition(function(b){a=new google.maps.LatLng(b.latitude,b.longitude)},function(){this.handleNoGeoLocation(d)})}else d=!1,this.handleNoGeolocation(d);return a},this.getMapLocationInfo=function(a){if(typeof google=="undefined"||typeof google.maps=="undefined")return;var b="";if(!_.isUndefined(FiercePlanet.Game.googleMap)){var c=FiercePlanet.Game.googleMap.center,d=new google.maps.Geocoder;d.geocode({latLng:c},a)}return b}}.apply(FiercePlanet.GoogleMapUtils),$(document).ajaxSend(function(a,b,c){c.type=="post"&&(c.data=(c.data?c.data+"&":"")+"authenticity_token="+encodeURIComponent(AUTH_TOKEN))}),$(function(){$().zoom(function(a){switch(a){case 1:FiercePlanet.Orientation.externalZoomWorld*=1.2;break;case-1:FiercePlanet.Orientation.externalZoomWorld/=1.2;break;case 0:FiercePlanet.Orientation.externalZoomWorld=1}})});var FiercePlanet=FiercePlanet||{};FiercePlanet.Utils=FiercePlanet.Utils||{},function(){this.checkInteger=function(a){return Math.floor(a)},this.bindVariables=function(){$fp.w=$fp.w||Universe,$fp.s=$fp.s||Universe.settings,$fp.p=FiercePlanet.Game.currentProfile,$fp.l=Lifecycle.currentWorld,$fp.r=FiercePlanet.Game.currentResource,$fp.rid=FiercePlanet.Game.currentResourceId,$fp.x=FiercePlanet.Game.currentX,$fp.y=FiercePlanet.Game.currentY},this.initialiseUniverseSettings=function(){Universe.settings.noticesVisible=Universe.settings.noticesVisible||!0,Universe.settings.statusBarVisible=Universe.settings.statusBarVisible||!0,Universe.settings.scrollingImageVisible=Universe.settings.scrollingImageVisible||!0,Universe.settings.catastrophesVisible=Universe.settings.catastrophesVisible||!0,Universe.settings.disableKeyboardShortcuts=Universe.settings.disableKeyboardShortcuts||!0,Universe.settings.allowInlinePanning=Universe.settings.allowInlinePanning||!1,Universe.settings.soundsPlayable=Universe.settings.soundsPlayable||!1,Universe.settings.useInlineResourceSwatch=Universe.settings.useInlineResourceSwatch||!1,Universe.settings.agentTracing=Universe.settings.agentTracing||!1,Universe.settings.agentGoToNearestExit=Universe.settings.agentGoToNearestExit||!1,Universe.settings.hidePath=Universe.settings.hidePath||!1,Universe.settings.hidePathBorder=Universe.settings.hidePathBorder||!1,Universe.settings.hideWorldInfo=Universe.settings.hideWorldInfo||!1,Universe.settings.showGraph=Universe.settings.showGraph||!1,Universe.settings.showModuleEditor=Universe.settings.showModuleEditor||!1,Universe.settings.refreshGraphEveryWave=Universe.settings.refreshGraphEveryWave||!1,Universe.settings.showChat=Universe.settings.showChat||!1,Universe.settings.makeElementsMovable=Universe.settings.makeElementsMovable||!1,Universe.settings.reverseMouseClickEffects=Universe.settings.reverseMouseClickEffects||!1,Universe.settings.rivalsVisible=Universe.settings.rivalsVisible||!1,Universe.settings.predatorsVisible=Universe.settings.predatorsVisible||!1,Universe.settings.tilesMutable=Universe.settings.tilesMutable||!1,Universe.settings.tilesRemovable=Universe.settings.tilesRemovable||!1,Universe.settings.backgroundIconsVisible=Universe.settings.backgroundIconsVisible||!1,Universe.settings.recording=Universe.settings.recording||!1,Universe.settings.godMode=Universe.settings.godMode||!1,Universe.settings.isometricView=Universe.settings.isometricView||!1,Universe.settings.showResourcesAsBoxes=Universe.settings.showResourcesAsBoxes||!0,Universe.settings.sendEventsToServer=Universe.settings.sendEventsToServer||!1,Universe.settings.spectate=Universe.settings.spectate||!1,Universe.settings.firstPerson=Universe.settings.firstPerson||!1},this.zeroFill=function(a,b){return b-=a.toString().length,b>0?(new Array(b+(/\./.test(a)?2:1))).join("0")+a:a},this.getAndRetrieveProperties=function(){for(var a in Universe.settings)if(Universe.settings.hasOwnProperty(a)&&$.inArray(typeof Universe.settings[a],["number","string","boolean"])>-1){var b=$("#"+a);b&&b.length>0&&(b[0].type=="checkbox"?b[0].checked=Universe.settings[a]:b.attr("class")&&b.attr("class").indexOf("slider-component")>-1&&(b.slider("value",Universe.settings[a]),$("#"+a+"Display")[0].innerHTML=Universe.settings[a]))}},this.setAndStoreProperties=function(){console.log(Universe.settings);var a=$('#settings-dialog input[type="checkbox"]');for(var b in a){var c=a[b].id;Universe.settings[c]=a[b].checked}a=$("#settings-dialog .slider-component");for(b in a)c=a[b].id,Universe.settings[c]=$("#"+c).slider("value");Universe.settings.store(),FiercePlanet.Utils.processSettings(),Lifecycle.restartWorld()},this.processSettings=function(){Universe.settings.showGraph?(FiercePlanet.Graph.openDialog(),FiercePlanet.Graph.drawGraph()):FiercePlanet.Graph.clearGraph(),Universe.settings.showModuleEditor&&FiercePlanet.ModuleEditor.openDialog(),Universe.settings.disableKeyboardShortcuts?$(document).unbind("keydown"):($(document).unbind("keydown"),$(document).keydown(FiercePlanet.Keyboard.handleKeyboardShortcuts)),FiercePlanet.Mouse.unbindGameMouseEvents(),FiercePlanet.Mouse.bindGameMouseEvents(),FiercePlanet.GeneralUI.makeElementsMovable(),FiercePlanet.Utils.loadScripts(),Universe.settings.resourcesUpgradeable?$("#upgrade-option").css("display","block"):$("#upgrade-option").css("display","none"),Universe.settings.makeSquare&&($("#map_canvas").height(480),$("canvas").height(480),$("canvas").width(480),$("#notifications").css("top","597px"),$("#world-editor").css("top","580px"))},this.makeFromJSONObject=function(a,b){for(var c in b)typeof b[c]=="function"&&(a[c]=b[c]);return a},this.loadScripts=function(){var a=["/javascripts/fp/utils/test.js"];try{}catch(b){}}}.apply(FiercePlanet.Utils);var Log=function(){var a={FATAL:0,ERROR:1,WARN:2,INFO:3,DEBUG:4,TRACE:5,level:3,isAt:function(a){return a<=this.level},fatal:function(a){this.say(a,this.FATAL)},error:function(a){this.say(a,this.ERROR)},warn:function(a){this.say(a,this.WARN)},info:function(a){this.say(a,this.INFO)},debug:function(a){this.say(a,this.DEBUG)},trace:function(a){this.say(a,this.TRACE)},say:function(a,b){if(this.isAt(b)){if(typeof jqconsole!="undefined")try{jqconsole.Write(a+"\n","sys")}catch(c){}!_.isUndefined(console)&&this.isAt(b)&&console.log(a)}}};return a}(),FiercePlanet=FiercePlanet||{};FiercePlanet.Recording=FiercePlanet.Recording||{},function(){this.recordUniverse=function(){if(Lifecycle.currentWorld!=undefined)try{var a=new World(Lifecycle.currentWorld.id),b=[];for(var c=0,d=Lifecycle.currentWorld.currentAgents.length;c<d;c++){var e=Lifecycle.currentWorld.currentAgents[c],f=new Agent(e.culture,e.x,e.y);f.lastMemory=e.lastMemory,f.delay=e.delay,f.speed=e.speed,b.push(f)}a.setCurrentAgents(b),a.setResources(Lifecycle.currentWorld.resources),FiercePlanet.Game.recordedWorlds[FiercePlanet.Game.globalRecordingCounter]=JSON.stringify(a),FiercePlanet.Game.globalRecordingCounter++}catch(g){}},this.replayUniverse=function(){Lifecycle._stopAgents(),FiercePlanet.Game.existingCurrentWorld=Lifecycle.currentWorld,clearInterval(Lifecycle.agentTimerId),FiercePlanet.Game.globalRecordingCounter=0,Lifecycle.waveCounter=0,FiercePlanet.Drawing.drawGame(),FiercePlanet.Game.inPlay=!0,setTimeout("FiercePlanet.Recording.replayStart()",100)},this.replayStart=function(){Lifecycle.agentTimerId=setInterval("FiercePlanet.Recording.replayStep()",Lifecycle.interval*2)},this.replayStep=function(){var a=FiercePlanet.Game.recordedWorlds[FiercePlanet.Game.globalRecordingCounter];if(a==undefined)this.replayStop();else try{FiercePlanet.Drawing.clearAgents(),Lifecycle.currentWorld=JSON.parse(a),FiercePlanet.Game.globalRecordingCounter++,Lifecycle.waveCounter++,FiercePlanet.Drawing.clearCanvas("#resourceCanvas"),FiercePlanet.Drawing.clearCanvas("#scrollingCanvas"),FiercePlanet.Drawing.clearCanvas("#noticeCanvas"),FiercePlanet.Drawing.clearCanvas("#agentCanvas"),FiercePlanet.Drawing.drawEntryPoints(),FiercePlanet.Drawing.drawExitPoints(),FiercePlanet.Drawing.drawScrollingLayer(),FiercePlanet.Drawing.drawResourceAndAgents()}catch(b){}},this.replayStop=function(){Lifecycle.agentTimerId=clearInterval(Lifecycle.agentTimerId),FiercePlanet.Game.globalRecordingCounter=0,Lifecycle.currentWorld=FiercePlanet.existingCurrentWorld,FiercePlanet.Game.inPlay=!1}}.apply(FiercePlanet.Recording);var urlParams={};(function(){var a,b=/\+/g,c=/([^&=]+)=?([^&]*)/g,d=function(a){return decodeURIComponent(a.replace(b," "))},e=window.location.search.substring(1);while(a=c.exec(e))urlParams[d(a[1])]=d(a[2])})(),function(){var a=0,b=["ms","moz","webkit","o"];for(var c=0;c<b.length&&!window.requestAnimationFrame;++c)window.requestAnimationFrame=window[b[c]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[b[c]+"CancelAnimationFrame"]||window[b[c]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(b,c){var d=(new Date).getTime(),e=Math.max(0,16-(d-a)),f=window.setTimeout(function(){b(d+e)},e);return a=d+e,f}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(a){clearTimeout(a)})}();var FiercePlanet=FiercePlanet||{},$fp=$fp||FiercePlanet;FiercePlanet.Game=FiercePlanet.Game||{},function(){this.SAVE_SCORE=10,this.globalRecordingCounter=0,this.tutorialMode=!0,this.levelOfDifficulty=2,this.currentProfile=new Profile,this.currentResourceId=null,this.currentResource=null,this.currentNotice=null,this.inDesignMode=!1,this.isMouseDown=!1,this.isMouseMoving=!1,this.currentX=null,this.currentY=null,this.eventTarget=new EventTarget,this.recordedWorlds=[],this.scrollingImage=new Image,this.scrollingImageX=0,this.scrollingImageOffset=1,this.audio=null,this.googleMap=null,this.loadGame=function(){$(window).resize(function(){FiercePlanet.Orientation.adjustParameters($("#world-container").width(),$("#world-container").height()),FiercePlanet.Drawing.drawCanvases()}),FiercePlanet.Orientation.initialiseParameters($("#world-container").width(),$("#world-container").height()),FiercePlanet.ProfileUI.loadProfileSettingsFromStorage(),FiercePlanet.WorldGallery.init(),FiercePlanet.Utils.initialiseUniverseSettings(),Universe.settings.load(),FiercePlanet.Dialogs.setupDialogs(),FiercePlanet.ResourceUI.initialiseAndLoadResources(),FiercePlanet.ResourceUI.setupResourceInteraction(),FiercePlanet.ProfileUI.getProfile(),FiercePlanet.Controls.hookUpUIEventListeners(),FiercePlanet.Utils.processSettings(),FiercePlanet.Event.hookUpCustomEventListeners(),FiercePlanet.Utils.bindVariables(),FiercePlanet.Game.setupLifecycle(),$("#model-tabs").tabs(),$("#world-graph").width(FiercePlanet.Orientation.worldWidth*.9),$("#world-graph").height(FiercePlanet.Orientation.worldHeight*.25),FiercePlanet.Graph.drawGraph(),Lifecycle.newWorld(),$("#btn-play").focus()},this.setupLifecycle=function(){Lifecycle.preProcessCallback=function(){FiercePlanet.Drawing.drawScrollingLayer(),Universe.settings.noticesVisible&&FiercePlanet.Game.currentNotice!=undefined&&FiercePlanet.Drawing.drawNotice(FiercePlanet.Game.currentNotice)},Lifecycle.processSavedCallback=function(){FiercePlanet.Game.currentProfile.processSavedAgent(Lifecycle.currentWaveNumber)},Lifecycle.postProcessCallback=function(){for(var a=0;a<Lifecycle.currentWorld.expiredAgents.length;a++){var b=Lifecycle.currentWorld.expiredAgents[a];b.diedAt>Lifecycle.worldCounter-20?FiercePlanet.Drawing.drawExpiredAgent(b):FiercePlanet.Drawing.clearThisAgent(b)}FiercePlanet.Drawing.clearTheseAgents(Lifecycle.currentWorld.savedAgents),FiercePlanet.Drawing.drawResourceAndAgents();if(Universe.settings.sendEventsToServer){var c=[];Lifecycle.currentWorld.currentAgents.forEach(function(a){var b=new SimpleAgent(DefaultCultures.CITIZEN_AGENT_TYPE,a.x,a.y,a.color,a.speed,a.health,a.wanderX,a.wanderY,a.lastMemory,a.delay,a.countdownToMove,a.healthCategoryStats);c.push(b)}),FiercePlanet.Comms.notifyServerOfEvent("agents",c)}Universe.settings.recording&&FiercePlanet.Recording.recordUniverse()},Lifecycle.preNewGameCallback=function(){Lifecycle.currentWorldPreset&&(Lifecycle.currentWorldNumber=1),FiercePlanet.Game.currentProfile.resetScores()},Lifecycle.postNewGameCallback=function(){},Lifecycle.preNewWorldCallback=function(){FiercePlanet.Game.currentProfile.updateScore(),FiercePlanet.Game.currentNotice=null,FiercePlanet.Game.recordedWorlds=[],FiercePlanet.Utils.bindVariables(),FiercePlanet.Game.inDesignMode=!1,FiercePlanet.Game.maxWorldMoves=0},Lifecycle.doNewWorldCallback=function(){Universe.settings.hideWorldInfo?Lifecycle.startWorld():FiercePlanet.GeneralUI.worldInfo()},Lifecycle.postNewWorldCallback=function(){FiercePlanet.Game.currentNotice=Lifecycle.currentWorld.tip,FiercePlanet.GeneralUI.notify("Starting world "+Lifecycle.currentWorld.id+"..."),Universe.settings.sendEventsToServer&&FiercePlanet.Comms.notifyServerOfEvent("world",Lifecycle.currentWorld.id)},Lifecycle.preRestartWorldCallback=function(){FiercePlanet.Game.currentProfile.revertScore()},Lifecycle.postRestartWorldCallback=function(){},Lifecycle.preStartWorldCallback=function(){Universe.settings.sendEventsToServer&&FiercePlanet.Comms.notifyServerOfEvent("start",null),Universe.settings.playAudio&&FiercePlanet.Game._startAudio(),Universe.settings.animateWorldAtStart&&FiercePlanet.Drawing.animateWorld(),_.isUndefined(FiercePlanet.Game.googleMap)||FiercePlanet.GoogleMapUtils.getMapLocationInfo(function(a,b){b==google.maps.GeocoderStatus.OK&&(Lifecycle.currentWorld.location=a[0].formatted_address,Log.info("Welcome to "+Lifecycle.currentWorld.location+"."))});if(Universe.settings.firstPerson){var a=ModuleManager.currentModule.allCultures();for(var b=0,c=a.length;b<c;b++){var d=a[b];d.generateEachWave&&Lifecycle.currentWorld.generateAgents(d,Lifecycle.numAgents)}}FiercePlanet.Effects&&FiercePlanet.Effects.setupView()},Lifecycle.postStartWorldCallback=function(){},Lifecycle.preNewWaveCallback=function(){FiercePlanet.Game.currentProfile.currentWorldSavedThisWave=0,Universe.settings.refreshGraphEveryWave&&FiercePlanet.Graph.refreshGraph(),FiercePlanet.GeneralUI.notify("New wave coming..."),FiercePlanet.Drawing.drawEntryPoints(),FiercePlanet.Drawing.drawExitPoints(),FiercePlanet.Game.eventTarget.fire(new Event("game",this,"newWave",$fp.worldCounter,Lifecycle.currentWorld))},Lifecycle.postNewWaveCallback=function(){},Lifecycle.preCompleteWaveCallback=function(){},Lifecycle.postCompleteWaveCallback=function(){},Lifecycle.preCompleteWorldCallback=function(){FiercePlanet.Game.currentProfile.compileProfileStats(Lifecycle.currentWorld),FiercePlanet.Game._stopAudio(),FiercePlanet.Dialogs.showCompleteWorldDialog()},Lifecycle.postCompleteWorldCallback=function(){},Lifecycle.preCompleteGameCallback=function(){FiercePlanet.Game.currentProfile.compileProfileStats(Lifecycle.currentWorld),FiercePlanet.Game._stopAudio(),FiercePlanet.Dialogs.showCompleteGameDialog()},Lifecycle.postCompleteGameCallback=function(){},Lifecycle.preGameOverCallback=function(){FiercePlanet.Game.currentProfile.revertScore(),FiercePlanet.Game._stopAudio(),FiercePlanet.Dialogs.showGameOverDialog()},Lifecycle.postGameOverCallback=function(){},Lifecycle.preInitialiseGameCallback=function(){},Lifecycle.postInitialiseGameCallback=function(){FiercePlanet.Game.waveOverride>0&&(Lifecycle.currentWorld.waveNumber=FiercePlanet.Game.waveOverride,FiercePlanet.Game.waveOverride=0),FiercePlanet.Game._stopAudio(),FiercePlanet.Game.currentProfile.resetCurrentStats(),FiercePlanet.Graph.refreshGraph(),Lifecycle.resourceRecoveryCycle=Math.pow(Universe.settings.rateOfResourceRecovery,FiercePlanet.Game.levelOfDifficulty-1),Lifecycle.numAgents=Lifecycle.currentWorld.initialAgentNumber,FiercePlanet.Orientation.cellsAcross=Lifecycle.currentWorld.cellsAcross,FiercePlanet.Orientation.cellsDown=Lifecycle.currentWorld.cellsDown,FiercePlanet.Orientation.cellWidth=Math.round(FiercePlanet.Orientation.worldWidth/FiercePlanet.Orientation.cellsAcross),FiercePlanet.Orientation.cellHeight=Math.round(FiercePlanet.Orientation.worldHeight/FiercePlanet.Orientation.cellsDown),FiercePlanet.Orientation.pieceWidth=Math.round(FiercePlanet.Orientation.cellWidth*.5),FiercePlanet.Orientation.pieceHeight=Math.round(FiercePlanet.Orientation.cellHeight*.5),FiercePlanet.Drawing.drawGame()},Lifecycle.preFinaliseGameCallback=function(){},Lifecycle.postFinaliseGameCallback=function(){FiercePlanet.ProfileUI.storeProfileData(),FiercePlanet.Drawing.drawScoreboard()},Lifecycle.postStartAgentsCallback=function(){$("#playAgents").removeClass("pausing"),$("#playAgents").addClass("playing")},Lifecycle.postStopAgentsCallback=function(){$("#playAgents").removeClass("playing"),$("#playAgents").addClass("pausing")}},this._startAudio=function(){Universe.settings.soundsPlayable&&(FiercePlanet.Game.audio!=undefined?FiercePlanet.Game.audio.play():Lifecycle.currentWorld.soundSrc!=undefined&&(FiercePlanet.Game.audio=new Audio(Lifecycle.currentWorld.soundSrc),FiercePlanet.Game.audio.loop=!0,FiercePlanet.Game.audio.addEventListener("ended",function(){FiercePlanet.Game.audio.currentTime=0,FiercePlanet.Game.audio.play()},!1),FiercePlanet.Game.audio.play()))},this._stopAudio=function(){Universe.settings.soundsPlayable&&FiercePlanet.Game.audio!=undefined&&FiercePlanet.Game.audio.pause()},this.playGame=function(){Lifecycle.inPlay?FiercePlanet.Game.pauseGame():(Universe.settings.sendEventsToServer&&FiercePlanet.Comms.notifyServerOfEvent("play",null),FiercePlanet.Game._startAudio(),$("#playAgents").removeClass("pausing"),$("#playAgents").addClass("playing"),Lifecycle.waveCounter==0?Lifecycle.newWave():Lifecycle._startAgents())},this.pauseGame=function(){if(!Lifecycle.inPlay)return;Universe.settings.sendEventsToServer&&FiercePlanet.Comms.notifyServerOfEvent("pause",null),FiercePlanet.Game._stopAudio(),Lifecycle._stopAgents()},this.slowDown=function(){var a=this.cultures||ModuleManager.currentModule.allCultures();for(var b=0,c=a.length;b<c;b++){var d=a[b];d.initialSpeed<1e3&&(d.initialSpeed=Math.floor(d.initialSpeed*2))}var e=Lifecycle.currentWorld.currentAgents;e.forEach(function(a){a.speed<1e3&&(a.countdownToMove=Math.floor(a.countdownToMove*2),a.speed=Math.floor(a.speed*2))})},this.speedUp=function(){var a=this.cultures||ModuleManager.currentModule.allCultures();for(var b=0,c=a.length;b<c;b++){var d=a[b];d.initialSpeed>1&&(d.initialSpeed=Math.floor(d.initialSpeed/2))}var e=Lifecycle.currentWorld.currentAgents;e.forEach(function(a){a.speed>1&&(a.countdownToMove=Math.floor(a.countdownToMove/2),a.speed=Math.floor(a.speed/2))})}}.apply(FiercePlanet.Game);var FiercePlanet=FiercePlanet||{};FiercePlanet.Comms=FiercePlanet.Comms||{},function(){this.duelingAgents=[],this.receiveServerEvent=function(a,b,c){if(b=="world")Universe.settings.spectate&&(Lifecycle.currentWorldNumber=worldNumber,Lifecycle.currentWorldPreset=!0,Lifecycle.newWorld());else if(b=="start")Universe.settings.spectate&&FiercePlanet.Dialogs.newWorldDialog.dialog("close");else if(b=="play")!Universe.settings.spectate;else if(b=="pause")Universe.settings.spectate&&Lifecycle.pauseGame();else if(b=="resources"){var d=c;for(var e=0,f=d.length;e<f;e++)FiercePlanet.Utils.makeFromJSONObject(d[e],Resource.prototype);FiercePlanet.Drawing.drawResources("#alt_resourceCanvas",d)}else if(b=="agents"){var g=c;for(var e=0,f=g.length;e<f;e++)Lifecycle.currentWorld.currentAgents.push(g[e]);Universe.settings.spectate&&(Lifecycle.processAgents(),Lifecycle._stopAgents())}else b=="agent"&&(duelingAgents.push(c),FiercePlanet.Drawing.clearCanvas("#alt_agentCanvas"),FiercePlanet.Drawing.drawAgents("#alt_agentCanvas",duelingAgents),Universe.settings.spectate&&(Lifecycle.processAgents(),Lifecycle._stopAgents()))},this.notifyServerOfEvent=function(a,b){socket.emit("lifecycle event",a,b)},this.esc=function(a){return FiercePlanet.Comms.msg.replace(/</g,"&lt;").replace(/>/g,"&gt;")},this.message=function(a,b){try{jqconsole.zone.chat&&jqconsole.Write(a+": "+b+"\n")}catch(c){}}}.apply(FiercePlanet.Comms);var socket=io.connect();socket.on("connect",function(){var a=FiercePlanet.Game.currentProfile.nickname||"anonymous";socket.emit("nickname",a,function(a){a||FiercePlanet.Comms.message("")})}),socket.on("announcement",function(a){FiercePlanet.Comms.message(a)}),socket.on("nicknames",function(a){FiercePlanet.Comms.message(a)}),socket.on("user message",FiercePlanet.Comms.message),socket.on("reconnect",function(){FiercePlanet.Comms.message("Reconnected to the server")}),socket.on("reconnecting",function(){FiercePlanet.Comms.message("Attempting to re-connect to the server")}),socket.on("error",function(a){FiercePlanet.Comms.message("System",a?a:"A unknown error occurred")}),socket.on("lifecycle event",function(a,b,c){FiercePlanet.Comms.receiveServerEvent(a,b,c)}),Date.prototype.toRelativeTime=function(a){var b=new Date-this;a=parseInt(a,10),isNaN(a)&&(a=0);if(b<=a)return"Just now";var c=null,d={millisecond:1,second:1e3,minute:60,hour:60,day:24,month:30,year:12};for(var e in d){if(b<d[e])break;c=e,b=b/d[e]}return b=Math.floor(b),b!==1&&(c+="s"),[b,c].join(" ")},Date.fromString=function(a){return new Date(Date.parse(a))};
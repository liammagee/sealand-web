(function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s=function(a,b){return function(){return a.apply(b,arguments)}},t=Array.prototype.slice;a=jQuery,p=0,q=1,r=2,j=13,n=9,g=46,f=8,l=37,m=39,o=38,h=40,k=36,i=35,d=">>> ",c="... ",b=2,e=function(){function e(e,f,g,h){this._ProcessMatch=s(this._ProcessMatch,this),this.header=f||"",this.prompt_label_main=g||d,this.prompt_label_continue="\n"+(h||c),this.indent_width=b,this.state=q,this.input_queue=[],this.input_callback=null,this.multiline_callback=null,this.history=[],this.history_index=0,this.history_new="",this.history_active=!1,this.shortcuts={},this.$console=a('<pre class="jqconsole"/>').appendTo(e),this.$input_source=a("<textarea/>"),this.$input_source.css({position:"absolute",left:"-9999px"}),this.$input_source.appendTo(e),this.matchings={openings:{},closings:{},clss:[]},this._InitPrompt(),this._SetupEvents(),this.Write(this.header,"jqconsole-header"),a(e).data("jqconsole",this)}e.prototype.Reset=function(){this.state!==q&&this.ClearPromptText(!0),this.state=q,this.input_queue=[],this.input_callback=null,this.multiline_callback=null,this.history=[],this.history_index=0,this.history_current="",this.shortcuts={},this.matchings={openings:{},closings:{},clss:[]},this.$prompt.detach(),this.$console.html(""),this.$prompt.appendTo(this.$console),this.Write(this.header,"jqconsole-header")},e.prototype._CheckKeyCode=function(a){isNaN(a)?a=a.charCodeAt(0):a=parseInt(a,10);if(!(0<a&&a<256)||isNaN(a))throw new Error("Key code must be a number between 0 and 256 exclusive.");return a},e.prototype._LetterCaseHelper=function(a,b){b(a),65<=a&&a<=90&&b(a+32);if(97<=a&&a<=122)return b(a-32)},e.prototype.RegisterShortcut=function(a,b){var c;a=this._CheckKeyCode(a);if(!b instanceof Function)throw new Error("Callback must be a function, not "+b+".");c=s(function(a){a in this.shortcuts||(this.shortcuts[a]=[]);return this.shortcuts[a].push(b)},this),this._LetterCaseHelper(a,c)},e.prototype.UnRegisterShortcut=function(a,b){var c;a=this._CheckKeyCode(a),c=s(function(a){if(a in this.shortcuts)return b?this.shortcuts[a].splice(this.shortcuts[a].indexOf(b),1):delete this.shortcuts[a]},this),this._LetterCaseHelper(a,c)},e.prototype.GetColumn=function(){var a;this.$prompt_cursor.text(""),a=this.$console.text().split("\n"),this.$prompt_cursor.text(" ");return a[a.length-1].length},e.prototype.GetLine=function(){return this.$console.text().split("\n").length-1},e.prototype.ClearPromptText=function(a){if(this.state===q)throw new Error("ClearPromptText() is not allowed in output state.");this.$prompt_before.html(""),this.$prompt_after.html(""),this.$prompt_label.text(a?"":this._SelectPromptLabel(!1)),this.$prompt_left.text(""),this.$prompt_right.text("")},e.prototype.GetPromptText=function(b){var c,d,e,f,g;if(this.state===q)throw new Error("GetPromptText() is not allowed in output state.");if(b){this.$prompt_cursor.text(""),g=this.$prompt.text(),this.$prompt_cursor.text(" ");return g}f=function(b){var c;c=[],b.children().each(function(){return c.push(a(this).children().last().text())});return c.join("\n")},d=f(this.$prompt_before),d&&(d+="\n"),e=this.$prompt_left.text()+this.$prompt_right.text(),c=f(this.$prompt_after),c&&(c="\n"+c);return d+e+c},e.prototype.SetPromptText=function(a){if(this.state===q)throw new Error("SetPromptText() is not allowed in output state.");this.ClearPromptText(!1),this._AppendPromptText(a),this._ScrollToEnd()},e.prototype.Write=function(b,c){var d;d=a("<span>").text(b),c!=null&&d.addClass(c),d.insertBefore(this.$prompt),this._ScrollToEnd(),this.$prompt_cursor.detach().insertAfter(this.$prompt_left)},e.prototype.Input=function(a){this.state!==q?this.input_queue.push(s(function(){return this.Input(a)},this)):(this.history_active=!1,this.input_callback=a,this.multiline_callback=null,this.state=p,this.$prompt.attr("class","jqconsole-input"),this.$prompt_label.text(this._SelectPromptLabel(!1)),this.Focus(),this._ScrollToEnd())},e.prototype.Prompt=function(a,b,c){this.state!==q?this.input_queue.push(s(function(){return this.Prompt(a,b,c)},this)):(this.history_active=a,this.input_callback=b,this.multiline_callback=c,this.state=r,this.$prompt.attr("class","jqconsole-prompt"),this.$prompt_label.text(this._SelectPromptLabel(!1)),this.Focus(),this._ScrollToEnd())},e.prototype.AbortPrompt=function(){if(this.state!==r)throw new Error("Cannot abort prompt when not in prompt state.");this.Write(this.GetPromptText(!0)+"\n","jqconsole-old-prompt"),this.ClearPromptText(!0),this.state=q,this.input_callback=this.multiline_callback=null,this._CheckInputQueue()},e.prototype.Focus=function(){this.$input_source.focus()},e.prototype.SetIndentWidth=function(a){return this.indent_width=a},e.prototype.GetIndentWidth=function(){return this.indent_width},e.prototype.RegisterMatching=function(a,b,c){var d;d={opening_char:a,closing_char:b,cls:c},this.matchings.clss.push(c),this.matchings.openings[a]=d;return this.matchings.closings[b]=d},e.prototype.UnRegisterMatching=function(a,b){var c;c=this.matchings.openings[a].cls,delete this.matchings.openings[a],delete this.matchings.closings[b];return this.matchings.clss.splice(this.matchings.clss.indexOf(c),1)},e.prototype._CheckInputQueue=function(){if(this.input_queue.length)return this.input_queue.shift()()},e.prototype._InitPrompt=function(){this.$prompt=a('<span class="jqconsole-input"/>').appendTo(this.$console),this.$prompt_before=a("<span/>").appendTo(this.$prompt),this.$prompt_current=a("<span/>").appendTo(this.$prompt),this.$prompt_after=a("<span/>").appendTo(this.$prompt),this.$prompt_label=a("<span/>").appendTo(this.$prompt_current),this.$prompt_left=a("<span/>").appendTo(this.$prompt_current),this.$prompt_right=a("<span/>").appendTo(this.$prompt_current),this.$prompt_right.css({position:"relative"}),this.$prompt_cursor=a('<span class="jqconsole-cursor"> </span>'),this.$prompt_cursor.insertBefore(this.$prompt_right);return this.$prompt_cursor.css({color:"transparent",display:"inline",position:"absolute",zIndex:0})},e.prototype._SetupEvents=function(){var b,c;this.$console.click(s(function(){var a;a=s(function(){var a;a=function(){var a;if(window.getSelection)return window.getSelection().toString();if(((a=document.selection)!=null?a.type:void 0)==="Text")return document.selection.createRange().text};if(a()==="")return this.Focus()},this);return setTimeout(a,0)},this)),this.$input_source.focus(s(function(){return this.$console.removeClass("jqconsole-blurred")},this)),this.$input_source.blur(s(function(){return this.$console.addClass("jqconsole-blurred")},this)),c=a.browser.opera?"input":"paste",this.$input_source.bind(c,s(function(){var a;a=s(function(){this._AppendPromptText(this.$input_source.val()),this.$input_source.val("");return this.Focus()},this);return setTimeout(a,0)},this)),this.$input_source.keypress(s(function(a){return this._HandleChar(a)},this)),b=a.browser.mozilla?"keypress":"keydown";return this.$input_source[b](s(function(a){return this._HandleKey(a)},this))},e.prototype._HandleChar=function(b){var c;if(this.state===q)return!0;c=b.which;if(c===13||c===9)return!1;if(a.browser.mozilla)if(b.keyCode||b.metaKey||b.ctrlKey||b.altKey)return!0;if(a.browser.opera)if(b.keyCode||b.which||b.metaKey||b.ctrlKey||b.altKey)return!0;if(b.metaKey||b.ctrlKey||b.altKey)return!1;this.$prompt_left.text(this.$prompt_left.text()+String.fromCharCode(c)),this._ScrollToEnd();return!1},e.prototype._HandleKey=function(b){var c;if(this.state===q)return!0;c=b.keyCode||b.which,setTimeout(a.proxy(this._CheckMatchings,this),0);if(b.altKey||b.metaKey&&!b.ctrlKey)return!0;if(b.ctrlKey)return this._HandleCtrlShortcut(c);if(b.shiftKey){switch(c){case j:this._HandleEnter(!0);break;case n:this._Unindent();break;case o:this._MoveUp();break;case h:this._MoveDown();break;default:return!0}return!1}switch(c){case j:this._HandleEnter(!1);break;case n:this._Indent();break;case g:this._Delete(!1);break;case f:this._Backspace(!1);break;case l:this._MoveLeft(!1);break;case m:this._MoveRight(!1);break;case o:this._HistoryPrevious();break;case h:this._HistoryNext();break;case k:this._MoveToStart(!1);break;case i:this._MoveToEnd(!1);break;default:return!0}return!1},e.prototype._HandleCtrlShortcut=function(a){var b,c,d,e;switch(a){case g:this._Delete(!0);break;case f:this._Backspace(!0);break;case l:this._MoveLeft(!0);break;case m:this._MoveRight(!0);break;case o:this._MoveUp();break;case h:this._MoveDown();break;case i:this._MoveToEnd(!0);break;case k:this._MoveToStart(!0);break;default:if(a in this.shortcuts){e=this.shortcuts[a];for(c=0,d=e.length;c<d;c++)b=e[c],b.call(this);return!1}return!0}return!1},e.prototype._HandleEnter=function(a){var b,c,d,e,f,g,h;if(a)return this._InsertNewLine(!0);e=this.GetPromptText(),d=this.multiline_callback?this.multiline_callback(e):!1;if(d!==!1){this._MoveToEnd(!0),this._InsertNewLine(!0),h=[];for(f=0,g=Math.abs(d);0<=g?f<g:f>g;0<=g?f++:f--)h.push(d>0?this._Indent():this._Unindent());return h}c=this.state===p?"input":"prompt",this.Write(this.GetPromptText(!0)+"\n","jqconsole-old-"+c),this.ClearPromptText(!0),this.history_active&&((!this.history.length||this.history[this.history.length-1]!==e)&&this.history.push(e),this.history_index=this.history.length),this.state=q,b=this.input_callback,this.input_callback=null,b&&b(e);return this._CheckInputQueue()},e.prototype._GetDirectionals=function(b){var c,d,e,f,g,h,i,j;f=b?this.$prompt_left:this.$prompt_right,c=b?this.$prompt_right:this.$prompt_left,e=b?this.$prompt_before:this.$prompt_after,d=b?this.$prompt_after:this.$prompt_before,h=b?a.proxy(this._MoveToStart,this):a.proxy(this._MoveToEnd,this),g=b?a.proxy(this._MoveLeft,this):a.proxy(this._MoveRight,this),j=b?"last":"first",i=b?"prependTo":"appendTo";return{$prompt_which:f,$prompt_opposite:c,$prompt_relative:e,$prompt_rel_opposite:d,MoveToLimit:h,MoveDirection:g,which_end:j,where_append:i}},e.prototype._VerticalMove=function(a){var b,c,d,e,f,g,h,i;i=this._GetDirectionals(a),d=i.$prompt_which,b=i.$prompt_opposite,c=i.$prompt_relative,f=i.MoveToLimit,e=i.MoveDirection;if(!c.is(":empty")){g=this.$prompt_left.text().length,f(),e(),h=d.text(),b.text(a?h.slice(g):h.slice(0,g));return d.text(a?h.slice(0,g):h.slice(g))}},e.prototype._MoveUp=function(){return this._VerticalMove(!0)},e.prototype._MoveDown=function(){return this._VerticalMove()},e.prototype._HorizontalMove=function(b,c){var d,e,f,g,h,i,j,k,l,m,n,o,p,q;q=this._GetDirectionals(c),h=q.$prompt_which,e=q.$prompt_opposite,g=q.$prompt_relative,f=q.$prompt_rel_opposite,o=q.which_end,n=q.where_append,k=c?/\w*\W*$/:/^\w*\W*/,l=h.text();if(l){if(b){p=l.match(k);if(!p)return;p=p[0],m=e.text(),e.text(c?p+m:m+p),j=p.length;return h.text(c?l.slice(0,-j):l.slice(j))}m=e.text(),e.text(c?l.slice(-1)+m:m+l[0]);return h.text(c?l.slice(0,-1):l.slice(1))}if(!g.is(":empty")){i=a("<span/>")[n](f),i.append(a("<span/>").text(this.$prompt_label.text())),i.append(a("<span/>").text(e.text())),d=g.children()[o]().detach(),this.$prompt_label.text(d.children().first().text()),h.text(d.children().last().text());return e.text("")}},e.prototype._MoveLeft=function(a){return this._HorizontalMove(a,!0)},e.prototype._MoveRight=function(a){return this._HorizontalMove(a)},e.prototype._MoveTo=function(a,b){var c,d,e,f,g,h,i;h=this._GetDirectionals(b),e=h.$prompt_which,c=h.$prompt_opposite,d=h.$prompt_relative,g=h.MoveToLimit,f=h.MoveDirection;if(a){i=[];while(!d.is(":empty")||e.text()!=="")g(!1),i.push(f(!1));return i}c.text(this.$prompt_left.text()+this.$prompt_right.text());return e.text("")},e.prototype._MoveToStart=function(a){return this._MoveTo(a,!0)},e.prototype._MoveToEnd=function(a){return this._MoveTo(a,!1)},e.prototype._Delete=function(a){var b,c,d;c=this.$prompt_right.text();if(c){if(a){d=c.match(/^\w*\W*/);if(!d)return;d=d[0];return this.$prompt_right.text(c.slice(d.length))}return this.$prompt_right.text(c.slice(1))}if(!this.$prompt_after.is(":empty")){b=this.$prompt_after.children().first().detach();return this.$prompt_right.text(b.children().last().text())}},e.prototype._Backspace=function(a){var b,c,d;c=this.$prompt_left.text();if(c){if(a){d=c.match(/\w*\W*$/);if(!d)return;d=d[0];return this.$prompt_left.text(c.slice(0,-d.length))}return this.$prompt_left.text(c.slice(0,-1))}if(!this.$prompt_before.is(":empty")){b=this.$prompt_before.children().last().detach(),this.$prompt_label.text(b.children().first().text());return this.$prompt_left.text(b.children().last().text())}},e.prototype._Indent=function(){var a;return this.$prompt_left.prepend(function(){var b,c;c=[];for(a=1,b=this.indent_width;1<=b?a<=b:a>=b;1<=b?a++:a--)c.push(" ");return c}.call(this).join(""))},e.prototype._Unindent=function(){var a,b,c,d;a=this.$prompt_left.text()+this.$prompt_right.text(),d=[];for(b=1,c=this.indent_width;1<=c?b<=c:b>=c;1<=c?b++:b--){if(!/^ /.test(a))break;this.$prompt_left.text()?this.$prompt_left.text(this.$prompt_left.text().slice(1)):this.$prompt_right.text(this.$prompt_right.text().slice(1)),d.push(a=a.slice(1))}return d},e.prototype._InsertNewLine=function(b){var c,d,e;b==null&&(b=!1),e=this._SelectPromptLabel(!this.$prompt_before.is(":empty")),c=a("<span/>").appendTo(this.$prompt_before),c.append(a("<span/>").text(e)),c.append(a("<span/>").text(this.$prompt_left.text())),this.$prompt_label.text(this._SelectPromptLabel(!0)),b&&(d=this.$prompt_left.text().match(/^\s+/))?this.$prompt_left.text(d[0]):this.$prompt_left.text("");return this._ScrollToEnd()},e.prototype._AppendPromptText=function(a){var b,c,d,e,f,g;c=a.split("\n"),this.$prompt_left.text(this.$prompt_left.text()+c[0]),f=c.slice(1),g=[];for(d=0,e=f.length;d<e;d++)b=f[d],this._InsertNewLine(),g.push(this.$prompt_left.text(b));return g},e.prototype._ScrollToEnd=function(){return this.$console.scrollTop(this.$console[0].scrollHeight)},e.prototype._SelectPromptLabel=function(a){return this.state===r?a?this.prompt_label_continue:this.prompt_label_main:a?"\n ":" "},e.prototype._outerHTML=function(b){return document.body.outerHTML?b.get(0).outerHTML:a("<div/>").append(b.eq(0).clone()).html()},e.prototype._Wrap=function(b,c,d){var e,f,g;f=0,g=a.map(b.contents(),s(function(b,c){var d;if(b.nodeType!==3){d=this._outerHTML(a(b)),f+=d.length-1;return d}return b.textContent},this)),g=g.join(""),c!==0&&(c+=f),e=g.slice(0,c)+('<span class="'+d+'">'+g[c]+"</span>")+g.slice(c+1);return b.html(e)},e.prototype._WalkCharacters=function(a,b,c,d,e){var f,g,h;g=e?a.length:0,a=a.split(""),h=function(){var b,c,d,f;e?(d=a,a=2<=d.length?t.call(d,0,c=d.length-1):(c=0,[]),b=d[c++]):(f=a,b=f[0],a=2<=f.length?t.call(f,1):[]),b&&(g=g+(e?-1:1));return b};while(f=h()){f===b?d++:f===c&&d--;if(d===0)return{index:g,current_count:d}}return{index:-1,current_count:d}},e.prototype._ProcessMatch=function(b,c,d){var e,f,g,h,i,j,k,l,m,n,o,p;n=c?[b.closing_char,b.opening_char]:[b.opening_char,b.closing_char],h=n[0],l=n[1],o=this._GetDirectionals(c),g=o.$prompt_which,f=o.$prompt_relative,i=1,j=!1,m=g.text(),c||(m=m.slice(1)),d&&c&&(m=m.slice(0,-1)),p=this._WalkCharacters(m,h,l,i,c),k=p.index,i=p.current_count,k>-1?(this._Wrap(g,k,b.cls),j=!0):(e=f.children(),e=c?Array.prototype.reverse.call(e):e,e.each(s(function(d,e){var f,g;f=a(e).children().last(),m=f.text(),g=this._WalkCharacters(m,h,l,i,c),k=g.index,i=g.current_count;if(k>-1){c||k--,this._Wrap(f,k,b.cls),j=!0;return!1}},this)));return j},e.prototype._CheckMatchings=function(b){var c,d,e,f,g,h,i;e=b?this.$prompt_left.text().slice(this.$prompt_left.text().length-1):this.$prompt_right.text()[0],i=this.matchings.clss;for(g=0,h=i.length;g<h;g++)c=i[g],a("."+c,this.$console).contents().unwrap();(d=this.matchings.closings[e])?f=this._ProcessMatch(d,!0,b):(d=this.matchings.openings[e])?f=this._ProcessMatch(d,!1,b):b||this._CheckMatchings(!0);if(b){if(f)return this._Wrap(this.$prompt_left,this.$prompt_left.text().length-1,d.cls)}else if(f)return this._Wrap(this.$prompt_right,0,d.cls)},e.prototype._HistoryPrevious=function(){if(!!this.history_active){if(this.history_index<=0)return;this.history_index===this.history.length&&(this.history_new=this.GetPromptText());return this.SetPromptText(this.history[--this.history_index])}},e.prototype._HistoryNext=function(){if(!!this.history_active){if(this.history_index>=this.history.length)return;if(this.history_index===this.history.length-1){this.history_index++;return this.SetPromptText(this.history_new)}return this.SetPromptText(this.history[++this.history_index])}};return e}(),a.fn.jqconsole=function(a,b,c){return new e(this,a,b,c)}}).call(this)